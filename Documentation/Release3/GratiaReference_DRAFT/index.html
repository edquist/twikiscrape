<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> GratiaReference_DRAFT &lt; Documentation/Release3 &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Documentation/Release3/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Documentation/Release3/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Documentation/Release3/GratiaReference_DRAFT?_T=16 Feb 2017" type="application/x-wiki" title="edit GratiaReference_DRAFT" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Documentation/Release3/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Documentation/Release3/GratiaReference_DRAFT"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#FFFFFF;
	}
	.patternBookView {
		border-color:#FFFFFF;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Gratia_Accounting_Reference"></a> Gratia Accounting Reference </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Gratia_Accounting_Reference"> Gratia Accounting Reference</a> <ul>
<li> <a href="?cover=print#About_This_Guide"> About This Guide</a>
</li> <li> <a href="?cover=print#Cron"> Cron</a>
</li> <li> <a href="?cover=print#Files_and_Directories"> Files and Directories</a>
</li> <li> <a href="?cover=print#ProbeConfig"> ProbeConfig</a>
</li> <li> <a href="?cover=print#Identity_Information"> Identity Information</a>
</li> <li> <a href="?cover=print#How_the_identity_information_is"> How the identity information is determined</a>
</li> <li> <a href="?cover=print#Reference"> Reference</a>
</li></ul> 
</li></ul> 
</div>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="About_This_Guide"></a> About This Guide </span></h2>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Cron"></a> Cron </span></h2>
Probes are periodically run as cron jobs, but different probes will run at different intervals. The cron jobs will always run and you should not remove them. You can find them in <code>/etc/cron.d</code>.
<p />
However, the cron jobs will only do anything if you have enabled them. You enable them via an init script. For example, to enable them:
<p />
<pre class="rootscreen">
[root@client ~]$ service gratia-probes-cron start
Enabling gratia probes cron:                               [  <font color="#008000">OK</font>  ]
</pre>
<p />
To disable them:
<pre class="rootscreen">
[root@client ~]$ service gratia-probes-cron stop
Disabling gratia probes cron:                               [  <font color="#008000">OK</font>  ]
</pre>
<p />
You also need to enable individual probes, usually via <code>osg-configure</code>. See below for more information on that.
<p />
<a name="FilesAndDirs"></a>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Files_and_Directories"></a> Files and Directories </span></h2>
<p />
The following list contains the locations of Gratia's configuration, log, and data files:
<p />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table1" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/GratiaReference_DRAFT?cover=print;sortcol=0;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">File</font></a> </th>
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol1 twikiLastCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/GratiaReference_DRAFT?cover=print;sortcol=1;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Purpose</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> <code>/etc/gratia/<font color="#ff0000">PROBE-NAME</font>/ProbeConfig</code> </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> Configuration for Gratia probes, one per probe type </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> <code>/var/log/gratia/<font color="#ff0000">YYYY-MM-DD.log</code> </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol"> Log file that records information about processing and uploading of Gratia accounting data </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> <code>/var/log/gratia/gridftpTransfer.log</code> </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> Log file specific to the Gratia GridFTP probe </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> <code>/var/lib/gratia/data</code> </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol"> Location for job data before being processed by Gratia </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> <code>/var/lib/gratia/tmp/gratiafiles</code> </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> Location for temporary Gratia data as it is being processed (usually empty). </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="ProbeConfig"></a> ProbeConfig </span></h2>
<p />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table2" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/GratiaReference_DRAFT?cover=print;sortcol=0;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Attribute</font></a> </th>
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol1"> <a rel="nofollow" href="/bin/view/Documentation/Release3/GratiaReference_DRAFT?cover=print;sortcol=1;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Description</font></a> </th>
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol2 twikiLastCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/GratiaReference_DRAFT?cover=print;sortcol=2;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Default</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> SuppressNoDNRecords </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1"> discard records without a DN (in the final record DNs in certinfo file are OK) </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol"> 0 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> SuppressGridLocalRecords </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1"> discard records from local users (users not coming via a Grid submission, e.g. GRAM or HTCondor-CE) </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol2 twikiLastCol"> 0 (1 for <code>gratia-probe</code> &lt; <code>1.13.30</code>) </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> SuppressUnknownVORecords </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1"> discard records that have no VO </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol"> 0 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> QuarantineUnknownVORecords </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1"> quarantine records that have no VO </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol2 twikiLastCol"> 0 </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> MapUnknownToGroup </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1"> use the local user group (UNIX group name) as VO for records that have no VO otherwise established </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol"> 0 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> MapGroupToRole </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1"> add to the record DN "/LocalGroup=GROUP_NAME" using the local user group </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol2 twikiLastCol"> 0 </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> VOOverride </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLast"> map all records to the specified VO (ignoring all other mappings) </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol twikiLast"> NULL (no override) </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Identity_Information"></a> Identity Information </span></h2>
Job usage records collect the following information: <ul>
<li> Local user - local (e.g. UNIX) user name
</li> <li> Local Group - local (e.g. UNIX) group name
</li> <li> Global user name 
</li> <li> VO name - Name of the virtual organization, as retrieved, e.g. FQDN string or "voi" string from <code>users-vo-mapfile</code>
</li> <li> Reportable VO name - Extracted name of the VO, e.g. the first name in the FQDN or "VOc" string from <code>users-vo-mapfile</code>
</li> <li> Common name (or Distinguished name, DN) - FQDN as present in the user certificate used for the job or as reconstructed form the VO
</li></ul> 
<p />
This information is retrieved via a series of functions, sometimes specific to a probe (e.g. the HTCondor probe), sometimes common to all probes (in <code>gratia-common</code>).
The mapping is affected by some configuration variables that affect which records are reported to Gratia, which are quarantined (stored in a directory for possible later processing) and which are discarded (without being reported to Gratia). These variables are (0, 1 correspond to false, true): <ul>
<li> SuppressNoDNRecords - discard records without a DN (in the final record - DNs in certinfo file are OK) [default: 0]
</li> <li> SuppressGridLocalRecords - discard records from local users (users not coming via a Grid submission, e.g. GRAM or HTCondor-CE) [defaults: 0, was 1 for rel.&lt;1.13.30]
</li> <li> SuppressUnknownVORecords - discard records that have no VO [default: 0]
</li> <li> QuarantineUnknownVORecords - quarantine records that have no VO [default: 0]
</li> <li> MapUnknownToGroup - use the local user group (UNIX group name) as VO for records that have no VO otherwise established [default: 0]
</li> <li> MapGroupToRole - add to the record DN "/LocalGroup=GROUP_NAME" using the local user group [default: 0]
</li> <li> VOOverride - map all records to the specified VO (ignoring all other mappings) [default: NULL, no override]
</li></ul> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="How_the_identity_information_is"></a> How the identity information is determined </span></h2>
<p />
The main information used to attribute resources used or provided is the VO, available in 2 record entries: VOName (can be a complex string indicating the VO affiliation, Similar to the VO extension of a FQDN), and ReportableVOName (contains only the VO name, as one of the names in OIM).
The keyword "Unknown" (case insensitive) is not a valid VO name.
<p />
If VOOverride in the probe configuration file is set to some value, then both VOName and ReportableVOName will be set to that value in all records reported.
<p />
Some probes can extract this information from the job record. E.g. the HTCondor probe (condor_meter) uses the classads x509UserProxyFirstFQAN and x509UserProxyVOName respectively for the VOName and ReportableVOName.
<p />
A Gratia extension of the job managers (in <code>globus-gram-job-manager-scripts</code> and <code>gratia-probe-gram</code>) generates files mapping the jobs (job IDs) to the user credentials. These files are called certinfo files, are saved in the Gratia data direcotry (<code>/var/lib/gratia/data</code>) and contain a vo_info record where the DN of the x509 certificate used to submit the job is mapped to a VO. This information is used if the initial VOName is not available or not a valid VO name.
<p />
If also the certinfo file is not providing a valid VOName then the JobIdentity record from from the HTCondor_CE is attempted. 
<p />
If also that one is not available (e.g. you are not on a HTCondor_CE), then the <code>user-vo-mapfile</code> is used.
This file contains lines mapping local (UNIX) users to VO names (VOName) and lines defining valid VO names (voi) and the corresponding ReportableVOName (VOC).
<p />
If everything else fails and MapUnknownToGroup is set in the configuration file, then the local user group name is used as VO name and ReportableVOName. 
<p />
If MapGroupToRole is set and there is not already a valid FQDN associated with the job record, then the VOName is modified assigning a Local group part like: <code><b>"%s/LocalGroup=%s" % (vo_name, local_group_name)</b></code>
<p />
<a name="ReferenceSection"></a>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Reference"></a> Reference </span></h2>
<p /> <ul>
<li> <a href="/bin/view/Documentation/Release3/GratiaIntroduction_DRAFT" class="twikiLink">Gratia Probe Introduction</a>
</li> <li> <a href="/bin/view/Documentation/Release3/InstallGratia_DRAFT" class="twikiLink">Installing and Maintaining Gratia Probes</a>
</li> <li> <a href="/bin/view/Documentation/Release3/TroubleshootingGratia_DRAFT" class="twikiLink">Troubleshooting Gratia Probes</a>
</li> <li> <a href="/bin/view/Accounting/GratiaProbes" class="twikiLink">List of all Gratia probes</a>, their purpose and developers
</li> <li> <a href="http://gratia.sourceforge.net/dev/" target="_top">API documentation of Gratia probes (pydoc style)</a>
</li> <li> <a href="/bin/view/Accounting/ReportsDescription" class="twikiLink">Content of the Email reports</a>
</li> <li> <a href="/bin/view/Accounting/GratiaDataCollectionNotes" class="twikiLink">Notes about job probes</a>
</li></ul> </div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Documentation/Release3<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>GratiaReference_DRAFT</span> <br />    
Topic revision: r4 - 28 Nov 2016 - 23:00:08 - <a href="/bin/view/Main/BrianLin" class="twikiLink">BrianLin</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />