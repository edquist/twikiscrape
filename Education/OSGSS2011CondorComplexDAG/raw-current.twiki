---+ A More Complex DAG

&lt;div style=&quot;margin-left: 1em; margin-right: 1em; border: 1px solid black; padding: 0.5em;&quot;&gt;
---+++ Objective of this exercise
The objective of this exercise is to run a real set of jobs with DAGMan.
&lt;/div&gt;

---++ Make your job submission files

We&#39;ll run our =goatbrot= example. If you didn&#39;t read about it yet, [[OSGSS2011Mandlebrot][please do so now]]. We are going to make a DAG with four simultaneous jobs (the =goatbrot=s) and one final node to stitch them together. This means we have five jobs. We&#39;re going to run =goatbrot= with more iterations (100,000) so it will take longer to run. 

You can create your five jobs. The goatbrot jobs very similar to each other, but they have slightly different parameters and output files. 

---+++ goatbrot1.sub

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
executable              = /opt/goatbrot/goatbrot
arguments               = -i 100000 -c -0.75,0.75 -w 1.5 -s 500,500 -o tile_0_0.ppm
log                     = goatbrot.log
output                  = goatbrot.out.0.0
error                   = goatbrot.err.0.0
should_transfer_files   = YES
when_to_transfer_output = ONEXIT
queue
&lt;/pre&gt;

---+++ goatbrot2.sub

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
executable              = /opt/goatbrot/goatbrot
arguments               = -i 100000 -c 0.75,0.75 -w 1.5 -s 500,500 -o tile_0_1.ppm
log                     = goatbrot.log
output                  = goatbrot.out.0.1
error                   = goatbrot.err.0.1
should_transfer_files   = YES
when_to_transfer_output = ONEXIT
queue
&lt;/pre&gt;

---+++ goatbrot3.sub

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
executable              = /opt/goatbrot/goatbrot
arguments               = -i 100000 -c -0.75,-0.75 -w 1.5 -s 500,500 -o tile_1_0.ppm
log                     = goatbrot.log
output                  = goatbrot.out.1.0
error                   = goatbrot.err.1.0
should_transfer_files   = YES
when_to_transfer_output = ONEXIT
queue
&lt;/pre&gt;

---+++ goatbrot4.sub

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
executable              = /opt/goatbrot/goatbrot
arguments               = -i 100000 -c 0.75,-0.75 -w 1.5 -s 500,500 -o tile_1_1.ppm
log                     = goatbrot.log
output                  = goatbrot.out.1.1
error                   = goatbrot.err.1.1
should_transfer_files   = YES
when_to_transfer_output = ONEXIT
queue
&lt;/pre&gt;

---+++ montage.sub

You should notice a few things about the montage submission file:

   1. The =transfer_input_files= statement refers to the files created by the other jobs. 
   1. We do *not* transfer the montage program because it is pre-installed on the Condor pool. How do we avoid transferring it, and how do we specify where it is installed?

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
universe                = vanilla
executable              = /usr/bin/montage
arguments               = tile_0_0.ppm tile_0_1.ppm tile_1_0.ppm tile_1_1.ppm -mode Concatenate -tile 2x2 mandle.jpg
should_transfer_files   = YES
when_to_transfer_output = ONEXIT
transfer_input_files    = tile_0_0.ppm,tile_0_1.ppm,tile_1_0.ppm,tile_1_1.ppm
transfer_executable     = false
output                  = montage.out
error                   = montage.err
log                     = montage.log
queue
&lt;/pre&gt;

---++ Make your DAG

In a file called =goatbrot.dag=, you have your DAG specification:

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
JOB g1 goatbrot1.sub
JOB g2 goatbrot2.sub
JOB g3 goatbrot3.sub
JOB g4 goatbrot4.sub
JOB montage montage.sub
PARENT g1 g2 g3 g4 CHILD montage
&lt;/pre&gt;

Ask yourself: do you know how we ensure that all the =goatbrot= commands can run simultaneously and all of them will complete before we run the montage job?

---++ Running the DAG

Submit your DAG:

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
% condor_submit_dag goatbrot.dag
-----------------------------------------------------------------------
File for submitting this DAG to Condor           : goatbrot.dag.condor.sub
Log of DAGMan debugging messages                 : goatbrot.dag.dagman.out
Log of Condor library output                     : goatbrot.dag.lib.out
Log of Condor library error messages             : goatbrot.dag.lib.err
Log of the life of condor_dagman itself          : goatbrot.dag.dagman.log

Submitting job(s).
1 job(s) submitted to cluster 126182.
-----------------------------------------------------------------------
&lt;/pre&gt;

---++ Watch your DAG

Watch with condor_q:

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
% watch -n 10 condor_q -sub %RED%YOUR-USER-NAME%ENDCOLOR%

%RED%Here we see DAGMan running:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:00:09 R  0   4.9  condor_dagman     

1 jobs; 0 idle, 1 running, 0 held


%RED%DAGMan has submitted the goatbrot jobs, but they haven&#39;t started running yet:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:00:15 R  0   4.9  condor_dagman     
126183.0   roy             6/21 18:51   0+00:00:00 I  0   0.0  goatbrot -i 100000
126184.0   roy             6/21 18:51   0+00:00:00 I  0   0.0  goatbrot -i 100000
126185.0   roy             6/21 18:51   0+00:00:00 I  0   0.0  goatbrot -i 100000
126186.0   roy             6/21 18:51   0+00:00:00 I  0   0.0  goatbrot -i 100000

5 jobs; 4 idle, 1 running, 0 held

%RED%They&#39;re running!%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:00:46 R  0   4.9  condor_dagman     
126183.0   roy             6/21 18:51   0+00:00:25 R  0   0.0  goatbrot -i 100000
126184.0   roy             6/21 18:51   0+00:00:25 R  0   0.0  goatbrot -i 100000
126185.0   roy             6/21 18:51   0+00:00:25 R  0   0.0  goatbrot -i 100000
126186.0   roy             6/21 18:51   0+00:00:25 R  0   0.0  goatbrot -i 100000

5 jobs; 0 idle, 5 running, 0 held

%RED%Two of the jobs have finished, while the others are still running:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:01:22 R  0   4.9  condor_dagman     
126183.0   roy             6/21 18:51   0+00:01:01 R  0   0.0  goatbrot -i 100000
126185.0   roy             6/21 18:51   0+00:01:01 R  0   0.0  goatbrot -i 100000

3 jobs; 0 idle, 3 running, 0 held

%RED%They finished, but DAGMan hasn&#39;t noticed yet. It only checks periodically:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:02:48 R  0   4.9  condor_dagman     

1 jobs; 0 idle, 1 running, 0 held

%RED%DAGMan has now submitted the montage job. It ran so fast I didn&#39;t capture it running:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:02:56 R  0   4.9  condor_dagman     
126189.0   roy             6/21 18:54   0+00:00:00 I  0   0.0  montage tile_0_0.p

2 jobs; 1 idle, 1 running, 0 held

%RED%The montage job has finished, and DAGMan will finish up soon:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
126182.0   roy             6/21 18:51   0+00:03:14 R  0   4.9  condor_dagman     

1 jobs; 0 idle, 1 running, 0 held

%RED%Now it&#39;s all done:%ENDCOLOR%
-- Submitter: vdt-itb.cs.wisc.edu : &lt;198.51.254.90:52713&gt; : vdt-itb.cs.wisc.edu
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               

0 jobs; 0 idle, 0 running, 0 held
&lt;/pre&gt;

Examine your results. For some reason, goatbrot prints everything to stderr, not stdout. 

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
% cat goatbrot.err.0.0
Complex image:
            Center: -0.75 + 0.75i
             Width: 1.5
            Height: 1.5
        Upper Left: -1.5 + 1.5i
       Lower Right: 0 + 0i

Output image:
          Filename: tile_0_0.ppm
     Width, Height: 500, 500
             Theme: beej
       Antialiased: no

Mandelbrot:
    Max Iterations: 100000
        Continuous: no

Goatbrot:
    Multithreading: not supported in this build

Completed: 100.0%  
&lt;/pre&gt;

Examine your log files (=goatbrot.log= and =montage.log=) and DAGMan output file (=goatbrot.dag.dagman.out=). Do they look as you expect? Can you see the progress of the DAG in the DAGMan output file?

Clean up your results. Be careful about deleting the goatbrot.dag.* files, you do not want to delete the goatbrot.dag file, just goatbrot.dag.* . 

&lt;pre style=&quot;margin-left:4em&quot; class=&quot;screen&quot;&gt;
% rm goatbrot.dag.*
% rm goatbrot.out.*
% rm goatbrot.err.*
&lt;/pre&gt;

---++ On your own.

   * Re-run your DAG. When jobs are running, try =condor_q -dag=. What does it do differently?
   * Challenge, if you have time: Make a bigger DAG by making more tiles in the same area. 

