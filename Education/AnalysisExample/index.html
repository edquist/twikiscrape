<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> AnalysisExample &lt; Education &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Education/AnalysisExample?_T=16 Feb 2017" type="application/x-wiki" title="edit AnalysisExample" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Education/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Education/AnalysisExample"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">

@import url('/pub/Documentation/Tools/exercises.css ');

</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Analysis_Example_using_the_Grid"></a> Analysis Example using the Grid </h1>
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Introduction"> Introduction</a>
</li> <li> <a href="?cover=print#Customize_this_Document"> Customize this Document</a>
</li> <li> <a href="?cover=print#Exercises"> Exercises </a> <ul>
<li> <a href="?cover=print#Prerequisite"> Prerequisite </a>
</li> <li> <a href="?cover=print#Simple_Analysis_Example"> Simple Analysis Example</a> <ul>
<li> <a href="?cover=print#Step_1_Create_simulated_data_usi"> Step 1: Create simulated data using the grid</a>
</li> <li> <a href="?cover=print#Step_2_Make_TSelector"> Step 2: Make TSelector</a>
</li></ul> 
</li></ul> 
</li></ul> 
</div>
<p />
<h1><a name="Introduction"></a> Introduction </h1>
Root may be run in batch mode on the grid to analyze large data samples. This example creates simulated data in root format using tree's and performs analysis on the simulated data by means of processing on the grid. This example is based on a demo developed by OU programmer Chris Walker.
<p />
<h1><a name="Customize_this_Document"></a> Customize this Document </h1>
<p />
<!-- OSG Summer School 2011 Defaults <ul>
<li> Local VO= osgedu
</li> <li> Local UCL_HOST = osg-ss-glidein
</li> <li> Local UCL_USER = user
</li> <li> Local UCL_DOMAIN = chtc.wisc.edu
</li> <li> Local GATEKEEPER = red.unl.edu
</li> <li> Local UCL_CWD= analysis_example
</li> <li> Local WORKING_DIR= /share/users/user/osg_school/touble_part1
</li> <li> Local BATCH_SYSTEM = condor
</li> <li> Local REMOTE_ROOT = /mnt/hadoop/user
</li> <li> Local REMOTE_SRM = red-srm1.unl.edu:8443
</li> <li> Local REMOTE_GRIDFTP= red-gridftp.unl.edu
</li> <li> Local SURL = srm://red-srm1.unl.edu:8443/srm/v2/server?SFN=/mnt/hadoop/user
</li> <li> Local TURL= gsiftp://red-gridftp.unl.edu//mnt/hadoop/user
</li> <li> Local OSG_DATA=/osg/data
</li> <li> Local BLAST_DB_SUBMIT=/share/blast
</li> <li> Local VDT_LOCATION=/opt/osg-client
</li></ul> 
-->
<p />
<img width="16" alt="warning" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/warning.gif" height="16" border="0" /> <font color="#ff0000"> Please change your user name and click on the Customize button!</font>
<form action="/bin/view/Education/AnalysisExample">
<table>
  <tr>
    <td>
      <font color="#ff0000">Login Name</font>
    </td>
    <td>
      <input size=100 type="text" name="INPUT_USER" value="user"/>
    </td>
  </tr>
  <tr>
    <td>
      VO
    </td>
    <td>
      <input size=100 type="text" name="INPUT_VO" value="osgedu"/>
    </td>
  <tr>
    <td>
      Host Name
    </td>
    <td>
      <input size=100 type="text" name="INPUT_HOST" value="osg-ss-glidein"/>
    </td>
  </tr>
  <tr>
    <td>
      Domain Name
    </td>
    <td>
      <input size=100 type="text" name="INPUT_DOMAIN" value="chtc.wisc.edu"/>
    </td>
  </tr>
    <td>
      Exercise Path
    </td>
    <td>
      <input size=100 type="text" name="INPUT_WORKING_DIR" value="/share/users/user/osg_school/touble_part1"/>
    </td>
  </tr>
  <tr>
    <td>
     &nbsp;
     <input type="submit" class="twikiSubmit" value="Customize" />
    </td>
  </tr>
</table>
</form>
<p />
<h1><a name="Exercises"></a> Exercises </h1>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Prerequisite"></a> Prerequisite </span></h2>
<p /> <ul>
<li> Login on submission node <pre class="screen">
ssh user@osg-ss-glidein.chtc.wisc.edu
</pre>
</li></ul> 
<!--   * Initialize the OSG client environment <pre class="screen">
source /opt/osg-client/setup.sh
</pre>
--> <ul>
<li> Obtain proxy certificate, if you have not done so already <pre class="screen">
voms-proxy-init -voms osgedu:/osgedu
</pre>
</li> <li> Make a directory for this exercise<pre class="screen">
mkdir -p analysis_example
cd analysis_example
</pre>
</li></ul> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Simple_Analysis_Example"></a> Simple Analysis Example </span></h2>
<p />
<h3><a name="Step_1_Create_simulated_data_usi"></a> Step 1: Create simulated data using the grid </h3>
<p />
Now in your test directory on the submission host we will create the three files: <code><b>run-root.cmd</b></code>, <code><b>run-root.sh</b></code>, and <code><b>run-root.C</b></code> with the contents
given below. This may require running an editor such as <code>emacs</code> on your local desktop and then copying the created files to the submission host. Or the <code>nano</code> editor can be run directly on the submission host. A
typical copy command would be as follows. 
<p />
<pre class="screen">
scp run-root.* user@osg-ss-glidein.chtc.wisc.edu:analysis_example/
</pre>
<p />
<p />
First, we will utilize a simple command script to submit the grid jobs. It is <code><b>run-root.cmd</b></code>:
<p />
<pre class="file">
universe=grid
grid_resource=gt2 osgitb1.nhn.ou.edu/jobmanager-fork
executable=run-root.sh
transfer_input_files = run-root.C
transfer_executable=True
when_to_transfer_output = ON_EXIT
log=run-root.log
transfer_output_files = root.out,t00.root,t01.root
output=run-root.out.$(Cluster).$(Process)
error=run-root.err.$(Cluster).$(Process)
notification=Never
queue 
</pre>
<p />
Note that the executable script is:  <code><b>run-root.sh</b></code> which is as follows:
<pre class="file">
#!/bin/bash 
/usr/local/bin/root -b < run-root.C > root.out
</pre>
This script runs Root in batch mode and executes input macro <code><b>run-root.C</b></code> and produces output that is routed to file <code><b>root.out</b></code>
It has to be made executable, by use of the <code>chmod</code> Linux command (protections can be checked with the command <code>ls -l</code>):
<p />
<pre class="screen">
chmod +x run-root.sh
</pre>
<p />
The macro  <code><b>run-root.C</b></code> consists of the following code:
<p />
<pre class="file">
{ 
 
 // create files containing simulated data
 
 TRandom g; 
 char c[256]; 
 for ( int j = 0 ; j < 2 ; j++ ){ 
    sprintf(c,"t%2.2d.root\000",j); 
    TFile f(c,"RECREATE","MyFile", 0/*no compression*/); 
    TTree *t = new TTree("t0","t0"); 
    Int_t Run; 
    TBranch * b_Run = t->Branch("Run",&Run); 
    Int_t Event; 
    TBranch * b_Event = t->Branch("Event",&Event); 
    Float_t Energy; 
    TBranch * b_Energy = t->Branch("Energy",&Energy); 
    Run = j; 
 
        for( Event = 0 ; Event < 100 ; Event++ ){ 
          Energy = g.Gaus(500.0 , 200.0);   
          t->Fill(); 
        }  
    f.Write(); 
    f.Close(); 
 } 
} 
.q 
</pre>
<p />
The grid job can be submitted using:
<p />
<pre class="screen">
condor_submit run-root.cmd
</pre>
<p />
It can be checked with: 
<p />
<pre class="screen">
condor_q
</pre>
<p />
After it runs, you will find a log file that describes the job: <code><b>run-root.log</b></code>, and output file: <code><b>root.out</b></code>, and the files containing the simulated data: <code><b>t00.root</b></code>, <code><b>t01.root</b></code> in your test directory. 
You can now copy the output files to your local desktop machine with the <code>scp</code> command we used before. A
typical copy command would be as follows. 
<p />
<pre class="screen">
scp user@osg-ss-glidein.chtc.wisc.edu:analysis_example/t*.root .
</pre>
<p />
You can inspect the contents of <code><b>t00.root</b></code> and <code><b>t01.root</b></code> by running 
Root (i.e., <code><b>root t00.root</b></code>) on your local machine and using the 
Root command:  <code><b>TBrowser b</b></code>
<p />
With the <code><b>TBrowser</b></code> you can plot the simulated data in branch “Energy” as well as the other branches.
<p />
Each data file contains a TTree named “t0”. You can plot the contents of all (in this example both) data file TTree's by using the TChain method as follows:
<p />
Before running root, execute the following command:
<pre class="screen">
export LD_LIBRARY_PATH=/usr/lib/root
</pre>
<p />
In Root execute the following commands:
<pre class="file">
TChain tc("t0");
tc.Add("t*.root");
tc.Draw("Energy");
</pre>
<p />
<h3><a name="Step_2_Make_TSelector"></a> Step 2: Make TSelector </h3>
<p />
In Root in your test directory, execute the following commands:
<pre class="file">
TFile f("t00.root");
t0.MakeSelector("s0");
f.Close();
</pre>
<p />
This will create files <code><b>s0.C</b></code> and <code><b>s0.h</b></code> in your test directory that contain code corresponding to the definition of the TTree "t0". This code can be used to process files containing data is these TTree's.
<p />
Now we will add a histogram to the TSelector code. Several code lines have to be added to the TSelector code files <code><b>s0.C</b></code> and <code><b>s0.h</b></code>.
<p />
To <code><b>s0.h</b></code> make the additions:
after existing include statements add:
<p />
<pre class="file">
#include &lt;TH1F.h&gt;
</pre>
<p />
After class s0 definition:
      ( class s0 : public TSelector { ) 
add
<pre class="file">
TH1F *e;
</pre>
<p />
To <code><b>s0.C</b></code> make the additions:
<p />
After entry:
( void s0::SlaveBegin(TTree * /*tree*/) ) 
add
<pre class="file">
e = new TH1F("e", "e", 1000, -199.0, 1200.0);
</pre>
<p />
After Process entry:
 ( Bool_t s0::Process(Long64_t entry) )
add
<pre class="file">
GetEntry(entry);
e->Fill(Energy);
</pre>
<p />
After terminate entry:
( void s0::Terminate() )
add
<pre class="file">
TFile f("histograms.root","RECREATE");
f.WriteObject(e,”Energy”);
f.Close();
</pre>
<p />
Now create the new script files for Step 2:
<p />
create:
<code><b>run-root-2.cmd</b></code>
<pre class="file">
universe=grid 
grid_resource=gt2 osgitb1.nhn.ou.edu/jobmanager-condor 
executable=run-root-2.sh 
transfer_input_files = s0.C,s0.h,run-root-2.C,t00.root,t01.root 
transfer_executable=True 
when_to_transfer_output = ON_EXIT 
log=run-root-2.log 
transfer_output_files = root-2.out,histograms.root 
output=run-root.out.$(Cluster).$(Process) 
error=run-root.err.$(Cluster).$(Process) 
notification=Never 
queue 
</pre>
<p />
Create <code><b>run-root-2.sh</b></code>
<pre class="file">
#!/bin/bash 
/usr/local/bin/root -b < run-root-2.C > root-2.out 
</pre>
<p />
It has to be made executable, by use of the <code>chmod</code> Linux command:
<p />
<pre class="screen">
chmod +x run-root-2.sh
</pre>
<p />
<p />
Create <code><b>run-root-2.C</b></code>
<pre class="file">
.L s0.C++ 
{ 
 //Load and run TSelector 
 
  s0 *s = new s0(); 
 
  TChain tc("t0"); 
  tc.Add("t*.root"); 
  tc.Process(s); 
 
} 
</pre>
<p />
We can test the Root job on your local machine by issuing command:
<p />
<pre class="screen">
root < run-root-2.C
</pre>
<p />
If this works, we can process the data files <code>t00.root</code> and <code>t01.root</code> on the
Grid with our new command script <code><b>run-root-2.cmd</b></code>.
<p />
This can be done with command:
<p />
<pre class="screen">
condor_submit run-root-2.cmd
</pre>
<p />
You can look at the output histogram file: <code>histograms.root</code>
with <code><b>TBrowser b</b></code> as before.
<p />
<p />
-- <a href="/bin/view/Main/PatrickLouisSkubic" class="twikiLink">PatrickLouisSkubic</a> - 18 Jul 2012</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Education<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Education/AfricaGridSchool2012" class="twikiLink">AfricaGridSchool2012</a> &gt; <a href="/bin/view/Education/AfricaGridSchool12Materials" class="twikiLink">AfricaGridSchool12Materials</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>AnalysisExample</span> <br />    
Topic revision: r13 - 08 Aug 2012 - 10:55:51 - <a href="/bin/view/Main/RobQ" class="twikiLink">RobQ</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />