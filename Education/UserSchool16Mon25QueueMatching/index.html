<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> UserSchool16Mon25QueueMatching &lt; Education &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Education/UserSchool16Mon25QueueMatching?_T=16 Feb 2017" type="application/x-wiki" title="edit UserSchool16Mon25QueueMatching" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Education/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Education/UserSchool16Mon25QueueMatching"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">

@import url('/pub/Documentation/Tools/exercises.css ');

</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <style type="text/css">
pre em { font-style: normal; background-color: yellow; }
pre strong { font-style: normal; font-weight: bold; color: #008; }
</style>
<p />
<h1><a name="Monday_Exercise_2_5_Submit_With"></a> Monday Exercise 2.5: Submit With &ldquo;queue matching&rdquo; </h1>
<p />
In this exercise and the next one, you will explore more ways to use a single submit file to submit many jobs. The focus of this exercise is to submit one job per filename that matches a given pattern.
<p />
In all cases of submitting many jobs from a single submit file, the key questions are:
<p /> <ul>
<li> What makes each job unique? In other words, there is one job per <strong><em>___</em></strong>?
</li> <li> What tells HTCondor how to distinguish each job?
</li></ul> 
<p />
For <code>queue <i>N</i></code>, jobs are distinguished simply by number and HTCondor assigns the numbers itself. But with the remaining <code>queue</code> forms, you help HTCondor distinguish jobs by other, more meaningful means.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Counting_Words_in_Files"></a> Counting Words in Files </span></h2>
<p />
Suppose you have a collection of books, and you want to analyze how words vary from book to book or author to author. As mentioned in the lecture, HTCondor provides many ways to do this task. You could create a separate submit file for each book, and submit all of the files manually. Or you could be a bit more clever and create one submit file for all of the books:
<p />
<pre class="file">
universe                = vanilla
executable              = freq.py
request_memory          = 20
should_transfer_files   = YES
when_to_transfer_output = ON_EXIT

transfer_input_files = AAiW.txt
arguments            = &quot;AAiW.txt&quot;
output               = AAiW.out
error                = AAiW.err
log                  = AAiW.log
queue

transfer_input_files = PandP.txt
arguments            = &quot;PandP.txt&quot;
output               = PandP.out
error                = PandP.err
log                  = PandP.log
queue

transfer_input_files = TAoSH.txt
arguments            = &quot;TAoSH.txt&quot;
output               = TAoSH.out
error                = TAoSH.err
log                  = TAoSH.log
queue
</pre>
<p />
If you use many <code>queue</code> statements in one submit file, HTCondor remembers and carries over values for attributes, such as <code>universe</code>, <code>executable</code>, <code>request_memory</code>, and so on in this example.
<p />
But even then, this approach results in a long, repetitive submit file. And if you add more books, you must add five more lines to the submit file for each book. Therefore, this is not a recommended approach to submitting many jobs with one submit file. Fortunately, HTCondor has many <code>queue</code> features to make this kind of job submission process easy!
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Queue_Jobs_By_Matching_Filenames"></a> Queue Jobs By Matching Filenames </span></h2>
<p />
For our analysis, we will have a new version of the word-frequency counting script. It takes a single command-line argument, which is the name of the input file containing the text of a book, and it outputs the frequency of each word from least to most common. There will be several book files, and the filename for each book ends with <code>.txt</code>.
<p />
This is an example of a common scenario: We want to run one job per file, where the filenames match a certain consistent pattern. The <code>queue ... matching</code> statement is made for this scenario.
<p />
Let&rsquo;s see this in action. First, here is the new version of the script:
<p />
<pre class="file">
#!/usr/bin/env python

import os
import sys
import operator

if len(sys.argv) != 2:
    print 'Usage: %s DATA' % (os.path.basename(sys.argv[0]))
    sys.exit(1)
input_filename = sys.argv[1]

words = {}

my_file = open(input_filename, 'r')
for line in my_file:
    line_words = line.split()
    for word in line_words:
        if word in words:
            words[word] += 1
        else:
            words[word] = 1
my_file.close()

sorted_words = sorted(words.items(), key=operator.itemgetter(1))
for word in sorted_words:
    print '%s %8d' % (word[0], word[1])
</pre>
<p />
To use the script:
<p /> <ol>
<li> Save it as <code>wordcount.py</code>
</li> <li> Download and unpack some books from Project Gutenberg:       <pre class="screen">
$> <strong>wget http://proxy.chtc.wisc.edu/SQUID/osgschool16/books.zip</strong>
$> <strong>unzip books.zip</strong>
</pre>
</li> <li> Verify the script by running it on one book manually
</li> <li> Create a submit file to submit one file (pick one), including a memory request of 20&nbsp;MB; submit it, if you like
</li> <li> Modify the following submit file statements to work for all books:       <pre class="file">
transfer_input_files = $(BOOK)
arguments = &quot;$(Book)&quot;
output = $(book).out
error = $(book).err
queue book matching *.txt
</pre>       <p>Note, as always, the order of statements in a submit file does not matter, except that the <code>queue</code> statement should be last. Also note that any submit file variable name (here, <code>book</code>, but true for <code>process</code> and all others) may be used in any mixture of upper- and lowercase letters.</p>
</li> <li> Submit the jobs
</li></ol> 
<p />
HTCondor uses the <code>queue ... matching</code> statement to look for files in the submit directory that match the given pattern, then queues one job per match. For each job, the given variable (e.g., <code>book</code> here) is assigned the name of the matching file, so that it can be used in <code>output</code>, <code>error</code>, and other statements.
<p />
The result is the same as if we had written out a much longer submit file:
<p />
<pre class="file">
...

transfer_input_files = AAiW.txt
arguments = &quot;AAiW.txt&quot;
output = AAiW.txt.out
error = AAiW.txt.err
queue

transfer_input_files = PandP.txt
arguments = &quot;PandP.txt&quot;
output = PandP.txt.out
error = PandP.txt.err
queue

transfer_input_files = TAoSH.txt
arguments = &quot;TAoSH.txt&quot;
output = TAoSH.txt.out
error = TAoSH.txt.err
queue
</pre>
<p />
Here is some sample <code>condor_q</code> output:
<p />
<pre class="screen">
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD
  89.0   iaross          7/25 11:41   0+00:00:00 I  0    0.0 wordcount.py AAiW.txt
  89.1   iaross          7/25 11:41   0+00:00:00 I  0    0.0 wordcount.py PandP.txt
  89.2   iaross          7/25 11:41   0+00:00:00 I  0    0.0 wordcount.py TAoSH.txt
</pre>
<p />
All three jobs were part of cluster 89. The first filename that was matched in the queue statement resulted in a process ID of 0, the second match has a process ID of 1, and the third has a process ID of 2.
<p />
When the three jobs finish, carefully look at the resulting files. Do they match your expectations? There should be a single log file, but three separate output files and three separate (and hopefully empty) error files, one for each job.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Extra_Challenge_1"></a> Extra Challenge 1 </span></h2>
<p />
In the example above, you used a single log file for all three jobs. HTCondor handles this situation with no problem; each job writes its events into the log file without getting in the way of other events and other jobs. But as you may have seen, it may be difficult for a person to understand the events for any particular job in the combined log file.
<p />
Create a new submit file that works just like the one above, except that each job writes its own log file.</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Education<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Education/OSGUserSchool2016" class="twikiLink">OSGUserSchool2016</a> &gt; <a href="/bin/view/Education/UserSchool16Materials" class="twikiLink">UserSchool16Materials</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>UserSchool16Mon25QueueMatching</span> <br />    
Topic revision: r10 - 22 Jul 2016 - 20:41:40 - <span class="twikiNewLink">IanRoss<a href="/bin/edit/Main/IanRoss?topicparent=Education.UserSchool16Mon25QueueMatching" rel="nofollow" title="IanRoss (this topic does not yet exist; you can create it)">?</a></span>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />