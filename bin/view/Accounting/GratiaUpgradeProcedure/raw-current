<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> GratiaUpgradeProcedure &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaUpgradeProcedure?_T=16 Feb 2017" type="application/x-wiki" title="edit GratiaUpgradeProcedure" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaUpgradeProcedure"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiPref.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twiki_edit.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern_edit.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">
#patternTopBar,
#patternTopBarContentsOuter {
	height:95px; /* top bar height; make room for header columns */
}
#twikinetTopToolBar,
#twikinetTopToolBar table {
	top:95px; /* top bar height */
	height:48px;
}
#patternClearHeaderCenter,
#patternClearHeaderLeft,
#patternClearHeaderRight {
	height:144px; /* 95 + border + 48 */
}
#twikinetLogo {
	position:absolute;
	width:100%;
	height:95px;
}
#twikinetLogo a {
	position:absolute;
	display:block;
	width:179px;
	height:65px;
	background:none;
	top:10px;
	left:340px;
}
#twikinetLogo a:link, 
#twikinetLogo a:visited {
	border:none;
}
#twikinetLogo a:hover {
	border-style:none none solid none;
	border-width:1px;
	border-color:#c4cbd6;
}
#twikinetLogo a span {
	display:none;
}
#patternOuter {
	margin-left:220px;
}
#patternLeftBar {
	width:220px;
	margin-left:-220px;
}
</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternRawViewPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternWrapper"><div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain"><div id="patternClearHeaderCenter"></div>
<div id="patternMainContents"><div class="patternTop"><span class="patternHomePath"><span class="patternHomePathTitle">You are here: </span> <a href="/bin/view/Main/WebHome" class="twikiLink">TWiki    </a><span class='twikiSeparator'>&gt;</span><img src="/twiki/pub/TWiki/TWikiDocGraphics/web-bg-small.gif" border="0" alt="" width="13" height="13" style="background-color:#D0D0D0" />&nbsp;<a href="/bin/view/Accounting/WebHome">Accounting Web</a><span class='twikiSeparator'>&gt;</span><a href="https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaUpgradeProcedure" title='Topic revision: 12 (11 Dec 2008 - 18:51:44)'>GratiaUpgradeProcedure</a> <span class='patternRevInfo'>(11 Dec 2008, <a href="/bin/view/Main/KyleGross" class="twikiLink">KyleGross</a>)</span> (raw view)</span><!-- /patternHomePath--></div><!--/patternTop--><div class="twikiContentHeader"></div><div class="patternContent"><div class="patternTopic"> <textarea name=""  rows="22    " cols="70    " readonly="readonly" style="width: 99%    " id="topic" class="twikiTextarea twikiTextareaRawView">---+!! Gratia Upgrade Procedure

%TOC%

%STARTINCLUDE%
&lt;!--
   * Set EDITTHISTEXT = &lt;div class=&quot;twikiSmall&quot;&gt;&lt;a href=&quot;%TOPIC%&quot;&gt;edit this section&lt;/a&gt;&lt;/div&gt;

   * Set PROD_VER      = &lt;b&gt;v0.32.1b&lt;/b&gt;

   * Set PROD_NODE    = &lt;b&gt;gratia09&lt;/b&gt;
   * Set PROD_DB       = &lt;b&gt;gratia06&lt;/b&gt;
   * Set PROD_TC       = &lt;b&gt;%PROD_NODE%:/data/tomcat-gratia&lt;/b&gt;
   * Set PROD_TC_SERVICE = tomcat-gratia
   * Set PROD_URL      = http://gratia09.fnal.gov:8880

   * Set TEMP_NODE    = &lt;b&gt;gratiax23&lt;/b&gt;
   * Set TEMP_DB       = &lt;b&gt;gratia07&lt;/b&gt;
   * Set TEMP_TC       = &lt;b&gt;%TEMP_NODE%:VDT_LOCATION/tomcat/v55&lt;/b&gt;
   * Set TEMP_TC_SERVICE = tomcat-55
   * Set TEMP_URL      = http://gratiax23.fnal.gov:8880

   * Set DB_NAME       = &lt;b&gt;gratia&lt;/b&gt;

   * Set JUR               = &lt;nop&gt;JobUsageRecord
   * Set CONFIG          = &lt;b&gt;./gratia/service-configuration.properties&lt;/b&gt;
--&gt;

Database privileges:
   * ./post-install.sh summary-view
      * forces the update of the VIEWS.  There is a DEFINER= parameter in the &lt;nop&gt;VOProbeSummay view which contains the original database/collector used.  This can be reset by re-loading the views.



---++ Gratia Upgrade Procedure
%EDITTHISTEXT%

---+++ Overview

The intent is to minimize downtime (availability) of Gratia services.  This is a general outline and the details for each step will be addressed in a subsequent section.  This will also serve as a trial/template for future conversions where DB changes may require long conversion times. 

---+++ Setup the temporary %TEMP_NODE% tomcat and %TEMP_DB% database
&lt;ol&gt;
  &lt;li&gt; Install the current production version (%PROD_VER%) of Gratia on a test machine (%TEMP_NODE%)
     &lt;ol type=&quot;a&quot;&gt;
      &lt;li&gt; To avoid complications and additional work, it is best if this is an instance that has *no* probes reporting to it.
      &lt;li&gt; Turn off the &lt;nop&gt;MySql instance to reduce resource consumption
&lt;pre&gt;
service mysql5 stop
&lt;/pre&gt;
      &lt;li&gt; We are only using the tomcat web services and will be pointing it to the %PROD_DB% to effect the conversion.
      &lt;li&gt; To be safe, turn off the update services: on the gratia-administration screen, 
         &lt;ul&gt;
           &lt;li&gt; go to System--&amp;gt;Administration, 
           &lt;li&gt; scroll down and click on the _Stop Update Services_ link,
           &lt;li&gt; the _Current Status_ should show _Stopped_ 
          &lt;/ul&gt;
       &lt;li&gt; *Remember* that every time you restart the _tomcat_ service, the Gratia collector comes up in _Update_ mode which *will* cause problems since we are converting the *real* database.  This is why using an instance that is assured of having no probes reporting to it is very important. 
      &lt;/ol&gt;

   &lt;li&gt; We are going to be switching the %PROD_TC% collector/reporter to use the %TEMP_DB% database while the conversion takes place on %PROD_DB%.  So, to effect this, we need to do the following:
      &lt;ol type=&quot;a&quot;&gt;
      &lt;li&gt; Rather than take the %PROD_DB% database off-line to do a backup to %TEMP_DB%, we will use the nightly backup (currently a _mysqlhotcopy_).
      &lt;li&gt; On %TEMP_DB%:
         &lt;ul&gt;
         &lt;li&gt; The night before, remove all files under the &lt;b&gt;/data/mysqldb/%DB_NAME%&lt;/b&gt; directory and set the ownership on the directory to *gratia.mysql*.
         &lt;li&gt; Also the night before, verify/set the users and privileges so the %TEMP_NODE% has permissions to update the stored procedures:
&lt;pre&gt;
GRANT ALL ON *.* TO &#39;root&#39;@&#39;&amp;lt;your collector ip address&amp;gt;  identified by &#39;root password&#39;;
GRANT GRANT OPTION ON *.* TO &#39;root&#39;@&#39;&amp;lt;your collector ip address&amp;gt; 
&lt;b&gt;...note you can find the IP address by executing...
   host %TEMP_NODE%.fnal.gov&lt;/b&gt;
&lt;/pre&gt;
            Also verify that the %PROD_DB% has the same root permissions for it&#39;s specific IP address.  If it doesn&#39;t, set them as above.

         &lt;li&gt; On the day of cutover, verify the ownership on the &lt;b&gt;/data/mysqldb/%DB_NAME%&lt;/b&gt; directory and the ownership on the table files are *gratia.mysql*.  They will likely have been reset from the nightly backup.

         &lt;li&gt; If replication is in use, we need to turn it off temporarily and also be in a position to turn it back on once we have converted to using the %TEMP_DB% database:
&lt;pre&gt;
&lt;b&gt;... this creates a file to be used when turning Replication back on .... &lt;/b&gt;
select &quot;update Replication set running=1 where replicationid=&quot;,replicationid,&quot;;&quot; 
from Replication where running=1 into outfile &#39;/tmp/jgw.sql&#39;;
&lt;b&gt;... be sure that the &lt;i&gt;outfile&lt;/i&gt; does not already exist or it will fail&lt;/b&gt;

&lt;b&gt;... then turn replication off for those ids&lt;/b&gt;
update Replication set running=0 where running=1;
&lt;/pre&gt;

         &lt;li&gt; Update the *SystemProplist* table for the attributes below so the stored procedures, triggers and table statistics get updated correctly.
            &lt;pre&gt;
update &lt;nop&gt;SystemProplist set cdr=0 where car=&#39;gratia.database.storedProcedureVersion&#39;;
update &lt;nop&gt;SystemProplist set cdr=0 where car=&#39;gratia.database.summaryTriggerVersion&#39;;
update &lt;nop&gt;SystemProplist set cdr=0 where car=&#39;gratia.database.TableStatisticsVersion&#39;;

select * from SystemProplist;  

+--------+----------------------------------------+------+
| propid | car                                    | cdr  |
+--------+----------------------------------------+------+
|    211 | use.report.authentication              | true | 
|    212 | gratia.database.version                | 28   | 
|    214 | gratia.database.summaryTableVersion    | 26   | 
|    &lt;b&gt;215 | gratia.database.summaryTriggerVersion  |  0   | &lt;/b&gt;
|    &lt;b&gt;216 | gratia.database.storedProcedureVersion |  0   | &lt;/b&gt;
|    217 | gratia.database.wantSummaryTable       | 1    | 
|    218 | gratia.database.wantSummaryTrigger     | 1    | 
|    219 | gratia.database.wantStoredProcedures   | 1    | 
|    &lt;b&gt;220 | gratia.database.TableStatisticsVersion |  0   | &lt;/b&gt;
+--------+----------------------------------------+------+
&lt;/pre&gt;
         &lt;/ul&gt;

      &lt;li&gt; On %TEMP_TC%:
         &lt;ul&gt;
         &lt;li&gt; change the %CONFIG% file entries to use the %TEMP_DB% database
         &lt;pre&gt;
service.mysql.url=jdbc:mysql://%TEMP_DB%.fnal.gov:&lt;b&gt;3320&lt;/b&gt;/%DB_NAME%
&lt;b&gt;... use the values from the %PROD_TC% instance....&lt;/b&gt;
service.mysql.user=&lt;b&gt;xxxxx&lt;/b&gt;
service.mysql.password=&lt;b&gt;xxxxx&lt;/b&gt;
service.reporting.user=&lt;b&gt;xxxxx&lt;/b&gt;
service.reporting.password=&lt;b&gt;xxxxx&lt;/b&gt;
&lt;/pre&gt;
         &lt;li&gt; Restart the tomcat service.  It&#39;s also not a bad idea to remove the log files so it is easier to spot any problems.
&lt;pre&gt;
service %TEMP_TC_SERVICE% stop
rm -f VDT_LOCATION/tomcat/v55/logs/*
service %TEMP_TC_SERVICE% start

&lt;b&gt;... since there should be no updates occurring, nor any replication 
         you should see only this line in the &lt;i&gt;catalina.out&lt;/i&gt; file and
         no other activity&lt;/b&gt;
INFO: Server startup in 14307 ms
&lt;/pre&gt;
         &lt;li&gt;A couple of things to look for in the logs (other than obvious stacktrace errors) is any failures in updating the triggers, procedures, summary tables, or summary views:
&lt;pre&gt;
 grep -i fail ./logs/*  

grep &quot;Summary trigger updated successfully&quot; *
grep &quot;Stored procedures updated successfully&quot; *
grep &quot;Summary tables updated successfully&quot; *
grep &quot;Summary view updated successfully&quot; *
grep &quot;Table statistics updated successfully&quot; *
&lt;/pre&gt;
           Another item to look for to verify you have connected to the right database would be to re-query the _SystemProplist_ table on %TEMP_DB%, checking
that the _cdr_ value changed on those set to 0.
&lt;pre&gt;select * from SystemProplist;&lt;/pre&gt;
         &lt;/ul&gt;

      &lt;li&gt; Verify you are connected correctly by bringing up the administration (%TEMP_URL%/gratia-administration) page in your browser.  The counts shown and those on the %PROD_URL%/gratia-administration page should be reasonably close with the only difference being the data collected since the _mysqlhotcopy_ was performed.


      &lt;li&gt;We need to create the static report files
         &lt;ul&gt;
         &lt;li&gt;Execute the following (as root):
&lt;pre&gt;
/usr/local/osg-collector/tomcat/v55/gratia/staticReports.py \
  /usr/local/osg-collector/tomcat/v55 \
  http://gratiax23.fnal.gov:8880/gratia-reporting
&lt;/pre&gt;
          &lt;li&gt;Bring up the gratia reporting%BR% - %TEMP_URL%/gratia-reporting

          &lt;li&gt;Click on the _Static Reports_ menu item and then verify each report comes up.
          &lt;/ul&gt;
      &lt;/ol&gt;
&lt;/ol&gt;



---+++ Bring the %TEMP_DB% into sync with the %PROD_DB%
We now have to &quot;catch up&quot; the %TEMP_DB% database before switching the %PROD_NODE% collector  to use it. 
&lt;ol&gt;
    &lt;li&gt; On %TEMP_DB%, find the last _dbid_  for the %JUR% table.
&lt;!--
   * Set MAXDBID = 8049804
--&gt;
&lt;pre&gt;
select max(dbid) from %JUR%;
+-----------+
| max(dbid) |
+-----------+
|   %MAXDBID% | 
+-----------+
&lt;/pre&gt;

    &lt;li&gt; On %PROD_URL%/gratia-administration, add a replication entry pointing to %TEMP_URL% and starting with the _dbid_ from the previous step _+1_.  Be sure to test it..*Do not activate it yet.*

    &lt;li&gt;In the %PROD_DB% %DB_NAME% database, set the _dbid_ in the _Replication_ table to the %MAXDBID%.
&lt;pre&gt;
select * from Replication where openconnection like &#39;%%TEMP_NODE%%&#39;;
update Replication set dbid=%MAXDBID%  where openconnection like &#39;%%TEMP_NODE%%&#39;;
&lt;/pre&gt;

    &lt;li&gt; Now back on the %PROD_URL%/gratia-administration replication screen, refresh the screen and verify the _dbid_ value.

    &lt;li&gt; If all is well, click the _Start_ button.  Then watch for a while in the %TEMP_TC% logs files for any errors.  You can also watch on the %TEMP_URL%/gratia-administration _Status_ screen.

    &lt;li&gt; On %PROD_URL%/gratia-administration, go to the _System --&amp;gt; Administration_ page and then to _Starting/Stopping Database Update Services_  section and select the _Stop Update Services_ link.    This will queue any updates and allow the two instances to sink without losing any data.

    &lt;li&gt; *WAIT UNTIL* the _All Time Total_ numbers are equal for both %PROD_URL% and %TEMP_URL%. Then we are caught up and can proceed.

    &lt;li&gt; On the %PROD_URL%/gratia-administration replication screen, *Stop* the replication for %TEMP_URL%.  

    &lt;li&gt; On the %PROD_URL%/gratia-administration replication screen, *Delete* the replication for %TEMP_URL%.

   &lt;li&gt;On %TEMP_NODE%, stop the tomcat service.  This positions us to switch the %PROD_TC% tomcat service to using the %TEMP_DB% database.
        &lt;pre&gt;service %TEMP_TC_SERVICE% stop&lt;/pre&gt;
&lt;/ol&gt;




---+++ Switch the %PROD_NODE% tomcat to use the %TEMP_DB% database
On %PROD_NODE%, switch the  tomcat instance using the %PROD_DB% database to the backup on %TEMP_DB%. The %TEMP_DB% database will be used for for production until the conversion is complete on %PROD_DB%.

This will be the first _downtime_ period for the %DB_NAME% Gratia service.

&lt;ol&gt;&lt;li&gt;Stop the %PROD_TC_SERVICE%
           &lt;pre&gt;service %PROD_TC_SERVICE% stop&lt;/pre&gt;
          
      &lt;li&gt;Edit the _%PROD_TC%/gratia/service-configuration.properties_ file changing the _service.mysql.url_ attribute to reference the _%TEMP_DB%_ database.
            &lt;pre&gt;service.mysql.url=jdbc:mysql://%TEMP_DB%.fnal.gov:3320/%DB_NAME% &lt;/pre&gt;

   &lt;li&gt;Start the %PROD_TC_SERVICE%
           &lt;pre&gt;service %PROD_TC_SERVICE% service&lt;/pre&gt;
        It would probably be a good idea to _tail_ the log files for a period to verify all is well.

&lt;/ol&gt;







---+++ Effect the conversion using %TEMP_NODE% tomcat and %PROD_DB% database

&lt;ol&gt;
   &lt;li&gt; On %TEMP_NODE%, the tomcat instance should have already been stopped.  If not, do it *quickly*.
&lt;pre&gt;
service %TEMP_TC_SERVICE% stop
&lt;/pre&gt;

  &lt;li&gt; On %TEMP_NODE%, edit the _%TEMP_TC%/gratia/service-configuration.properties_ file changing the _service.mysql.url_ attribute to reference the _%PROD_DB%_ database.
            &lt;pre&gt;service.mysql.url=jdbc:mysql://%PROD_DB%.fnal.gov:3320/%DB_NAME% &lt;/pre&gt;
       *It is very important that this step be performed or the result will most likely be a mess.*

  &lt;li&gt; On %TEMP_NODE%, edit the %TEMP_TC%/gratia/hibernate.cfg.xml file changing:
&lt;pre&gt;
         &amp;lt;!-- SQL dialect --&amp;gt;
&lt;b&gt;from.&lt;/b&gt; &amp;lt;property name=&quot;dialect&quot;&amp;gt;org.hibernate.dialect.MySQLDialect&amp;lt;/property&amp;gt;
&lt;b&gt;to..&lt;/b&gt; &amp;lt;property name=&quot;dialect&quot;&amp;gt;org.hibernate.dialect.MySQLInnoDBDialect&amp;lt;/property&amp;gt;
&lt;/pre&gt;

     &lt;li&gt; On %PROD_DB%, verify/set the users and privileges so the %TEMP_NODE% has permissions to update the stored procedures:
&lt;pre&gt;
GRANT ALL ON *.* TO &#39;root&#39;@&#39;&amp;lt;your collector ip address&amp;gt;  identified by &#39;root password&#39;;
GRANT GRANT OPTION ON *.* TO &#39;root&#39;@&#39;&amp;lt;your collector ip address&amp;gt; 
&lt;b&gt;...note you can find the IP address by executing...
   host %TEMP_NODE%.fnal.gov&lt;/b&gt;
&lt;/pre&gt;

  &lt;li&gt; On %TEMP_NODE%, start the gratia tomcat services:
&lt;pre&gt;
service %TEMP_TC_SERVICE% start
&lt;/pre&gt;

  &lt;li&gt; On %TEMP_NODE%, when the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
     &lt;ol type=&quot;a&quot;&gt;
        &lt;li&gt; _tail_ the  _catalina.out_ log  
        &lt;li&gt;When the conversion process completes the log will show the following message:
&lt;pre&gt;INFO: Server startup in _xxx_ms&lt;/pre&gt;
      &lt;/ol&gt;

   &lt;li&gt; *Wait until the previous step completes before proceeding.*

&lt;/ol&gt;


---+++ Bring the %PROD_DB% into sync with the %TEMP_DB%
Before we switch the %PROD_NODE% tomcat service back to using the %PROD_DB%, we have to do a &quot;catch up&quot; on the data the %TEMP_DB% has been collecting while the conversion was being performed.

&lt;ol&gt;
         &lt;li&gt; On %PROD_DB%, find the last _dbid_  for the %JUR% table.
&lt;!--
   * Set NEW_MAXDBID = 8054381
--&gt;
&lt;pre&gt;
select max(dbid) from %JUR%;
+-----------+
| max(dbid) |
+-----------+
|   %NEW_MAXDBID% | 
+-----------+
&lt;/pre&gt;

    &lt;li&gt; On %PROD_URL%/gratia-administration, add a replication entry pointing to %TEMP_URL% and starting with the _dbid_ from the previous step _+1_.  Be sure to test it..*Do not activate it yet.*

    &lt;li&gt;On %TEMP_DB% in the %DB_NAME% database, set the _dbid_ in the _Replication_ table to the %NEW_MAXDBID%.
&lt;pre&gt;
select * from Replication where openconnection = &#39;%TEMP_URL%&#39;;
update Replication set dbid=%NEW_MAXDBID%  where openconnection = &#39;%TEMP_URL%&#39;;
&lt;/pre&gt;

    &lt;li&gt; Now back on the %PROD_URL%/gratia-administration replication screen, refresh the screen and verify the _dbid_ value.

    &lt;li&gt; If all is well, click the _Start_ button.  Then watch for a while in the %TEMP_TC% logs files for any errors.  You can also watch on the %TEMP_URL%/gratia-administration _Status_ screen.

    &lt;li&gt; On %PROD_URL%/gratia-administration, go to the _System --&amp;gt; Administration_ page and then to _Starting/Stopping Database Update Services_  section and select the _Stop Update Services_ link.    This will queue any updates and allow the two instances to sink without losing any data.

    &lt;li&gt; *WAIT UNTIL* the _All Time Total_ numbers are equal for both %PROD_URL% and %TEMP_URL%. Then we are caught up and can proceed.

     &lt;li&gt; On the %PROD_URL%/gratia-administration replication screen, *Stop* the replication for %TEMP_URL%.  

    &lt;li&gt; On the %PROD_URL%/gratia-administration replication screen, *Delete* the replication for %TEMP_URL%.

    &lt;li&gt;On %TEMP_NODE%, stop the tomcat service.  This positions us to switch the %PROD_TC% tomcat service to using the %PROD_DB% database.
        &lt;pre&gt;service %TEMP_TC_SERVICE% stop&lt;/pre&gt;
&lt;/ol&gt;





---+++ Switch %PROD_NODE% tomcat back to the %PROD_DB% database
&lt;ol&gt;
   &lt;li&gt; On %PROD_NODE%, stop the tomcat service for %DB_NAME%.
&lt;pre&gt;
service %PROD_TC_SERVICE% stop
&lt;/pre&gt;

  &lt;li&gt; On %PROD_NODE%, edit the _%PROD_TC%/gratia/service-configuration.properties_ file changing the _service.mysql.url_ attribute to reference the _%PROD_DB%_ database.
            &lt;pre&gt;service.mysql.url=jdbc:mysql://%PROD_DB%.fnal.gov:3320/%DB_NAME% &lt;/pre&gt;
       *It is very important that this step be performed or the result will most likely be a mess.*

  &lt;li&gt; On %PROD_NODE%, edit the %PROD_TC%/gratia/hibernate.cfg.xml file changing:
&lt;pre&gt;
         &amp;lt;!-- SQL dialect --&amp;gt;
&lt;b&gt;from.&lt;/b&gt; &amp;lt;property name=&quot;dialect&quot;&amp;gt;org.hibernate.dialect.MySQLDialect&amp;lt;/property&amp;gt;
&lt;b&gt;to..&lt;/b&gt; &amp;lt;property name=&quot;dialect&quot;&amp;gt;org.hibernate.dialect.MySQLInnoDBDialect&amp;lt;/property&amp;gt;
&lt;/pre&gt;


  &lt;li&gt; On %PROD_NODE%, start the gratia tomcat services:
&lt;pre&gt;
service %PROD_TC_SERVICE% start
&lt;/pre&gt;

  &lt;li&gt; On %PROD_NODE%, when the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
     &lt;ol type=&quot;a&quot;&gt;
        &lt;li&gt; _tail_ the  _catalina.out_ log  
        &lt;li&gt;When the conversion process completes the log will show the following message:
&lt;pre&gt;INFO: Server startup in _xxx_ms&lt;/pre&gt;
      &lt;/ol&gt;

   &lt;li&gt; *WE ARE DONE  AND CAN BREATH AGAIN!!!!*

&lt;/ol&gt;



&lt;hr width=95% /&gt;





%STOPINCLUDE%

&lt;!-- MAJOR UPDATES
For significant updates to the topic, consider adding your &#39;signature&#39; (beneath this editing box) !--&gt;
---++!! Major updates
&lt;!--Future editors should add their signatures beneath yours!--&gt;
-- Main.JohnWeigand - 10 Mar 2008
</textarea> <div class="patternSigLine"><span class="twikiRight twikiMakeVisible" style="text-align:left;"><span class="twikiLeft patternTextareaButton patternButtonFontSelector" title="Switch to monotype or propotional font">&nbsp;</span><span class="twikiLeft patternTextareaButton patternButtonEnlarge" title="Enlarge edit box">&nbsp;</span><span class="twikiLeft patternTextareaButton patternButtonShrink" title="Shrink edit box">&nbsp;</span></span><br class="twikiClear" /></div><!-- /patternSigLine--></div><!-- /patternTopic-->
<div class="twikiContentFooter"></div></div><!-- /patternContent-->
<a name="topic-actions"></a><div class="twikinetRounded twikinetRoundedTopicActions"><div class="rCRounded"><div class="rCTR"><div class="rCTL"></div><!--/rCTL--><div class="patternTopicActions"><div class="patternTopicAction"><span class="patternActionButtons"><span class="patternButton"><a href='https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaUpgradeProcedure?t=1487267877;nowysiwyg=1' rel='nofollow' title='Edit this topic text' accesskey='e'><span class='twikiAccessKey'>E</span>dit</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span class='patternButton'><a href='/bin/attach/Accounting/GratiaUpgradeProcedure' rel='nofollow' title='Attach an image or document to this topic' accesskey='a'><span class='twikiAccessKey'>A</span>ttach</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span class='patternButton'><a href='/bin/view/Accounting/GratiaUpgradeProcedure?cover=print;raw=on' rel='nofollow' title='Printable version of this topic' accesskey='p'><span class='twikiAccessKey'>P</span>rint version</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><span><a href='/bin/rdiff/Accounting/GratiaUpgradeProcedure?type=history' rel='nofollow' title='View total topic history' accesskey='h'><span class='twikiAccessKey'>H</span>istory</a></span>: r12&nbsp;<a rel="nofollow" href="/bin/rdiff/Accounting/GratiaUpgradeProcedure?rev1=12;rev2=11">&lt;</a>&nbsp;<a rel="nofollow" href="/bin/view/Accounting/GratiaUpgradeProcedure?rev=11">r11</a>&nbsp;<a rel="nofollow" href="/bin/rdiff/Accounting/GratiaUpgradeProcedure?rev1=11;rev2=10">&lt;</a>&nbsp;<a rel="nofollow" href="/bin/view/Accounting/GratiaUpgradeProcedure?rev=10">r10</a>&nbsp;<a rel="nofollow" href="/bin/rdiff/Accounting/GratiaUpgradeProcedure?rev1=10;rev2=9">&lt;</a>&nbsp;<a rel="nofollow" href="/bin/view/Accounting/GratiaUpgradeProcedure?rev=9">r9</a>&nbsp;<a rel="nofollow" href="/bin/rdiff/Accounting/GratiaUpgradeProcedure?rev1=9;rev2=8">&lt;</a>&nbsp;<a rel="nofollow" href="/bin/view/Accounting/GratiaUpgradeProcedure?rev=8">r8</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/bin/oops/Accounting/GratiaUpgradeProcedure?template=backlinksweb' rel='nofollow' title='Search the Accounting Web for topics that link to here' accesskey='b'><span class='twikiAccessKey'>B</span>acklinks</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaUpgradeProcedure' rel='nofollow' title='View topic' accesskey='v'><span class='twikiAccessKey'>V</span>iew topic</a></span><span class='twikiSeparator'>&nbsp;|&nbsp;</span><span><a href='/bin/oops/Accounting/GratiaUpgradeProcedure?template=oopsmore&amp;param1=12&amp;param2=12' rel='nofollow' title='Delete or rename this topic; set parent topic; view and compare revisions' accesskey='m'><span class='twikiAccessKey'>M</span>ore topic actions</a></span></span></div><!--/patternTopicAction--></div><!--/patternTopicActions--></div><!--/rCTR--><div class="rCBR"><div class="rCBL"></div><!--/rCBL--></div><!--/rCBR--></div><!--/rCRounded--></div><!--/twikinetRounded--><div class="patternInfo twikiGrayText"><div class="patternRevInfo">Topic revision: r12 - 11 Dec 2008 - 18:51:44 - <a href="/bin/view/Main/KyleGross" class="twikiLink">KyleGross</a></div><!-- /patternRevInfo--></div><!-- /patternInfo-->
</div><!-- /patternMainContents-->
</div><!-- /patternMain--><div id="patternLeftBar"><div id="patternClearHeaderLeft"></div>
<div id="patternLeftBarContents">
<head>
	<style type="text/css" media="all">
	
		.float-left {
			float:	left;
		}

		.float-right {
			float:	right;
		}

		.rounded {
      		border-radius:	 		8px;
			-moz-border-radius: 	8px;
			-webkit-border-radius:	8px;		
		}
		
		.rounded-top {
      		border-radius:	 		8px 8px 0px 0px;
			-moz-border-radius: 	8px 8px 0px 0px;
			-webkit-border-radius:	8px 8px 0px 0px;		
		}
		
		.bordered {
			border:	1px solid #AAAAAA;
		}

		.bordered-bottom {
			border-bottom:	1px solid #AAAAAA;
		}

		.high-contrast {
			color:		#FF6600;
			background: #000060;		
		}

                .low-contrast {
			color:		#FF6600;
			background: #ADD8E6;		
		}

	
		.container {
display: inline-block;
			margin:		0;
			padding:	0;
		}
		
		.box {
			display:				block;
			margin:			 0;
			padding:		0;
		}

                #head-block {
                        color:               #FF6600;	
                        background:    #333380;
                }
							
		#menu {
			font-family:	"Lucida Grande", sans-serif;
			font-size:		small;
			margin:		0px 0px 10px 0px;
			padding:	0px 0px 0.3em 0px;
			background: #EAEDF2;
		}
							
		#menul {
			font-family:	"Lucida Grande", sans-serif;
			font-size:		small;
			margin:		0px 0px 10px 0px;
			padding:	0px 0px 0.3em 0px;
			background: #F4F6F9

		}		
		#head {
			margin:		0px;
			padding:	0.2em 5px 0.2em 10px;
			font-size:	normal;
			font-weight:	bold;
			color:			#FF6600;	
		}
		
		#head a {
			text-decoration:	none;
			color:			#FF6600;	
		}

		#head a:hover {
			background: 		#EAEDF2;
			text-decoration:	none;
			color:			#FFBB00;	
		}

		#head a:visited {
			text-decoration:	none;
			color:			#FF6600;	
		}

		#head a:active {
			text-decoration:	none;
			color:			#FF6600;	
		}

		#head a:link {
			text-decoration:	none;
			color:			#FF6600;	
		}

                #iteml {
			padding:	0.1em 5px 0.0em 10px;
                }

		#iteml a {
			background: 		#F4F6F9
			text-decoration:	none;
			color:			#000044;			
		}

		#iteml a:hover {
			background: 		#F4F6F9
			text-decoration:	none;
			color:			#FF6600;			
		}
		#item {
			padding: 0.1em 5px 0.0em 10px;
		}
		
		#item a {
			background: 		#EAEDF2;
			text-decoration:	none;
			color:			#000044;			
		}

		#item a:hover {
			background: 		#EAEDF2;	
			text-decoration:	none;
			color:			#FF6600;			
		}
</style>
</head>
Hello, <a href="/bin/view/Main/TWikiGuest" class="twikiLink">TWikiGuest</a>
<a href="https://twiki.grid.iu.edu/bin/view/TWiki/TWikiRegistration" target="_top"><br/>Register</a>
<p />
<p />
<!-- Google CSE Search Box Ends
<h5><a name="Common_links"></a> Common links </h5> <ul>
<li> <a href="/bin/view/Main/WebHome" class="twikiLink">OSG TWiki home</a>
</li> <li> <a href="/bin/view/Documentation/Release3/WebHome" class="twikiLink">RPM Install guides - OSG 3.0</a>
</li> <li> <a href="/bin/view/ReleaseDocumentation/WebHome" class="twikiLink">Pacman Install guides OSG 1.2</a>
</li> <li> <a href="/bin/view/Documentation/WebHome" class="twikiLink">Technical Documentation</a>
</li> <li> <a href="/bin/view/Documentation/SiteAdminResources" class="twikiLink">Contact Info</a> 
</li> <li> <strong><a href="/bin/view/Main/ICantFindItForm" class="twikiLink">I can't find it!</a></strong>  -->
</li></ul> 
<div class="container">
<div class="box rounded bordered" id="menu">
    <div class="box rounded-top high-contrast" id="head"><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">Accounting</a></div>
    <div id="item"><a href="/bin/view/Accounting/WebHome#Goals" class="twikiCurrentWebHomeLink twikiAnchorLink">Goals</a></div>
    <div id="item"><a href="/bin/view/Accounting/MeetingMinutes" class="twikiLink">Meetings</a></div>
    <div id="item"><a href="http://gratia-osg-prod.opensciencegrid.org/" target="_top">Production Reports</a></div>
    <div id="item"><a href="/bin/view/Accounting/WebHome#Contact_information_and_mailing" class="twikiCurrentWebHomeLink twikiAnchorLink">Contacts</a></div>
</div>
<p />
    <div class="box rounded bordered" id="menu">
        <div class="box rounded-top high-contrast" id="head"><a  style="" href="/bin/view/Main/WebHome" class="twikiLink" title="Home">About the OSG</a></div>
        <div id="item"><a  style="" href="/bin/view/Documentation/UsingTheGrid" class="twikiLink" title="Instructions for Using OSG">New Users</a></div>
        <div id="item"><a href="http://myosg.grid.iu.edu/map?map_attrs_shownr=on&amp;all_sites=on&amp;active=on&amp;active_value=1&amp;disable_value=1&amp;gridtype=on&amp;gridtype_1=on" target="_top">OSG Sites</a></div>
        <div id="item"><a  style="" href="http://myosg.grid.iu.edu/vosummary?all_vos=on&amp;active=on&amp;active_value=1&amp;datasource=summary" target="_top" title="List of Virtual Organizations">OSG VOs</a></div>
        <div id="item"><a href="http://display.grid.iu.edu/" target="_top">OSG Usage Graphs</a></div>
        <div id="item"><a  style="" href="https://indico.fnal.gov/categoryDisplay.py?categId=86" target="_top" title="OSG Event Calendar">Events</a></div>
       <div id="item"><a href="/bin/view/Management/OSGOrganizationInformation" class="twikiLink">OSG Organization</a></div>
<p />
    </div>
<p />
<p />
    <div class="box rounded bordered" id="menu">
        <div class="box rounded-top high-contrast" id="head">OSG at Work</div>
        <div id="item"><a  style="" href="/bin/view/Documentation/WebHome" class="twikiLink" title="Official Documentation Home">Technical Documentation</a></div>
        <div id="item"><a href="/bin/view/Security/WebHome" class="twikiLink">Security</a></div>
        <div id="item"><a href="/bin/view/SoftwareTeam/WebHome" class="twikiLink">Software Team</a></div>
        <div id="item"><a href="/bin/view/Education/WebHome" class="twikiLink">Education</a></div>
        <div id="item"><a href="/bin/view/Management/WebHome" class="twikiLink">Management</a></div>
        <div id="item"><a  style="" href="/bin/view/Management/ScientificPublications" class="twikiLink" title="Scientific Publications and Citing OSG">Scientific Publications</a></div>
        <div id="item"><a href="/bin/view/Management/OSGResearchHighlights" class="twikiLink">Research Highlights</a></div>
    </div>
<p />
<p />
		<div class="box rounded bordered" id="menu">
			<div class="box rounded-top high-contrast" id="head"><a  style="" href="/bin/view/Main/WebHome" class="twikiLink" title="TWiki Main Web">Documentation Links</a></div>
			<div id="item"><a  style="" href="/bin/view/Documentation/Release3/NavContributeDocumentation" class="twikiLink" title="OSG Documentation System Information">How To Write Documents</a></div>
			<div id="item"><a  style="" href="/bin/view/Documentation/DocFormattingRules" class="twikiLink" title="Formatting OSG Documents">Formatting Documents</a></div>
                        <div id="item"><a  style="" href="/bin/view/Accounting/WebTopicCreator" class="twikiLink" title="Create a New TWiki Page"> <img width="16" alt="newtopic" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/newtopic.gif" height="16" border="0" /> Create New Topic</a></div>
                        <div id="item"><a  style="" href="/bin/view/Main/WebList" class="twikiLink" title="List of Webs"> <img width="16" alt="index" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/index.gif" height="16" border="0" /> List of Webs</a></div>
                        <div id="item"><a  style="" href="/bin/view/Accounting/WebIndex" class="twikiLink" title="Index of Topics"> <img width="16" alt="index" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/index.gif" height="16" border="0" /> Topic Index</a></div>
                        <div id="item"><a href="/bin/view/Documentation/WebTopicList" class="twikiLink"> <img width="16" alt="index" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/index.gif" height="16" border="0" /> Topic List</a></div>
                        <div id="item"><a  style="" href="/bin/view/Accounting/WebChanges" class="twikiLink" title="List of Pages that have Changed by Change Date"> <img width="16" alt="changes" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/changes.gif" height="16" border="0" /> Changes</a></div>
                        <div id="item"><a  style="" href="/bin/view/Main/TWikiUsers" class="twikiLink" title="Alphabetized List of TWiki Users"> <img width="16" alt="person" align="top" src="/twiki/pub/TWiki/TWikiDocGraphics/person.gif" height="16" border="0" /> TWiki Users</a></div>
		</div>
<p />
</div>
</div><!-- /patternLeftBarContents--></div><!-- /patternLeftBar-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--></div><!-- /patternWrapper--><div id="patternTopBar"><div id="twikinetLogo"><a href="http://www.twiki.net/"><span>TWIKI.NET</span></a></div><div id="patternTopBarContents"><div class="twikiLeft"><span id="twikiLogo" class="twikiImage"><a href="http://www.opensciencegrid.org    "><img src="/twiki/pub/Main/WebHome/osg-logo.png    " border="0" alt="OpenScience Grid Website    " style="border:none;" /></a></span></div>
<div class="twikiRight">
<table cellpadding="0" cellspacing="0" border="0"><tr><td class="twikinetSearchJump twikinetSearchJumpLeft">
 <ul>
<li> <form name="jumpForm" action="/bin/view/Accounting/GratiaUpgradeProcedure"><input id="jumpFormField" type="text" class="twikiInputField" name="topic" value="" size="16" /><input type="submit" class="twikinetJumpButton" name="submit" value="" /></form>
</li> <li> <form name="quickSearchForm" action="/bin/view/Accounting/WebSearch"><input type="text" class="twikiInputField" id="quickSearchBox" name="search" value="" size="18" /><input type="hidden" name="scope" value="all" /><input type="hidden" name="web" value="Accounting" /><input type="submit" size="5" class="twikinetSearchButton" name="submit" value="" /></form>
</li> <li> </li></ul> 
</td>
<td class="twikinetSearchJumpRight"></td>
</tr></table><br class="twikiClear" /></div></div></div><!-- /patternTopBar--><div id="twikinetTopToolBar"><div id="twikinetTopToolBarContents"><div class="twikinetWebName twikiLeft">
<table cellpadding="0" cellspacing="0" border="0"><tr><td style="vertical-align:middle;">
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Accounting"></a>  <a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">Accounting</a> </span></h2>
</td></tr></table>
</div><!--/twikinetWebName-->
<div class="twikinetToolBar twikiRight">
<table cellpadding="0" cellspacing="0" border="0"><tr><td><a href="https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaUpgradeProcedure?t=1487267877;nowysiwyg=1" rel="nofollow">
<span class="rCRounded"><span class="rCTR"><span class="rCTL"></span><!--/rCTL-->
<span class="twikiLinkLabel twikinetEditIcon"><span class='twikiAccessKey'>E</span>dit</span>
</span><!--/rCTR--><span class="rCBR"><span class="rCBL"></span></span><!--/rCBR--></span><!--/rCRounded-->
</a></td><td><a href="/bin/attach/Accounting/GratiaUpgradeProcedure" rel="nofollow">
<span class="rCRounded"><span class="rCTR"><span class="rCTL"></span><!--/rCTL-->
<span class="twikiLinkLabel"><span class='twikiAccessKey'>A</span>ttach</span>
</span><!--/rCTR--><span class="rCBR"><span class="rCBL"></span></span><!--/rCBR--></span><!--/rCRounded-->
</a></td><td><a href="/bin/genpdf/Accounting/GratiaUpgradeProcedure?pdftitle=GratiaUpgradeProcedure" rel="nofollow">
<span class="rCRounded"><span class="rCTR"><span class="rCTL"></span><!--/rCTL-->
<span class="twikiLinkLabel">PDF</span>
</span><!--/rCTR--><span class="rCBR"><span class="rCBL"></span></span><!--/rCBR--></span><!--/rCRounded-->
</a></td></tr></table>
<br class="twikiClear" /></div><!--/patternToolBar--></div><!--/twikinetTopToolBarContents--></div><!--/twikinetTopToolBar--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>