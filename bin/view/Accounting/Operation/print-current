<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> Operation &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/Operation?_T=16 Feb 2017" type="application/x-wiki" title="edit Operation" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/Operation"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Some_Operational_Tasks"></a> Some Operational Tasks. </h1>
<p />
This pages describes the main operation tasks to be executed by a Collector administrator.
<p />
This documentation assumes that you are connected to <a href="http://yourhostname:yourport/gratia-administration" target="_top">http://yourhostname:yourport/gratia-administration</a>.
<p />
The Gratia administration services provides several options for securing the administrative tasks. The basic system status is available to all users. All other services that allow you configure the system, turn on/off service, perform replication, etc, can be restricted to selected personnel.
<p />
The secured tasks are all shown as dimmed in the menu until you are authorized. When you attempt to access those tasks, you will be redirected to an SSL secured port requiring you to have a certificate in your browser from a trusted CA (Certificate Authority). This initiates the login process. (See the "Administration Login" link for more detail)
<p />
Note that at the bottom left of the page, you can find the version number of the installed Gratia Software and the name of the schema. Once logged-in, this also provide the db host and port.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Starting_and_stopping_the_servic"></a> Starting and stopping the service </span></h2>
<p />
<pre>service TOMCAT_INITD_SERVICE start</pre> <pre>service TOMCAT_INITD_SERVICE stop</pre>
<p />
Note that the correct value of <code>TOMCAT_INITD_SERVICE</code> may be found in the <a href="http://fermigrid.fnal.gov/gratia-production-organization.html" target="_top">list of services operated by Fermigrid</a>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Site_Name_changes"></a> Site Name changes </span></h2>
<p />
As of v1.00, the name recorded in Gratia must match the name recorded in OSG's OIM database.
<p />
The name of Site sometimes need to be updated in the Gratia database. This usually happens for the following 2 reasons. If a new site mis-configures their Gratia Probe, the name recorded for the site to which the Probe belong might be incorrect entered. If a site is renamed in OIM.
<p />
To change the name, select the "Site Table" link. Find the old Site Name in the table, edit the name to enter the new name. Scroll to the bottom of the page and click "Apply".
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Probe_changes"></a> Probe changes </span></h2>
<p />
There are a few things that can changes the name of a Gratia Accounting Probe: <ol>
<li> Change in the name of the hostname of the reporting Gateway <strong>if</strong> using the default naming convention.
</li> <li> Change in default naming convention (<em>On recommendation from the Gratia, VDT modified at least once the naming convention for the PBS/LSF probes</em>).
</li> <li> Intentional deviation from the default by the Site Administrator.
</li></ol> 
<p />
In addition to the change in the name of the Probe, its <strong>_state_</strong> can also change.  In particular, old probes from either a retired Gateway or even a retired Site, need to be marked as 'disabled' in the Gratia database in order for the reporting tools to avoid complaining about the lack of input from those deprecated probes.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Automating_those_Site_and_Probe"></a> Automating those Site and Probe changes. </span></h2>
<p />
Currently, any change in the name or state of the Probes or Sites must be manually reported to the Gratia Services Administrators so that they can reflect this changes via the administration interface.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Change_the_name_use_for_a_VO_in"></a> Change the name use for a VO in the reports. </span></h2>
<p />
To change to which VO is set of records is assign to (from a report perspective), select "VOName Correction"
<p />
The page contains 3 columns:
<p /> <ul>
<li> Reported VOName: The VOName reported by the probe. For probe v0.34 and above this usually contains the FQAN of the certificate used to submit the job. 
</li> <li> Reported ReportableVOName: The 'reportableVoName' reported by the probe. For probe v0.34 and above this usually contains the best guess at what the VO name is. 
</li> <li> Actual VO: The name actually used in the reporting tool as the VO to which the job(s) belongs. 
</li></ul> 
<p />
To change the way a pair "Reported VOName"/"Reported ReportableVOName" is displayed, scan the list for the proper/revelant entry and select a new "VOName" from the drop down list. Then click on "Apply" (at the very bottom of the page).
<p />
The best guess for what is the VO name should be, is done using the following rule:
<p />
If there's no VONameCorrection entry, then if there's a leading / in VOName the default translation is to ReportableVOName, otherwise the default translation is to VOName.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Adding_a_VO_Name_very_rare"></a> Adding a VO Name (very rare) </span></h2>
<p />
If a VOName is not available in the list of VOs, select the "VO Management" link. Scroll to the bottom of the page, edit one of the box with "<New VO Name>" and click on Apply
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Automating_change_in_VO_Name"></a> Automating change in VO Name. </span></h2>
<p />
We will soon sync with OIM ... the information in OIM is a connection between a FQAN and a VO reporting name.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Setting_up_replication"></a> Setting up replication </span></h2>
<p />
Replication is set up on the sender. Select the "Replication" link to manage the replication.
<p />
See the "<a href="http://gratia.opensciencegrid.org:8880/gratia-administration/replication-howto.jsp" target="_top">replication</a>" link under the, "Documentation" heading on the <a href="http://gratia.opensciencegrid.org:8880/gratia-administration" target="_top">service administration</a> page for more details.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Rolling_back_a_release_extremely"></a> Rolling back a release (extremely rare) </span></h2>
<p />
The rolling back procedure depends on whether the release involved any schema upgrade (see release notes for details)
<p />
<h3><a name="Rolling_back_when_no_schema_upgr"></a> Rolling back when no schema upgrade. </h3>
<p />
In this case, the database schema is still compatible with the previous release and rolling up back simply involved re-installing the previous release as normal.
<p />
<h3><a name="Rolling_back_in_the_usual_case"></a> Rolling back in the usual case </h3>
<p />
In this case, the database schema is no longer compatible with the previous release and rolling back involves restoring the previous database from backup.
<p />
The steps are <ul>
<li> Wipe out database (do <strong>not</strong> use "rm -r" as this will leave the entire DB in an unstable state).
</li> <li> Re-install old schema from backups (this includes re-installing previous version of the Collector software)  See the <a href="/bin/view/Accounting/InnodbBackup" class="twikiLink">information on backups</a>
</li> <li> Make sure the gratia/data directory contains history directories and files from the point the new collector was turned off for rollback back to just before the upgrade occurred. Restore missing histories from enstore if necessary,
</li> <li> Re-play the history (see the Gratia administration page, select the System/Administration link and follow the instruction under Disaster Recovery/Replay)
</li></ul> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Installing_and_configuring_the_l"></a> Installing and configuring the latest version of ZRM (extremely rare) </span></h2>
<p />
<p />
<p />
See Documentation at <a href="http://mysqlbackup.zmanda.com/" target="_top">http://mysqlbackup.zmanda.com/</a>
<p />
ZRM v1.2.1 is currently installed on gratia06.
<p />
Obtain and download new versions from <a href="http://www.zmanda.com/download-zrm.php" target="_top">http://www.zmanda.com/download-zrm.php</a> in RPM form. You may need to remove the existing ZRM RPMS with <code>rpm -e</code> first to avoid conflicts
<p />
In the event of a non-optimal upgrade, downgrade by the normal RPM method of either removing the newer RPM before installing the older one; or by adding the <code>--oldpackage</code> option to the rpm upgrade command.
<p />
Location of configuration files: /etc/mysql_zrm/*/mysql-zrm.conf
<p />
Performance info: <pre>mysql-zrm-reporter --show backup-performance-info --destination /test/zrm/</pre>
<p />
Backup 'now':
<p />
<pre>mysql-zrm-scheduler --now --backup-set dailyrun --backup-level 0</pre>
<p />
Get information about the backups:
<p />
<pre>mysql-zrm --action list --backup-set gratia_pcanal</pre>
<p />
Restore:
<p />
<pre>mysql-zrm --verbose --action restore --backup-set itb_innodb --source-directory /test/zrm/itb_innodb/20080214144217/ --tmpdir=/test/tmp</pre>
<p />
where /test/tmp has enough space to hold a copy of the backup files.
<p />
<p />
Changes from the default zrm configuration file:
<pre>
# Request explicitly full backups
backup-level=0
# Select where to write the backup file
destination=/backup/mysqldb/zrm
# Select how many days (D) to keep the backup file
retention-policy=3D
# Request explicit compression
compress=1
# Select which schema to backup (eg):
databases=gratia_qcd
# Select the DB user
user="..."
password="...."
# Select where to send result emails, use an empty string for no emails at all.
mailto="gratia-root@fnal.gov"
# Tell ZRM to compress on-the-fly (v2.0 and above)
compress-mysqldump-onthefly=1

</pre>
</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>Operation</span> <br />    
Topic revision: r12 - 02 Aug 2010 - 19:15:57 - <a href="/bin/view/Main/ChrisGreen" class="twikiLink">ChrisGreen</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />