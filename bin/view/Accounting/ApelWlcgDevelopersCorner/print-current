<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> ApelWlcgDevelopersCorner &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/ApelWlcgDevelopersCorner?_T=16 Feb 2017" type="application/x-wiki" title="edit ApelWlcgDevelopersCorner" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/ApelWlcgDevelopersCorner"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--TABLEPLUGIN_table2--><style type="text/css" media="all">
.tableSortIcon img {padding-left:.3em; vertical-align:text-bottom;}
.twikiTable#table2 th {background-color:#99CCCC;}
.twikiTable#table2 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table2 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table2 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table2 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table2 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--TABLEPLUGIN_table3--><style type="text/css" media="all">
.twikiTable#table3 th {background-color:#99CCCC;}
.twikiTable#table3 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table3 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table3 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table3 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table3 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--EDITTABLEPLUGIN--><style type="text/css" media="all">
@import url("https://twiki.opensciencegrid.org/twiki/pub/TWiki/EditTablePlugin/edittable.css");
</style>

<!--TABLEPLUGIN_table5--><style type="text/css" media="all">
.twikiTable#table5 th {background-color:#99CCCC;}
.twikiTable#table5 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table5 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table5 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table5 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table5 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--TWISTYPLUGIN_TWISTY--><style type="text/css" media="all">
@import url("https://twiki.opensciencegrid.org/twiki/pub/TWiki/TwistyContrib/twist.css");
</style>
<script type='text/javascript' src='https://twiki.opensciencegrid.org/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js'></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikiPref.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TwistyContrib/twist.compressed.js"></script>
<script type="text/javascript">
// <![CDATA[
var styleText = '<style type="text/css" media="all">.twikiMakeVisible{display:inline;}.twikiMakeVisibleInline{display:inline;}.twikiMakeVisibleBlock{display:block;}.twikiMakeHidden{display:none;}</style>';
document.write(styleText);
// ]]>
</script>

<!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<!--TABLEPLUGIN_table6--><style type="text/css" media="all">
.twikiTable#table6 th {background-color:#99CCCC;}
.twikiTable#table6 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table6 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table6 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table6 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table6 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--TABLEPLUGIN_table4--><style type="text/css" media="all">
.twikiTable#table4 th {background-color:#99CCCC;}
.twikiTable#table4 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table4 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table4 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table4 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table4 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style></head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <!-- <ul>
<li> Set LCG_CONF        = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>
</li> <li> Set LCG_DB_CONF = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_db_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg-db.conf</a>
</li> <li> Set CRONTAB          = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>
</li> <li> Set REPORTABLE_SITES = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a>
</li> <li> Set REPORTABLE_SITES_HISTORY = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterHistory_lcg_reportable" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterHistory</a>
</li> <li> Set REPORTABLE_VOS = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#VOFilterFile_lcg_reportableVOs" class="twikiCurrentTopicLink twikiAnchorLink">VOFilterFile</a>
</li> <li> Set INTEROP_ACCOUNTING = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InteropAccounting_py" class="twikiCurrentTopicLink twikiAnchorLink">InteropAccounting class</a>
</li> <li> Set DOWNTIMES                    = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#DownTimes_py" class="twikiCurrentTopicLink twikiAnchorLink">Downtimes class</a>
</li> <li> Set INACTIVE_RESOURCES  = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InactiveResources_py" class="twikiCurrentTopicLink twikiAnchorLink">InactiveResources class</a>
</li> <li> Set SSMINTERFACE               = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SSMInterface_py" class="twikiCurrentTopicLink twikiAnchorLink">SSMInterface class</a>
</li> <li> Set REBUS_CLASS                = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#Rebus_py" class="twikiCurrentTopicLink twikiAnchorLink">Rebus class</a>
</li> <li> Set REBUS_TOPOLOGY        = <a href="http://gstat-wlcg.cern.ch/apps/topology/" target="_top">Rebus topology</a>
</li> <li> Set SSM_PROTOCOL            = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SSM" class="twikiCurrentTopicLink twikiAnchorLink">SSM protocol</a>
</li> <li> Set SSM_CFG          = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#ssm_cfg" class="twikiCurrentTopicLink twikiAnchorLink">ssm.cfg</a>
</li> <li> Set SSM_LOG_CFG = <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#ssm_log_cfg" class="twikiCurrentTopicLink twikiAnchorLink">ssm.log.cfg</a>
</li> <li> Set SCRIPT_LOCATION  = <em>/usr/share/gratia-apel</em>
</li> <li> Set CONFIG_LOCATION = <em>/etc/gratia-apel</em>
</li> <li> Set CRONTAB_LOCATION = <em>/etc/cron.d</em>
</li> <li> Set SERVICES_LOCATION = <em>/etc/init.d</em>
</li> <li> Set MYOSG                         = <a href="http://myosg.grid.iu.edu" target="_top">MyOsg/OIM</a>
</li> <li> Set EGI_PORTAL                =  <a href="http://accounting.egi.eu/tier2.php" target="_top">EGI Accounting Portal</a>
</li> <li> Set GRATIA_APEL_URL      =  <a href="http://gr13x6.fnal.gov:8319/gratia-apel/" target="_top">Gratia-APEL WLCG Interface web</a> (this can change depending on where the interface is being run)
</li> <li> Set GRATIAWEB_WLCG     =  <a href="http://gratiaweb.grid.iu.edu/gratia/wlcg_reporting" target="_top">Gratiaweb WLCG reporting page</a>
</li> <li> Set APEL_TEST_SUMMARY_URL   =  <a href="http://goc-accounting.grid-support.ac.uk/apeltest/summaries.html" target="_top">Test APEL:Sites with data in the raptest Summaries table page</a>
</li> <li> Set APEL_PROD_SUMMARY_URL   =  <a href="http://goc-accounting.grid-support.ac.uk/apel/summaries.html" target="_top">Production APEL: Sites with data in the rap Summaries table page</a>
</li></ul> 
-->
<p />
<p />
<h1><a name="APEL_WLCG_Interface_Developers_C"></a>  APEL/WLCG Interface Developers Corner </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Developers_Corner"> Developers Corner</a>
</li> <li> <a href="?cover=print#Scripts"> Scripts</a> <ul>
<li> <a href="?cover=print#LCG_py"> LCG.py</a> <ul>
<li> <a href="?cover=print#Basic_functionality"> Basic functionality</a>
</li> <li> <a href="?cover=print#Additional_functionality"> Additional functionality</a>
</li> <li> <a href="?cover=print#Usage"> Usage</a>
</li></ul> 
</li> <li> <a href="?cover=print#DownTimes_py"> DownTimes.py</a>
</li> <li> <a href="?cover=print#InactiveResources_py"> InactiveResources.py</a>
</li> <li> <a href="?cover=print#InteropAccounting_py"> InteropAccounting.py</a>
</li> <li> <a href="?cover=print#Rebus_py"> Rebus.py</a>
</li> <li> <a href="?cover=print#SSMInterface_py"> SSMInterface.py</a>
</li> <li> <a href="?cover=print#create_apel_index_sh"> create-apel-index.sh</a>
</li></ul> 
</li> <li> <a href="?cover=print#Configuration_files"> Configuration files</a> <ul>
<li> <a href="?cover=print#Configuration_lcg_conf"> Configuration (lcg.conf)</a>
</li> <li> <a href="?cover=print#SiteFilterFile_lcg_reportableSit"> SiteFilterFile (lcg-reportableSites)</a> <ul>
<li> <a href="?cover=print#SiteFilterHistory_lcg_reportable"> SiteFilterHistory (lcg-reportableSites.history files)</a>
</li></ul> 
</li> <li> <a href="?cover=print#VOFilterFile_lcg_reportableVOs"> VOFilterFile (lcg-reportableVOs)</a>
</li> <li> <a href="?cover=print#DBConfFile_lcg_db_conf"> DBConfFile (lcg-db.conf)</a>
</li> <li> <a href="?cover=print#SSM_Configuration_files"> SSM Configuration files</a> <ul>
<li> <a href="?cover=print#ssm_cfg"> ssm.cfg</a>
</li> <li> <a href="?cover=print#ssm_log_cfg"> ssm.log.cfg</a>
</li></ul> 
</li></ul> 
</li> <li> <a href="?cover=print#Crontab"> Crontab</a>
</li> <li> <a href="?cover=print#Troubleshooting"> Troubleshooting</a> <ul>
<li> <a href="?cover=print#Certificate_issues_test_vs_produ"> Certificate issues (test vs production)</a>
</li></ul> 
</li> <li> <a href="?cover=print#SSM"> SSM</a> <ul>
<li> <a href="?cover=print#SSM_Installation"> SSM Installation</a> <ul>
<li> <a href="?cover=print#Prerequisites"> Prerequisites</a>
</li> <li> <a href="?cover=print#Installing_SSM"> Installing SSM</a>
</li></ul> 
</li> <li> <a href="?cover=print#Configuration_files_AN1"> Configuration files</a>
</li> <li> <a href="?cover=print#Running_the_SSM"> Running the SSM</a>
</li> <li> <a href="?cover=print#Testing_the_SSM_interface"> Testing the SSM interface</a>
</li> <li> <a href="?cover=print#Log_file_var_log_apel_ssm_log"> Log file (/var/log/apel/ssm.log)</a>
</li></ul> 
</li> <li> <a href="?cover=print#Major_updates"> Major updates</a>
</li></ul> 
</div>
<p />
<p />
<p />
<p />
<h1><a name="Developers_Corner"></a> Developers Corner </h1>
This document  describes the scripts and configuration files used by this interface.
<p />
File Locations: <ul>
<li> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#scripts" class="twikiCurrentTopicLink twikiAnchorLink">scripts</a>: <em>/usr/share/gratia-apel</em>
</li> <li> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#Configuration_files" class="twikiCurrentTopicLink twikiAnchorLink">configuration files</a>: <em>/etc/gratia-apel</em>
</li> <li> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#Crontab" class="twikiCurrentTopicLink twikiAnchorLink">crontab files</a>: <em>/etc/cron.d</em>
</li> <li> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#initd_services" class="twikiCurrentTopicLink twikiAnchorLink">initd files</a>: <em>/etc/init.d</em>
</li></ul> 
<p />
<a name="script_location"/>
<h1><a name="Scripts"></a> Scripts </h1>
All the executable scripts in this section can be found in the <em>/usr/share/gratia-apel</em>  directory.
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="LCG_py"></a> LCG.py </span></h2>
<h3><a name="Basic_functionality"></a> Basic functionality </h3>
This is the main interface program performing the following basic functions to collect the accounting data and send it to APEL:
<p />
 1. This is a very critical step.  The very first thing that has to be done is to zero all the updates from the previous successful run.  The reason for this is that Gratia has a couple of "correction" type filters built in, such as, a VO Name correction and probe/site relationship,  From one day to the next, adjustments can be made in these areas affecting the data being sent up.   Therefore, what was reported yesterday, may not be the same as what would be reported today if any of these adjustments occur.  Since the only method of maintaining the APEL data is via updates, i.e., incremental ones.   So, this module creates a "delete" file for each set of daily updates made.  This must be processed first.  If this update fails, the module is terminated.   <br />    <br />     Prior to migrating to the SSM protocol,  direct access to the APEL database was available and we were able to a SQL delete by resource group which was much simpler.
<p />
 2. Retrieves the accounting data from the Gratia database for selected OSG sites and VOs for a month. <ul>
<li> Access to the Gratia database is defined in the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_db_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg-db.conf</a> file,
</li> <li> The <strong><em>resource</em></strong> <strong><em>groups</em></strong> (and Normalization Factors) are defined in a file identified by the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a> attribute of the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>  file.
</li> <li> VOs are defined in a file identified by the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#VOFilterFile_lcg_reportableVOs" class="twikiCurrentTopicLink twikiAnchorLink">VOFilterFile</a> attribute of the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>  file.
</li> <li> For each <strong><em>resource</em></strong> <strong><em>group</em></strong> in the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a> attribute and for the VOs defined in the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#VOFilterFile_lcg_reportableVOs" class="twikiCurrentTopicLink twikiAnchorLink">VOFilterFile</a> atttibute, a query is made in Gratia for each of the <strong><em>resources</em></strong>  with WLCG Information InteropAccounting flag set to True (using the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InteropAccounting_py" class="twikiCurrentTopicLink twikiAnchorLink">InteropAccounting class</a>) <br />     
</li></ul> 
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner1show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show query using AGLT2 as an example.</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner1hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner1toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0"><blockquote><pre>
SELECT "AGLT2"                  as Site,
   VOName                          as "Group",
   min(UNIX_TIMESTAMP(EndTime))    as EarliestEndTime,
   max(UNIX_TIMESTAMP(EndTime))    as LatestEndTime,
   "07"                     as Month,
   "2013"                      as Year,
   IF(DistinguishedName NOT IN ("", "Unknown"),IF(INSTR(DistinguishedName,":/") &gt; 0,LEFT(DistinguishedName,INSTR(DistinguishedName,":/")-1), DistinguishedName),CommonName) as GlobalUserName,
   Round(Sum(WallDuration)/3600)                        as WallDuration,
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600)   as CpuDuration,
   Round((Sum(WallDuration)/3600) * 8.72 )            as NormalisedWallDuration,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600) * 8.72) as NormalisedCpuDuration,
   Sum(NJobs) as NumberOfJobs
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName in ("AGLT2","AGLT2_CE_2","AGLT2_SL6")
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.VOName in ( "alice","usatlas","atlas","uscms","cms" )
  and  "2013-07-01 00:00:00" &lt;= Main.EndTime and Main.EndTime &lt; "2013-08-01 00:00:00"
  and Main.ResourceType = "Batch"
group by Site,
         VOName,
         Month,
         Year,
         GlobalUserName
</pre></blockquote>
</div></div> <!--/twistyPlugin--> <br />     <ul>
<li> In order to reduce the verbage in the log file, only the first query is output to the log file.  The <strong><em>resources</em></strong> and normalization factor used is displayed for the other <strong><em>resource</em></strong> <strong><em>group</em></strong> queries.
</li></ul> 
<p />
3. For each <strong><em>resource</em></strong> <strong><em>group</em></strong> then, an SSM update message is created for the current monthly values. as defined by the <em>UpdatesDir</em> and <em>UpdateFileName</em> attributes of <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>.   A matching update file designed to remove the updates (as noted above in #1) is also created for processing first in the next iteration of this interface using the <em>DeleteFileName</em> attribute of <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner2show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show UpdatesDir Files</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner2hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner2toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
<b><u>/var/lib/gratia-apel/apel-updates</b></u>
-rw-rw-r-- 1 root root 180732 Jul  8 00:15 2013-06.ssm-deletes.txt
-rw-rw-r-- 1 root root 189072 Jul  8 00:15 2013-06.ssm-updates.txt
-rw-rw-r-- 1 root root 155920 Jul 16 01:15 2013-07.ssm-deletes.txt
-rw-rw-r-- 1 root root 162184 Jul 16 01:15 2013-07.ssm-updates.txt

<b><u>2013-07.ssm-updates.txt</b></u>
APEL-summary-job-message: v0.2
Site: AGLT2
Group: atlas
EarliestEndTime: 1372654800
LatestEndTime: 1373605200
Month: 07
Year: 2013
GlobalUserName: /DC=com/..... CN=somebody1
CpuDuration: 0
NormalisedWallDuration: 116
NormalisedCpuDuration: 2
NumberOfJobs: 559
%%
Site: AGLT2
Group: atlas
EarliestEndTime: 1372654800
LatestEndTime: 1373950800
Month: 07
Year: 2013
GlobalUserName: /DC=com/..... CN=somebody2
WallDuration: 1
CpuDuration: 0
NormalisedWallDuration: 6
NormalisedCpuDuration: 0
NumberOfJobs: 4115
%%

<b><u>2013-07.ssm-deletes.txt</b></u>
APEL-summary-job-message: v0.2
Site: AGLT2
Group: atlas
EarliestEndTime: 1372654800
LatestEndTime: 1373605200
Month: 07
Year: 2013
GlobalUserName: /DC=com/..... CN=somebody1
WallDuration: 0
CpuDuration: 0
NormalisedWallDuration: 0
NormalisedCpuDuration: 0
NumberOfJobs: 0
%%
Site: AGLT2
Group: atlas
EarliestEndTime: 1372654800
LatestEndTime: 1373950800
Month: 07
Year: 2013
GlobalUserName: /DC=com/..... CN=somebody2
WallDuration: 0
CpuDuration: 0
NormalisedWallDuration: 0
NormalisedCpuDuration: 0
NumberOfJobs: 0
%%
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
4. Log files are created in the directory specified by the <em>LogDir</em>  attribute of the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>. The format of the log files is YYYY-MM.log.  These show enough detail to determine any problems that might occur.<br />    <br />    
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="Additional_functionality"></a> Additional functionality </h3>
In addition, these tasks are performed as a means of proactively validating Gratia, OIM and APEL/EGI/WLCG data.
<p />
1. Verification that all <strong><em>resources</em></strong> within a <strong><em>resource_group</em></strong> are reporting to Gratia.
<p />
Since there is no critical RSV probe for individual <strong><em>resources</em></strong> (aka Gratia site) not reporting to Gratia, the script runs a separate query for each <strong><em>resource</em></strong> of the <strong><em>resource groups</em></strong> using the same <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InteropAccounting_py" class="twikiCurrentTopicLink twikiAnchorLink">InteropAccounting class</a> as the main query.  This query ignores VO and is looking for days in the month when no data has been reported to Gratia.
<p />
Non-reporting days can be the result of a resource being down for maintenance, therefore a check is made against <a href="http://myosg.grid.iu.edu" target="_top">MyOsg/OIM</a> for scheduled downtime using: <ul>
<li> the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#DownTimes_py" class="twikiCurrentTopicLink twikiAnchorLink">Downtimes class</a>
</li> <li> the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InactiveResources_py" class="twikiCurrentTopicLink twikiAnchorLink">InactiveResources class</a> since, as a convenience to administrators, in lieu of scheduling downtime when a <strong><em>resource</em></strong> is not available for an extended period.
</li> <li> additionally, in order to not overreact to what might be a a short term Gratia reporting problem, there is a <em>MissingDataDays</em> attribute in the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a> file that functions as a threshold before warning messages are generated.
</li></ul> 
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner3show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show messages</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner3hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner3toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0"> <ul>
<li> Resource: %(resource)s in Resource Group %(rg)s  missing data for more than 2 days:  ['2013-07-11', '2013-07-13', '2013-07-14', '2013-07-15']
</li></ul> 
</div></div> <!--/twistyPlugin-->
<p />
2. Verification that <a href="http://myosg.grid.iu.edu" target="_top">MyOsg/OIM</a> <em>WLCGInformation</em> is consistent with the WLCG <a href="http://gstat-wlcg.cern.ch/apps/topology/" target="_top">Rebus topology</a>
<p />
Using the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#Rebus_py" class="twikiCurrentTopicLink twikiAnchorLink">Rebus class</a> and <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#InteropAccounting_py" class="twikiCurrentTopicLink twikiAnchorLink">InteropAccounting class</a>, a verification is made to insure that OSG <strong><em>resource groups</em></strong> being reported do indeed have an approved MOU and have been registered correctly in the <a href="http://gstat-wlcg.cern.ch/apps/topology/" target="_top">Rebus topology</a>.  If inconsistencies are found, then an email message is generated indicating the problem.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner4show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show messages</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner4hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner4toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0"> <ul>
<li> The WLCG REBUS topology was not accessible today. We are using a previous days data for validations.
</li> <li> The WLCG REBUS topology was not accessible today and there is not previous days cvs file to use. We cannot provide the correct data for OSG WLCG reporting. No updates today.
</li> <li> Resource group (%s) MyOsg AccountingName (%s) does NOT match the REBUS Accounting Name (%s)
</li> <li> Resource group (%s) is being reported and is registered in <span class="twikiNewLink">MyOSG<a href="/bin/edit/Accounting/MyOSG?topicparent=Accounting.ApelWlcgDevelopersCorner" rel="nofollow" title="MyOSG (this topic does not yet exist; you can create it)">?</a></span>/OIM and has resources (%s) with the InteropAccounting flag set in MyOsg
</li> <li> Resource group (%s) is being reported and has resources (%s) with the InteropAccounting flag set in MyOsg
</li> <li> Resource group (%s) is being reported  BUT has NO resources with the InteropAccounting flag set in MyOsg
</li> <li> Resource group (%(rg)s) is NOT being reported BUT HAS resources (%(resources)s) with the InteropAccounting flag set in MyOsg but IS registered in REBUS as %s
</li> <li> Resource group (%(rg)s) is NOT being reported BUT HAS resources (%(resources)s) with the InteropAccounting flag set in MyOsg and is NOT registered in REBUS
</li></ul> 
</div></div> <!--/twistyPlugin-->
<p />
3. With each execution, the module will copy the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a> file to a <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterHistory_lcg_reportable" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterHistory</a> directory defined in <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#lcg_conf" class="twikiCurrentTopicLink twikiAnchorLink">lcg.conf</a>.  The is required in the the event a previous month's accounting data must be sent as the reportable <strong><em>resource groups</em></strong> and normalization factors change over time.  There is no place to record these changes other than here.<br />     <b>Note:  It is important that these files get saved in some form of repository, e.g. svn, git, so that they are not lost. A message is generated at the beginning of each month as a reminder.</b> 
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner5show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show messages</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner5hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner5toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0"> <ul>
<li> The %s files should be checked to see if any updates should be made to SVN/CVS in order to retain their history.
</li></ul> 
</div></div> <!--/twistyPlugin-->
<p />
4. After a successful data transfer to APEL, a set of files (html/dat) are created  to provide visibility into the data being sent.  No functionality is contained in this script to use these files.  This just makes them available.  
<p />
Its initial purpose was to make it easier to view the data sent to APEL/EGI without having to look at the individual data files on the node it runs on. APEL provides no visibility and the data in EGI has roughly a 1 day delay. 
<p />
Then, some time ago, it became the data source for some of the data on the <a href="http://gratiaweb.grid.iu.edu/gratia/wlcg_reporting" target="_top">Gratiaweb WLCG reporting page</a> reporting page . The .dat files in this directory are used for that purpose. The <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#create_apel_index_sh" class="twikiCurrentTopicLink twikiAnchorLink">create-apel-index.sh</a> script creates the <em>index.html</em> for <a href="http://gr13x6.fnal.gov:8319/gratia-apel/" target="_top">Gratia-APEL WLCG Interface web</a> (this can change depending on where the interface is being run).
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="Usage"></a> Usage </h3>
The module has been design to do everything EXCEPT update the APEL database unless the --update option is used.  This prevents accidental running of the script and is especially useful when testing changes.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner6show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show usage</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner6hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner6toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
LCG.py   --conf=config_file --date=month [--update] [--no-email]

     --conf - specifies the main configuration file to be used
              which would normally be the lcg.conf file

     --date - specifies the monthly time period to be updated:
              Valid values:
                current  - the current month
                previous - the previous month
                YYYY/MM  - any year and month
    
              The 'current' and 'previous' values are to facillitate running
              this as a cron script.  Generally, we will run a cron
              entry for the 'previous' month for n days into the current
              month in order to insure all reporting has been completed.
    
     The following 2 options are to facilitate testing and to avoid
     accidental running and sending of the SSM message to APEL.

     --update - this option says to go ahead and update the APEL/WLCG database.
                If this option is NOT specified, then everything is executed
                EXCEPT the actual sending of the SSM message to APEL.
                The message file will be created.
                This is a required option when running in production mode.
                Its purpose is to avoid accidentally sending data to APEL
                when testing.

     --no-email - this option says to turn off the sending of email
                notifications on failures and successful completions.
                This is very useful when testing changes.

</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<p />
<p />
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="DownTimes_py"></a> DownTimes.py </span></h2>
Class used to query <a href="http://myosg.grid.iu.edu" target="_top">MyOsg/OIM</a> for planned downtime for a site/resource.
<p />
The LCG.py module does a check for <strong><em>resource groups</em></strong> that have not reported any data to Gratia for each day in the month and will report this in a warning email so corrective action can be initiated.  In order to avoid a "false" reporting of this in the event this was a planned/scheduled shutdown,.
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner7show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show MyOsg/OIM criteria</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner7hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner7toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
Information to display: Downtime Information
Show Past Downtime for: All
         The reason for requesting "All" is that it is based on End Time
         in which case the "past.." ones will not show resource groups
         currently down.
Resource Groups to display: All Resource Groups
For Resource Group: Grid type OSG
For Resource: Provides following Services - Grid Service/CE
Active Status: active
</pre></blockquote>
<a href="http://myosg.grid.iu.edu/rgdowntime/?datasource=downtime&amp;summary_attrs_showgipstatus=on&amp;summary_attrs_showwlcg=on&amp;summary_attrs_showservice=on&amp;summary_attrs_showrsvstatus=on&amp;summary_attrs_showfqdn=on&amp;summary_attrs_showenv=on&amp;summary_attrs_showcontact=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=90&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;bdiitree_type=total_jobs&amp;bdii_object=service&amp;bdii_server=is-osg&amp;start_type=7daysago&amp;start_date=08%2F03%2F2011&amp;end_type=now&amp;end_date=08%2F03%2F2011&amp;all_resources=on&amp;gridtype=on&amp;gridtype_1=on&amp;service=on&amp;service_1=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active=on&amp;active_value=1&amp;disable_value=1" target="_top">MyOSG Query</a>
 - 
<a href="http://myosg.grid.iu.edu/rgdowntime/xml?datasource=downtime&amp;summary_attrs_showgipstatus=on&amp;summary_attrs_showwlcg=on&amp;summary_attrs_showservice=on&amp;summary_attrs_showrsvstatus=on&amp;summary_attrs_showfqdn=on&amp;summary_attrs_showenv=on&amp;summary_attrs_showcontact=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=90&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;bdiitree_type=total_jobs&amp;bdii_object=service&amp;bdii_server=is-osg&amp;start_type=7daysago&amp;start_date=08%2F03%2F2011&amp;end_type=now&amp;end_date=08%2F03%2F2011&amp;all_resources=on&amp;gridtype=on&amp;gridtype_1=on&amp;service=on&amp;service_1=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active=on&amp;active_value=1&amp;disable_value=1" target="_top">MyOSG XML Query</a>
<p />
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner8show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show methods</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner8hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner8toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
 def site_is_shutdown(self,site,date,service):
    """ For a site/date(YYYY-MM-DD)/service determine if this is a
        planned shutdown.
        Returns:  Boolean
    """
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="InactiveResources_py"></a> InactiveResources.py </span></h2>
Class used to query MyOSG for sites/resources that have been marked as <I>inactive</i>.
<p />
As an alternative to updating MyOSG for planned downtime, an admin can also mark a <strong><em>resource</em></strong> as <strong>inactive</strong>.  So when the LCG.py is checking for a <strong><em>resource</em></strong> not reporting to Gratia, it must also check for those marked <em>inactive/disabled</em>   If the <strong><em>resource group</em></strong> is marked as <em>Disabled</em> , it is assumed all <strong><em>resources</em></strong> within that group are <em>inactive</em> .
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner9show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show MyOsg/OIM criteria</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner9hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner9toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
Information to display: Resource Group Summary
For Resource: Show services
Resource Groups to display: All resource groups
For Resource Group: Grid Type - OSG
For Resource: Provides the following services - Grid Services / CE
</pre></blockquote>
<p />
<a href="http://myosg.grid.iu.edu/rgsummary/?datasource=summary&amp;summary_attrs_showservice=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=all&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;bdiitree_type=total_jobs&amp;bdii_object=service&amp;bdii_server=is-osg&amp;start_type=7daysago&amp;start_date=08%2F03%2F2011&amp;end_type=now&amp;end_date=08%2F03%2F2011&amp;all_resources=on&amp;gridtype=on&amp;gridtype_1=on&amp;service=on&amp;service_1=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active_value=0&amp;disable_value=1" target="_top">MyOSG Query</a>
 - 
<a href="http://myosg.grid.iu.edu/rgsummary/xml?datasource=summary&amp;summary_attrs_showservice=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=all&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;bdiitree_type=total_jobs&amp;bdii_object=service&amp;bdii_server=is-osg&amp;start_type=7daysago&amp;start_date=08%2F03%2F2011&amp;end_type=now&amp;end_date=08%2F03%2F2011&amp;all_resources=on&amp;gridtype=on&amp;gridtype_1=on&amp;service=on&amp;service_1=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active_value=0&amp;disable_value=1" target="_top">MyOSG XML Query</a>
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner10show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show methods</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner10hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner10toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
Methods used:
<blockquote><pre>
  def resource_is_inactive(self,resource):
    """ For a resource/date(YYYY-MM-DD)/service determine if this is a
        planned shutdown.
        Returns:  Boolean
    """
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="InteropAccounting_py"></a> InteropAccounting.py </span></h2>
Class used to query MyOSG for <strong><em>resource groups</em></strong> with <strong><em>resources</em></strong> having  the WLCGInformation InteropAccounting flag set to True indicating that this <strong><em>resource group</em></strong> should be interfaced to APEL/WLCG.  It is also used to determine the specific <strong><em>resources</em></strong> with the  <strong><em>resource group</em></strong> for which accounting data is to be collected.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner11show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show MyOsg/OIM criteria</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner11hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner11toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
 For Resource: Show WLCG Informatinon
                         Show services
                         Show FQDN / Aliases
For Resource Group: Grid Type - OSG
</pre></blockquote>
<p />
<a href="http://myosg.grid.iu.edu/rgsummary/?datasource=summary&amp;summary_attrs_showwlcg=on&amp;summary_attrs_showservice=on&amp;summary_attrs_showfqdn=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;start_type=7daysago&amp;start_date=03%2F20%2F2009&amp;end_type=now&amp;end_date=03%2F27%2F2009&amp;all_resources=on&amp;facility_10009=on&amp;site_10026=on&amp;gridtype=on&amp;gridtype_1=on&amp;service_1=on&amp;service_5=on&amp;service_2=on&amp;service_3=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active_value=1&amp;disable_value=1" target="_top">MyOSG Query</a>
 - 
<a href="http://myosg.grid.iu.edu/rgsummary/xml?datasource=summary&amp;summary_attrs_showwlcg=on&amp;summary_attrs_showservice=on&amp;summary_attrs_showfqdn=on&amp;gip_status_attrs_showtestresults=on&amp;downtime_attrs_showpast=&amp;account_type=cumulative_hours&amp;ce_account_type=gip_vo&amp;se_account_type=vo_transfer_volume&amp;start_type=7daysago&amp;start_date=03%2F20%2F2009&amp;end_type=now&amp;end_date=03%2F27%2F2009&amp;all_resources=on&amp;facility_10009=on&amp;site_10026=on&amp;gridtype=on&amp;gridtype_1=on&amp;service_1=on&amp;service_5=on&amp;service_2=on&amp;service_3=on&amp;service_central_value=0&amp;service_hidden_value=0&amp;active_value=1&amp;disable_value=1" target="_top">MyOSG XML Query</a>
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner12show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show methods</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner12hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner12toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
  def isRegistered(self,resource_grp):
    """ Returns True if the resource group is defined in MyOsg. """

  def interfacedResources(self,resource_group):
    """
       Returns a python list of MyOsg resources for the resource group specified
        with the InteropAccounting flag set to True.
    """

  def interfacedResourceGroups(self):
    """
       Returns a python list of MyOsg resource groups with the InteropAccounting
       flag set to True.
    """

  def WLCGAcountingName(self,resource_grp):
    """ Returns the WLCGInformation Accounting Name for a resource group.
        If not interfaced to WLCG, then returns the None value.
        Since the WLCGInformation is at the resource level and there may be
        multiple resources for a resource group, the 1st resource that is
        interfaced will be used and hopefully it is correct.
    """
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner13show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show command line usage</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner13hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner13toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
./InteropAccounting.py action
    Actions:
    --show
        Displays MyOsg resource WLCG InteropAccounting and AccountingName data
        for all resouce groups with at least 1 InteropAccounting set to True.
    --is-interfaced=resource_group
        Displays the WLCG InteropAccounting option and AccountingName for the
        resource group specified.
    --interfaced-resource-groups
        Using the interfacedResourceGroups() API, returns a sorted list of the
        resource groups with the InteropAccounting set to True
    --resources=resource_group
        Using the interfacedResources(resource_group) API, returns a sorted list
        of the resources for a specified resource group with the
        Interopaccounting set to True.
    --is-registered=resource_group
        Using the isMyOsgResourceGroup(resource_group) API, returns True if
        the resource group specified is registered in MyOsg
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Rebus_py"></a> Rebus.py </span></h2>
This class is used to perform validation  of <a href="http://myosg.grid.iu.edu" target="_top">MyOsg/OIM</a> <em>WLCGInformation</em> data versus the <a href="http://gstat-wlcg.cern.ch/apps/topology/" target="_top">Rebus topology</a>. 
If they are <strong><em>not</em></strong> in sync then the Gratia accounting data sent to APEL will never be forwarded to the <a href="http://accounting.egi.eu/tier2.php" target="_top">EGI Accounting Portal</a> which is
used for MOU reporting. The table below shows the mapping of Rebus and MyOsg/OIM terminology.
<p />
<p />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table1" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=0;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Rebus</font></a> </th>
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol1 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=1;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">MyOsg/OIM</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> Federation Accounting Name </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> WLCGInformation/AccountingName </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> Site(s) </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> resource group </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
If a WLCG <strong><em>site</em></strong> (OSG <strong><em>resource group</em></strong> ) registers with WLCG and 
OSG does not indicate it should be interfaced (and visa versa), then we need to take action.
<p />
This class retrieves the latest WLCG <a href="http://gstat-wlcg.cern.ch/apps/topology/" target="_top">Rebus topology</a> csv file (wget <a href="http://wlcg-rebus.cern.ch/apps/topology/all/csv" target="_top">http://wlcg-rebus.cern.ch/apps/topology/all/csv</a>) 
and  provides various methods for viewing/using the data.
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner14show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show methods</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner14hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner14toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
Methods used:
<blockquote><pre>
  def isRegistered(self,site):
    """ Returns Trues if a resource group/site is registered in the WLCG."""

  def accountingName(self,site):
    """ Returns the WLCG REBUS Federation Accounting Name for a 
        registered resource group/site.
        If not registered, it will return an empty string.
    """
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner15show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show command line usage</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner15hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner15toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
Usage: Rebus.py  action [-help]

  Provides visibility into the WLCG Rebus topology for use in the
  Gratia/APEL/WLCG interface.     

  Actions:
    --show all | accountingnames | sites
        Displays the Rebus topology for the criteria specified 
    --is-registered SITE
        Shows information for a site registered in WLCG REBUS topology
    --is-available
        Shows status of query against Rebus url.
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SSMInterface_py"></a> SSMInterface.py </span></h2>
This class is used to send the accounting to APEL via the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SSM" class="twikiCurrentTopicLink twikiAnchorLink">SSM protocol</a> .  
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner16show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show methods</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner16hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner16toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
  def show_outgoing(self):
    """Display files in the SSM outgoing messages directory."""

  def send_file(self,file):
    """Copies a file to the SSM outgoing directory and invokes the
       send_outgoing method.
    """

  def send_outgoing(self):
    """Invokes the SSM client process which sends all files in the
       outgoing directory to APEL.
    """

  def send_outgoing(self):
    """Invokes the SSM client process which sends all files in the
       outgoing directory to APEL.  It then verifies that all files
       have been sent, i.e., there are no files left in the outgoing
       directory.  A 2 minute timeout is used in the event the 
       interface hangs.  Since the SSM client runs as a daemon,
       the client is killed on termination of this process.
    """
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner17show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show command line usage</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner17hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner17toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
Usage: SSMInterface.py  --config <SSM config file> Actions [-help]

  Provides visibility into SSM interface information.

  Note: You must have the SSM_HOME environmental variable set.

  --config <SSM config file>
    This is the SSM configuration file used by the interface.

  Actions:
    --show-outgoing
        Displays the outgoing SSM messages directory contents.
    --send-outgoing
        Sends any outgoing SSM messages directory contents.
    --send-file FILE
        Copies the specified FILE to the SSM outgoing directory and sends it.

</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="create_apel_index_sh"></a> create-apel-index.sh </span></h2>
Shell script that creates the index.html for <a href="http://gr13x6.fnal.gov:8319/gratia-apel/" target="_top">Gratia-APEL WLCG Interface web</a> (this can change depending on where the interface is being run) . This includes a description of what the interface is/does/shows.  
<p />
Its initial purpose was to make it easier to view the data sent to APEL/EGI without having to look at the individual data files on the node it runs on.  APEL provides no visibility and the data in EGI has roughly a 1 day delay.
<p />
Then, some time ago, it became the data source for some of the data on the <a href="http://gratiaweb.grid.iu.edu/gratia/wlcg_reporting" target="_top">Gratiaweb WLCG reporting page</a> .  The <em>.dat</em> files in this directory are used for that purpose.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner18show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show command line usage</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner18hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner18toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
Usage: create-apel-index.sh CONFIG_FILE 

      CONFIG_FILE: This is the configuration file (normally lcg.conf)
                   used by the lcg.sh script.

This script will create an index.html file in the WebLocation attribute
directory specified in the CONFIG_FILE specified on the command line.

The files in this directory are generated by the Gratia-APEL interface 
script (LCG.py).

Currently, these files SQL selects of the 3 tables that Gratia has
visibility to:
  OSG_DATA
  org_Tier1
  org_Tier2

In addition, the following data is also presented to assist in 
trouble shooting and in validating WLCG MOU monthly reports:
  HS06_OSG_DATA - includes the HepSpec2006 normalized values used
  late_updates  - show the updates that have occurred after the accounting
                  period (month) is over.  This allows us to confirm if
                  sites have caught up when problems have occurred, to some
                  extent
  missing_data  - shows resource (and days) where no accounting data was
                  found. Also show if planned maintenance was recorded in
                  OIM to account for it.

It is looking for both .html and .xml suffixed files in the format
  YYYY-MM.<table_name>.<xml | html>
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h1><a name="Configuration_files"></a> Configuration files </h1>
All configuration files can be found in the <em>/etc/gratia-apel</em> directory.
<p />
<a name="lcg_conf"/>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Configuration_lcg_conf"></a> Configuration (lcg.conf) </span></h2>
The <em>lcg.conf</em> is the main configuration file used by the interface.
<p />
<p />
 
<p />
<a name="edittable1"></a>
<div class="editTable">
<form name="edittable1" action="https://twiki.opensciencegrid.org/bin/viewauth/Accounting/ApelWlcgDevelopersCorner#edittable1" method="post">
<input type="hidden" name="ettablenr" value="1" />
<input type="hidden" name="etedit" value="on" />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table2" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=0;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">File</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol1 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=1;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Description</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> WebLocation </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Data directory for access by gratiaweb url. The xml and html files are made accessible. <br />If you do not want the files copied to a collector, then use the keyword 'DO_NOT_SEND'. <br />copied to a collector, then use the keyword 'DO_NOT_SEND'. <br /> </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> LogDir </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Directory for the log files.  Format YYYY-MM.log </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> TmpDataDir </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Directory for temporary files </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> UpdatesDir </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Directory for files sent to APEL </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> WebappsDir </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Directory for files accessible by the WebLocation </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> UpdateFileName </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Base name of files sent to SSM with updates.  Format YYYY-MM.UpdateFileName.txt </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> DeleteFileName </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Base name of files sent to SSM with deletes.  Format YYYY-MM.DeleteFileName.txt </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> SSMFile </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> SSM executable </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> SSMConfig </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> SSM configuration file </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> &nbsp; </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> &nbsp; </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a> </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> File with list of <strong><em>resource_groups</em></strong> to be reported and their normalization factor. </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterHistory_lcg_reportable" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterHistory</a> </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> History directory for keeping previous period's SiteFilterFile (lcg-reportableSites.YYYYMM) <br /> </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#VOFilterFile_lcg_reportableVOs" class="twikiCurrentTopicLink twikiAnchorLink">VOFilterFile</a> </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> File with list of VOs to be reported. </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#DBConfFile_lcg_db_conf" class="twikiCurrentTopicLink twikiAnchorLink">DBConfFile</a> </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Configuration file for database access. </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> &nbsp; </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> &nbsp; </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> MissingDataDays </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Number of days where a <strong><em>resource</em></strong> has no data reported to Gratia for the month.  If more than this number of days, a warning/advisory email will be generated if there is no scheduled maintenance (in OIM) for those days or the <strong><em>resource</em></strong> has been marked as inactive in OIM. </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> FromEmail </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Email address of the sender.  Since this is a cron run process, this is dependent on how email is set up locally. </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> ToEmail </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> List of comma separated email addresses.  Email notifications are sent to this list for all executions of this interface for both success and failure. </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> CcMail </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> List of comma separated email address.  It is recommended that the goc be specified here.  Specify NONE if no cc. </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<input type="hidden" name="etrows" value="20" />
<input class="twikiButton editTableEditButton" type="submit" value="Edit table" /> </form>
</div><!-- /editTable -->
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner19show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example lcg.conf</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner19hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner19toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
## WebLocation      DO_NOT_SEND
WebLocation       /var/www/html/gratia-apel
LogDir            /var/log/gratia-apel
TmpDataDir        /var/lib/gratia-apel/tmp
UpdatesDir        /var/lib/gratia-apel/apel-updates
WebappsDir        /var/lib/gratia-apel/webapps
UpdateFileName    ssm-updates
DeleteFileName    ssm-deletes

SSMFile           /usr/share/gratia-apel/ssm/ssm_master.py
SSMConfig         /etc/gratia-apel/ssm/ssm.cfg

SiteFilterFile    /etc/gratia-apel/lcg-reportableSites
SiteFilterHistory /etc/gratia-apel/lcg-reportableSites.history
VOFilterFile      /etc/gratia-apel/lcg-reportableVOs
DBConfFile        /etc/gratia-apel/lcg-db.conf

MissingDataDays   2

FromEmail  whomever@somewhere.edi
ToEmail    whomever@somewhere.edi,whomever2@somewhere.edi
CcEmail    goc@somewhere.org
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<a name="lcg_reportablesites"/>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SiteFilterFile_lcg_reportableSit"></a> SiteFilterFile (lcg-reportableSites) </span></h2>
This file identifies the set of sites/resources reportable to the APEL-LCG database and the normalization factor to be used in the gratia query. <ul>
<li> token 1 - The <strong><em>resource_group</em></strong>  being reported to APEL.
</li> <li> token 2 - The normalization value to be used. 
</li></ul> 
These tokens are whitespace separated.   Comments inidcated with a line starting with a # sign. Empty lines are permitted.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner20show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example lcg-reportableSites</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner20hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner20toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
##--- CMS Tier 1 -----
USCMS-FNAL-WC1     10264
##--- CMS Tier 2 -----
CIT_CMS_T2         12944
GLOW                9632
  :
####################################
#--- ATLAS Tier 2 -----
BNL-ATLAS          12372
#--- ATLAS Tier 2 -----
AGLT2               8500
HU_ATLAS_Tier2      8872
   :
#--- ALICE Tier 2 ----
NERSC-PDSF         13920
LC-glcc            15680
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<p />
<p />
<b>Note: In the future, the need for this configuration file should be eliminated.  It would be replaced by a query of MyOSG</b>
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="SiteFilterHistory_lcg_reportable"></a> SiteFilterHistory (lcg-reportableSites.history files) </h3>
This directory (lcg-reportableSites.history) contains the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SiteFilterFile_lcg_reportableSit" class="twikiCurrentTopicLink twikiAnchorLink">SiteFilterFile</a> files for each month (format: lcg-reportableSites/lcg-reportableSites.YYYYMM.  
<p />
Since the normalization factor changes over time, the only means of recreating past months data is to make this data time sensitive.  The interface program is designed to update the file for the current month every time it is run.  This provides the history for the latest normalization factor used that month.
<p />
When re-running a "past" (not current) months, the interface uses the time-stamped file in that directory  for the respective month.  When updates are made, the file should be committed into a source code repository, e.g. svn, git.
<p />
<!-- ---------------------------------------------------------------------------- -->
<a name="lcg_reportablevos"/>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="VOFilterFile_lcg_reportableVOs"></a> VOFilterFile (lcg-reportableVOs) </span></h2>
This file identifies the VO data reported for each reportable site/resource.  
Example:
<blockquote><pre>
cms
uscms
atlas
usatlas
alice
</pre></blockquote>
<p />
<!-- ---------------------------------------------------------------------------- -->
<a name="lcg_db_conf"/>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="DBConfFile_lcg_db_conf"></a> DBConfFile (lcg-db.conf) </span></h2>
Identifies access information for the Gratia and APEL databases.
<p />
 
<p />
<a name="edittable2"></a>
<div class="editTable">
<form name="edittable2" action="https://twiki.opensciencegrid.org/bin/viewauth/Accounting/ApelWlcgDevelopersCorner#edittable2" method="post">
<input type="hidden" name="ettablenr" value="2" />
<input type="hidden" name="etedit" value="on" />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table3" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=0;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">File</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol1 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/ApelWlcgDevelopersCorner?cover=print;sortcol=1;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Description</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> GratiaHost </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Gratia database host </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> GratiaPort </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Gratia database port </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> GratiaDB </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> Gratia database (schema) </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> GratiaUser </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol"> Should be a read-only user. </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> GratiaPswd </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> Password for a read-only user. </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<input type="hidden" name="etrows" value="6" />
<input class="twikiButton editTableEditButton" type="submit" value="Edit table" /> </form>
</div><!-- /editTable -->
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SSM_Configuration_files"></a> SSM Configuration files </span></h2>
There are 2 configuration files in <em>/etc/gratia-apel</em> that require some modifications: <ul>
<li> ssm/ssm.cfg
</li> <li> ssm/ssm.log.cfg
</li></ul> 
<p />
These sections define the specific changes made for this interface.<br />    
More detail regarding other options can be found in the <a href="https://wiki.egi.eu/wiki/APEL/SSMConfiguration" target="_top">APEL/SSM Configuration twiki</a>
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="ssm_cfg"></a> ssm.cfg </h3>
Effective in May 2014, the broker network for production and test are the same.  The test broker network has been deprecated.
The table below for <em>test/production</em> reflect this change.
<p />
The SSM brokers require a certificate for authentication if the <em>use-ssl</em> attribute is set to <em>true</em>.  
The default is the host certificate .
The subject of the certificate must be registered with the brokers.  To do this send an email to <a href="mailto&#58;apel&#45;support&#64;jiscmail&#46;ac&#46;uk">apel-support&#64;jiscmail.ac.uk</a> requesting registration.
It is suggested you obtain a service certificate thus allowing you flexibility in relocating to other nodes. 
The same certificate can be used for test and production.
 
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table4" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> [broker] </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol"> broker-network: PROD<br />     use-ssl: true </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> [certificates] </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> certificate: /etc/grid-security/gratia-osg-prod-reports.opensciencegrid.org-hostcert.pem<br />    key: /etc/grid-security/gratia-osg-prod-reports.opensciencegrid.org-hostkey.pem </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
The table below indicates the changes necessary for test and production:
 
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table5" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <font color="#252b37">Test</font> </th>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> [producer] </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol2 twikiLastCol"> topic: /topic/global.accounting.<font color="#0000ff">test.cpu</font>.central <br />    consumer-dn: /C=UK/O=eScience/OU=CLRC/L=RAL/CN=<font color="#0000ff">raptest.esc.rl.ac.uk</font> <br />    ack: /topic/global.accounting.<font color="#0000ff">test.cpu</font>.client.$host.$pid </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> <font color="#252b37">Production</font> </th>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLast"> [producer] </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol2 twikiLastCol twikiLast"> topic: /topic/global.accounting.<font color="#0000ff">cpu</font>.central <br />    consumer-dn: /C=UK/O=eScience/OU=CLRC/L=RAL/CN=<font color="#0000ff">rap.esc.rl.ac.uk</font> <br />    ack: /topic/global.accounting.<font color="#0000ff">cpu</font>.client.$host.$pid </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
<p />
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="ssm_log_cfg"></a> ssm.log.cfg </h3>
The only change required in the interface logging configuration is to hard code the directory path to the log directory and file:
 
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table6" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> [handler] </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> args=('/var/log/gratia-apel/ssm.log', 'a') </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
<!-- ---------------------------------------------------------------------------- -->
<a name="crontab"/>
<h1><a name="Crontab"></a> Crontab </h1>
The crontab file can be found in <em>/etc/cron.d</em>.
<p />
As mentioned somewhere way back in this document, the general practice has been run this interface from the 1st of the current month thru the 5th of the next month (e.g. for November, it will run nightly from 11/1 thru 12/5) to accommodate sites/resources that may have had reporting problems and are in "catch-up" mode.  So 2 cron entries are required:
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner21show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example /etc/cron.d/gratia-apel.cron</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner21hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner21toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
#-------------------------------------------------------------------------
# Gratia/APEL-EGI interface crontab entry
#-------------------------------------------------------------------------
# Previous month's transfers are run for just the 1st n days of the month to 
# insure all sites have reported to Gratia. 
# The n days is dependent on when LCG accounting issues the monthly MOU reports
#
# Note the lock file not existing is success hence the the slightly odd logic
# below.
#
# The lock file can be enabled or disabled via a
#   service   gratia-apel-cron start
#   chkconfig gratia-apel-cron on
#-------------------------------------------------------------------------
15 0 1-5 * *  root   [ ! -f /var/lock/subsys/gratia-apel-cron ] || (/usr/share/gratia-apel/LCG.py --config=/etc/gratia-apel/lcg.conf --date=previous --update)
#
#-------------------------------------------------------------------------
# Current month's transfers - Always daily.
#-------------------------------------------------------------------------
15 1 * * *  root [ ! -f /var/lock/subsys/gratia-apel-cron ] || ( /usr/share/gratia-apel/LCG.py --config=/etc/gratia-apel/lcg.conf --date=current --update && /usr/share/gratia-apel/create-apel-index.sh /etc/gratia-apel/lcg.conf) 
#
#-------------------------------------------------------------------------
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<!-- ---------------------------------------------------------------------------- -->
<h1><a name="Troubleshooting"></a> Troubleshooting </h1>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Certificate_issues_test_vs_produ"></a> Certificate issues (test vs production) </span></h2>
APEL has a test and production broker network for authenticating access using certificates.  
The following explanation of the differences between the 2 environments was provided by APEL support on March 21 2014.
<blockquote>
<b><u>Test broker environment</b></u><br />    
The data that you send to our test host (raptest) is sent via EGI's test broker network (the TEST-NWOB in your configuration). 
This allows connections not using SSL (hence 'use_ssl: false' in your configuration and the different port number). 
The rules for authorising with the test message brokers are more liberal as it is used by sites that are not certified by the EGI for testing. 
Your messages got through to us and, once we had your DN in our list of accepted senders, was loaded on the test host.
<p />
<b><u>Production broker environment</b></u><br />    
The data that you send to our production host (rap) is sent via EGI's production message brokers (PROD), using SSL. 
The rules for authorizing are more strict. 
The error messages that you are receiving (the Java ones) are from the message brokers and are sent when they fail to authorize your certificate. 
Sites are usually listed in GOCDB (goc.egi.eu) with a gLIte-apel endpoint - but I realize that this is probably not appropriate in your case. 
Do you remember if there was a special case made for your previous certificate?
 I should think that the message broker team will need either the DN or a copy of your new certificate to authenticate you. 
I am happy to follow this up with the message broker team on your behalf.
<p />
<b><u>Broker ports</b></u><br />    
The message brokers use port 6162 for SSL and 6163 for non-SSL connections. When you set 'use_ssl: true', the SSM software queries the BDII for hosts in the network you specify (TEST-NWOB or PROD) which use SSL. This is reflected by the message broker which is reported in your logs. Setting 'use_ssl: true' will result in port 6162 being reported, setting 'use_ssl: false' will result in 6163 being reported.
</blockquote>
<p />
The APEL brokers use SSL to authenticate access to the production APEL environment (note the  <strong><em>use-ssl</em></strong> attribute in the configuration file).
As of 3/14/14, there are 6 message brokers in use and each of them must have your <strong><em>certificate's DN</em></strong> registered.  The registration of your certificate with a broker is  done independently of one another.  There does not appear to be a means of coordinating the distribution of it.  So, one problem that could occur is that some of the brokers do not have your certificate.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner22show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example /var/log/gratia-apel/ssm.log on failure to connect</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner22hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner22toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
2014-03-25 07:58:54,404 - SSM - INFO - Starting the SSM...
2014-03-25 07:58:54,434 - SSM - INFO - Running the SSM once only.
2014-03-25 07:58:54,435 - SSM - INFO - BDII URL: ldap://lcg-bdii.cern.ch:2170
2014-03-25 07:58:54,435 - SSM - INFO - BDII broker network: PROD
<font color="#0000ff">2014-03-25 07:58:56,868 - SSM - DEBUG - Found broker in BDII: msg.cro-ngi.hr:6162
2014-03-25 07:58:56,868 - SSM - DEBUG - Found broker in BDII: egi-2.msg.cern.ch:6162
2014-03-25 07:58:56,868 - SSM - DEBUG - Found broker in BDII: egi-1.msg.cern.ch:6162
2014-03-25 07:58:56,868 - SSM - DEBUG - Found broker in BDII: broker.afroditi.hellasgrid.gr:6162
2014-03-25 07:58:56,869 - SSM - DEBUG - Found broker in BDII: mq.cro-ngi.hr:6162
2014-03-25 07:58:56,869 - SSM - DEBUG - Found broker in BDII: mq.afroditi.hellasgrid.gr:6162</font>
2014-03-25 07:58:56,869 - SSM - INFO - Connecting using SSL using key /etc/grid-security/gratia-apel-wlcg.opensciencegrid.org-hostkey.pem and cert /etc/grid-security/gratia-apel-wlcg.opensciencegrid.org-hostcert.pem.
2014-03-25 07:58:58,816 - stomp.py - INFO - Established connection to host <font color="#0000ff">msg.cro-ngi.hr, port 6162</font>
2014-03-25 07:58:58,817 - SSM - INFO - Connecting: ('msg.cro-ngi.hr', 6162)
2014-03-25 07:58:58,819 - SSM - INFO - The SSM will not run as a consumer.
2014-03-25 07:58:58,819 - SSM - INFO - The SSM will run as a producer.
2014-03-25 07:58:58,820 - SSM - DEBUG - I will be a producer, my ack queue is: /topic/global.accounting.cpu.client.gr13x6.fnal.gov.9581
2014-03-25 07:58:58,983 - SSM - WARNING - Error frame received.
2014-03-25 07:58:58,983 - SSM - DEBUG - Error frame headers:
2014-03-25 07:58:58,983 - SSM - DEBUG - {'message': 'User name [null] or password is invalid. No user for client certificate: CN=gratia-apel-wlcg.opensciencegrid.org, OU=Services, O=Open Science Grid, DC=DigiCert-Grid, DC=com', 'content-type': 'text/plain'}
2014-03-25 07:58:58,983 - SSM - DEBUG - java.lang.SecurityException: User name [null] or password is invalid. No user for client certificate: CN=gratia-apel-wlcg.opensciencegrid.org, OU=Services, O=Open Science Grid, DC=DigiCert-Grid, DC=com
        at org.apache.activemq.security.JaasCertificateAuthenticationBroker.addConnection(JaasCertificateAuthenticationBroker.java:100)

   :
<font color="#0000ff">If will attempt to contact each of the brokers.
The exception thrown may be that your certificate has not been 
registered with that specific broker.
</font>
   :
2014-03-25 07:59:31,253 - stomp.py - ERROR - Lost connection
2014-03-25 07:59:31,253 - SSM - WARNING - Disconnected from broker.
2014-03-25 07:59:31,253 - SSM - DEBUG - None
2014-03-25 07:59:31,253 - SSM - DEBUG - None
2014-03-25 07:59:31,253 - SSM - WARNING - Broker refused connection.
2014-03-25 07:59:36,271 - SSM - WARNING - Failed to connect to mq.afroditi.hellasgrid.gr:6162: Timed out while waiting for connection.  Check the connection details.
2014-03-25 07:59:36,271 - SSM - WARNING - Error processing outgoing messages: Attempts to start the SSM failed.  The system will exit.
2014-03-25 07:59:36,271 - SSM - WARNING - The SSM will exit
2014-03-25 07:59:36,272 - SSM - INFO - SSM connection ended.
2014-03-25 07:59:36,272 - SSM - INFO - The SSM has shut down.

</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<p />
<p />
<hr width="90%"/><hr width="90%"/>
<!-- ---------------------------------------------------------------------------- -->
<h1><a name="SSM"></a> SSM </h1>
Effective June 2012, accounting data sent to the EGI/WLCG APEL accounting system uses the Secure Stomp Messenger (SSM).
<p />
The Secure Stomp Messenger (SSM) is designed to give a reliable message transfer mechanism using the STOMP protocol.  Messages are encrypted 
during transit, and are sent sequentially, the next message being sent only when the previous one has been acknowledged.
The SSM is written in python.  It is designed and packaged for SL5. 
<p />
Additional information about APEL can be found here: <ul>
<li> <a href="https://wiki.egi.eu/wiki/APEL" target="_top">APEL - General Description</a>
</li> <li> <a href="https://wiki.egi.eu/wiki/APEL/Server" target="_top">APEL/Server</a>
</li> <li> <a href="https://wiki.egi.eu/wiki/APEL/SSM" target="_top">APEL/SSM interface</a>
</li></ul> 
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SSM_Installation"></a> SSM Installation </span></h2>
The SSM software is distributed as a part of the gratia-apel rpm package.  This is done to insure compatibility between the 2 systems.  If not, independent updates of SSM may not be compatible with the Gratia-APEL interface.
<p />
These sections provide a little more detail obtained from the <a href="https://wiki.egi.eu/wiki/APEL/SSMInstallation" target="_top">APELs SSM Installation twiki</a> related to the configuration.
<p />
<!-- ---------------------------------------------------------------------------- -->
<h3><a name="Prerequisites"></a> Prerequisites </h3>
The SSM protocol uses SSI authentication and therefore requires a set of CA certificates and a service certificate.   <ul>
<li> Instructions for installing the CA certificates: <a href="https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallCertAuth" target="_top">OSG - Installing Certificate Authorities Certificates and related RPMs twiki</a>.
</li> <li> Instructions for obtaining a service certificate: <a href="https://twiki.grid.iu.edu/bin/view/Documentation/Release3/GetHostServiceCertificates" target="_top">OSG - How to get host service certificates</a>
</li></ul> 
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner23show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example CA certificates install</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner23hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner23toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
This is a sample install of the CA certificates:
<blockquote><pre>
&gt; rpm -Uvh http://repo.grid.iu.edu/osg-el5-release-latest.rpm  # OSG repo
&gt; rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm   # EPEL repo
&gt; yum  -y  install yum-priorities
&gt; yum  -y  install osg-ca-certs
&gt; yum  -y  install fetch-crl

## Insure the cron will be activated
&gt; chkconfig fetch-crl-cron on
&gt; /sbin/service fetch-crl-cron start

## fetch-crl must have run once for the certificates to be verified successfully
&gt; /sbin/service fetch-crl-boot start    # this will take a little while
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
In addition, there are several python libraries required:
<blockquote><pre>
&gt; yum  -y  install stomppy   
&gt; yum  -y  install python-daemon
&gt; yum  -y  install python-ldap
</pre></blockquote>
<p />
<h3><a name="Installing_SSM"></a> Installing SSM </h3>
SSM can be installed via RPM.  However, as mentioned earlier, SSM has been packaged in the Gratia-APEL 
rpm in order to insure compatibility.
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Configuration_files_AN1"></a> Configuration files </span></h2>
Refer back to this section <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SSM_Configuration_files" class="twikiCurrentTopicLink twikiAnchorLink">SSM Configuration Files</a> for details.
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Running_the_SSM"></a> Running the SSM </span></h2>
One unique thing about SSM is that it needs to be run once without sending any messages in order to create the necessary
directory structure in <strong><em>/var/lib/gratia-apel/messages</em></strong>:
<blockquote><pre>
drwxr-xr-x 2 gratia gratia 4096 Jul 23 13:36 accept
drwxr-xr-x 2 gratia gratia 4096 Jul 23 13:36 ack
drwxr-xr-x 2 gratia gratia 4096 Jul 23 13:36 incoming
<font color="#0000ff">drwxr-xr-x 2 gratia gratia 4096 Jul 23 13:37 outgoing  <b># interface files</b></font>
drwxr-xr-x 2 gratia gratia 4096 Jul 23 13:36 reject
</pre></blockquote>
<p />
To run the SSM the first time (but don't do this until you've completed the configuration for test or production):
<blockquote><pre>
&gt; /usr/share/gratia-apel/ssm/ssm_master.py /etc/gratia-apel/ssm/ssm.cfg
</pre></blockquote>
<p />
Then, to send your messages: <ul>
<li> Write all the messages to the <em>/var/lib/gratia-apel/messages/outgoing</em>: directory
</li> <li> /usr/share/gratia-apel/ssm/ssm_master.py /etc/gratia-apel/ssm/ssm.cfg
</li></ul> 
<p />
<strong><em>NOTE:</em></strong> The <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#SSMInterface_py" class="twikiCurrentTopicLink twikiAnchorLink">SSMInterface.py</a> module can be used for this purpose when it is 
necessary to manually send files.
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Testing_the_SSM_interface"></a> Testing the SSM interface </span></h2>
A simple (and non-data affecting) means of testing your ssm.cfg and interface, is to create a simple test file such as the one below.
You would likely want to modify the 4 time attributes to reflect the current period.  
Using zero cpu and wall, as well as, a single number of jobs allows you to test the SSM interface and update of APEL without really affecting anything.
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner24show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example test file (<strong>ssm-test-file.txt</strong>)</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner24hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner24toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<strong>ssm-test-file.txt</strong>
<blockquote><pre>
APEL-summary-job-message: v0.2
Site: OSGTestSite
Group: cms
EarliestEndTime: 1401598800
LatestEndTime: 1401858000
Month: 06
Year: 2014
GlobalUserName: /DC=Gratia-APEL-test
WallDuration: 0
CpuDuration: 0
NormalisedWallDuration: 0
NormalisedCpuDuration: 0
NumberOfJobs: 1
%%
</blockquote></pre>
</div></div> <!--/twistyPlugin-->
<p />
Then, run the interface independent of the Gratia-Apel interface ( <em>LCG.py</em> ) script that sends Gratia data to APEL
<blockquote><pre>
&gt; /usr/share/gratia-apel/SSMInterface.py --config /etc/gratia-apel/ssm/ssm.cfg  
         --send-file <font color="#0000ff">ssm-test-file.txt</font>
</blockquote></pre>
You can verify APEL's receipt of the data by viewing the ssm log file locally and my checking: <ul>
<li> <a href="http://goc-accounting.grid-support.ac.uk/apel/summaries.html" target="_top">Production APEL: Sites with data in the rap Summaries table page</a>
</li> <li> <a href="http://goc-accounting.grid-support.ac.uk/apeltest/summaries.html" target="_top">Test APEL:Sites with data in the raptest Summaries table page</a>
</li></ul> 
Note that this pages are updated on a <em>cron</em> schedule basis roughly every 3 hours. So, there may be a bit of lag.
<p />
<p />
<!-- ---------------------------------------------------------------------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Log_file_var_log_apel_ssm_log"></a> Log file (/var/log/apel/ssm.log) </span></h2>
The APEL/SSM log file for a successful run will look like this:
<p />
<div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdAccountingApelWlcgDevelopersCorner25show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Show an example ssm.log</span></a> </span> <span id="twistyIdAccountingApelWlcgDevelopersCorner25hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdAccountingApelWlcgDevelopersCorner25toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0">
<blockquote><pre>
2012-07-23 13:37:02,301 - SSM - INFO - =======================================================
2012-07-23 13:37:02,301 - SSM - INFO - Starting the SSM...
2012-07-23 13:37:02,322 - SSM - INFO - Running the SSM once only.
2012-07-23 13:37:02,322 - SSM - INFO - BDII URL: ldap://lcg-bdii.cern.ch:2170
2012-07-23 13:37:02,322 - SSM - INFO - BDII broker network: TEST-NWOB
2012-07-23 13:37:03,526 - SSM - DEBUG - Found broker in BDII: test-msg01.afroditi.hellasgrid.gr:6162
2012-07-23 13:37:03,527 - SSM - DEBUG - Found broker in BDII: test-msg02.afroditi.hellasgrid.gr:6162
2012-07-23 13:37:03,527 - SSM - INFO - Connecting using SSL using key /etc/grid-security/gratia-osg-prod-reports.opensciencegrid.org-hostkey.pem and cert /etc/grid-security/gratia-osg-prod-reports.opensciencegrid.org-hostcert.pem.
2012-07-23 13:37:04,657 - stomp.py - INFO - Established connection to host test-msg01.afroditi.hellasgrid.gr, port 6162
2012-07-23 13:37:04,657 - SSM - INFO - Connecting: ('test-msg01.afroditi.hellasgrid.gr', 6162)
2012-07-23 13:37:04,658 - SSM - INFO - The SSM will not run as a consumer.
2012-07-23 13:37:04,658 - SSM - INFO - The SSM will run as a producer.
2012-07-23 13:37:04,658 - SSM - DEBUG - I will be a producer, my ack queue is: /topic/global.accounting.cpu.client.fermicloud140.fnal.gov.7541
2012-07-23 13:37:04,834 - SSM - INFO - Connected
2012-07-23 13:37:04,858 - SSM - INFO - The SSM started successfully.
2012-07-23 13:37:04,859 - SSM - INFO - No certificate, requesting
2012-07-23 13:37:04,859 - SSM - DEBUG - Sending noid
2012-07-23 13:37:05,296 - SSM - DEBUG - Broker received noid
2012-07-23 13:37:05,432 - SSM - DEBUG - Receiving message from: /topic/global.accounting.cpu.client.fermicloud140.fnal.gov.7541
2012-07-23 13:37:05,432 - SSM - INFO - Certificate received
2012-07-23 13:37:05,440 - SSM - DEBUG - /C=UK/O=eScience/OU=CLRC/L=RAL/CN=raptest.esc.rl.ac.uk/emailAddress=sct-certificates@stfc.ac.uk 
2012-07-23 13:37:05,459 - SSM - DEBUG - Got certificate
2012-07-23 13:37:05,461 - SSM - DEBUG - Hash: f0223f08fc939d83beeaa410eebbe42e
2012-07-23 13:37:05,461 - SSM - DEBUG - Raw length: 319581
2012-07-23 13:37:05,473 - SSM - DEBUG - Encoded length: 56429
2012-07-23 13:37:05,474 - SSM - DEBUG - Signing
2012-07-23 13:37:05,487 - SSM - DEBUG - Encrypting signed message of length 60170
2012-07-23 13:37:05,499 - SSM - DEBUG - Encrypted length: 82357
<font color="#0000ff">2012-07-23 13:37:05,499 - SSM - DEBUG - Sending 2012-07.ssm-updates.txt
2012-07-23 13:37:06,587 - SSM - DEBUG - Broker received 2012-07.ssm-updates.txt
2012-07-23 13:37:07,237 - SSM - DEBUG - Receiving message from: /topic/global.accounting.cpu.client.fermicloud140.fnal.gov.7541
2012-07-23 13:37:07,237 - SSM - DEBUG - Received ack for f0223f08fc939d83beeaa410eebbe42e
2012-07-23 13:37:07,260 - SSM - DEBUG - Message 2012-07.ssm-updates.txt acknowledged by consumer
2012-07-23 13:37:07,260 - SSM - INFO - All outgoing messages have been processed.</font>
2012-07-23 13:37:07,439 - SSM - INFO - SSM connection ended.
2012-07-23 13:37:07,440 - SSM - INFO - The SSM has shut down.
2012-07-23 13:37:07,440 - SSM - INFO - =======================================================
</pre></blockquote>
</div></div> <!--/twistyPlugin-->
<p />
<p />
<p />
<p />
<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
<h1><a name="Major_updates"></a> Major updates </h1>
<!--Future editors should add their signatures beneath yours!-->
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - Feb 2010: <br />    
Split this out as a separate twiki<br />    
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - June 2012: <br />    
Changed for use of the Secure Stomp Messenger (SSM) as the means of updating APEL replacing the direct database update used previously.<br />    
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - Mar 2014:  <br />    
Added the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#Certificate_issues_test_vs_produ" class="twikiCurrentTopicLink twikiAnchorLink">Certificate issues (test vs production) section</a> an explanation by APEL-SUPPORT regarding the difference between production and test.<br />    
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - Jun 2014:  <br />    
1. Modified for deprecation of the test broker network affecting the ssm.cfg file attributes distinguishing test vs production. This occurred in May 2014 to the best of my knowledge. See the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#ssm_cfg" class="twikiCurrentTopicLink twikiAnchorLink">ssm.cfg section</a> for latest.<br />    
2. Added the <a href="/bin/view/Accounting/ApelWlcgDevelopersCorner#testing_the_ssm_interface" class="twikiCurrentTopicLink twikiAnchorLink">Testing the SSM Interface section</a>.</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a> &gt; <a href="/bin/view/Accounting/GratiaInterfacesApelLcg" class="twikiLink">GratiaInterfacesApelLcg</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>ApelWlcgDevelopersCorner</span> <br />    
Topic revision: r28 - 06 Dec 2016 - 18:12:35 - <a href="/bin/view/Main/KyleGross" class="twikiLink">KyleGross</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />