<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> InnodbBackup &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/InnodbBackup?_T=16 Feb 2017" type="application/x-wiki" title="edit InnodbBackup" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/InnodbBackup"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--TABLEPLUGIN_table1--><style type="text/css" media="all">
.tableSortIcon img {padding-left:.3em; vertical-align:text-bottom;}
.twikiTable td {padding:1px;}
.twikiTable th {padding:1px;}
.twikiTable#table1 {border-width:0px;}
.twikiTable#table1 th {background-color:#F3EDE7;}
.twikiTable#table1 th.twikiSortedCol {background-color:#F3EDE7;}
.twikiTable#table1 tr.twikiTableRowdataBg0 td {background-color:#F3EDE7;}
.twikiTable#table1 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#F3EDE7;}
.twikiTable#table1 td {text-align:left;}
.twikiTable#table1 td {padding:1px;}
.twikiTable#table1 th {padding:1px;}
</style>
<!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <table width="100%">
<tr><td valign="top">
</td>
<td valign="top">
<h1><a name="Gratia_Backups"></a>  Gratia Backups </h1>
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Database_Backups"> Database Backups</a> <ul>
<li> <a href="?cover=print#Stragegy"> Stragegy</a> <ul>
<li> <a href="?cover=print#Simplest"> Simplest</a>
</li> <li> <a href="?cover=print#Higher_availability"> Higher availability.</a>
</li> <li> <a href="?cover=print#Lowest_recovery_time"> Lowest recovery time.</a>
</li></ul> 
</li> <li> <a href="?cover=print#Implementation">Implementation</a> <ul>
<li> <a href="?cover=print#Backup"> Backup</a>
</li> <li> <a href="?cover=print#Recovery"> Recovery</a> <ul>
<li> <a href="?cover=print#Simple_reload_of_one_of_the_sche"> Simple reload of one of the schema:</a>
</li> <li> <a href="?cover=print#Full_reload_of_the_database">Full reload of the database</a>
</li></ul> 
</li></ul> 
</li> <li> <a href="?cover=print#Installation_and_configuration_o"> Installation and configuration of ZRM</a>
</li></ul> 
</li></ul> 
</div>
</td>
<td valign="top" align="right" width="25%">
</td></tr></table>
<p />
<p />
<h1><a name="Database_Backups"></a> Database Backups </h1>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Stragegy"></a> Stragegy </span></h2>
<p />
To backup and restore the MySQL database when using InnoDB we have 3 possible levels depending on the uptime and recovery time requirement.
<p />
<h3><a name="Simplest"></a> Simplest </h3>
<p />
The database are backed up locally using mysqldump.  To simplify the backup maintenance scheduling and recovery are done via <a href="http://mysqlbackup.zmanda.com/" target="_top">Zmanda</a>
<p />
<h3><a name="Higher_availability"></a> Higher availability. </h3>
<p />
The database is replicated to a secondary node.  The replicated database is backed up via mysql dump which can be used to recover both
the main and replicated database. This is the scheme in normal operation on the FermiGrid Gratia DB systems.
<p />
<h3><a name="Lowest_recovery_time"></a> Lowest recovery time. </h3>
<p />
The database is replicated to a secondary node.  The replicated database is backed up by shutting down the DB server and doing a cold
copy of the file system.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Implementation"></a> Implementation </span></h2>
<p />
<h3><a name="Backup"></a> Backup </h3>
<p />
On each reporting DB system,  the backups are driven by the script gratia_backup_cron.sh, producing a local backup using mysql-zrm which is then backed up to tape via the central TiBS backup system.
<p />
The local backup configurations are in /etc/mysql-zrm/[SchemaName]
<p />
Note: We are not using the mysql-zrm scheduler directly in order to enforce the sequentially of the backups.
<p />
In the Operations repository, <code>:ext:cvsuser@cdcvs.fnal.gov:/cvs/cd/fermigrid/gratia-ops/backup/</code>, there is a subdirectory <code>mysql-zrm</code> containing <code>mysql-zrm.conf</code> files for insertion or linkage into <code>/etc/mysql-zrm</code> or <code>/etc/mysql-zrm/&lt;schema;&gt;</code> as appropriate. In addition, there is a script <code>patch-mysql-zrm-backup</code> to be run each time the ZRM software is installed in order to improve the emails sent at the end of each backup.
<p />
<h3><a name="Recovery"></a> Recovery </h3>
<p />
<h4><a name="Simple_reload_of_one_of_the_sche"></a> Simple reload of one of the schema: </h4>
<p />
<pre>mysql-zrm --verbose --action restore --backup-set gratia_qcd --source-directory /test/zrm/gratia_qcd/_last_directory_ --tmpdir=/test/tmp</pre>
<p />
where /test/tmp has enough space to hold a copy of the backup files.
<p />
<h4><a name="Full_reload_of_the_database"></a> Full reload of the database </h4>
<p />
This is intended to be used in case of total loss of the DB disks.
<p /> <ol>
<li> Create empty MySQL database, add the usual users (reader, gratia).
</li> <li> Create the empty databases (fermi_osg, gratia_itb, gratia_osg_integration, gratia_qcd, fermi_itb, gratia, gratia_osg_daily, gratia_psacct)
</li> <li> Restore the data from the backups of each database (see above .....)
</li> <li> Catalyze the restoration of triggers and procedures by executing this SQL prior to starting the collector for recovery:<br />    <pre>update SystemProplist set cdr &#61; 0 where BINARY car like &#39;&#37;Version&#39;</pre>
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Installation_and_configuration_o"></a> Installation and configuration of ZRM </span></h2>
<p />
<p />
<p />
See Documentation at <a href="http://mysqlbackup.zmanda.com/" target="_top">http://mysqlbackup.zmanda.com/</a>
<p />
ZRM v1.2.1 is currently installed on gratia06.
<p />
Obtain and download new versions from <a href="http://www.zmanda.com/download-zrm.php" target="_top">http://www.zmanda.com/download-zrm.php</a> in RPM form. You may need to remove the existing ZRM RPMS with <code>rpm -e</code> first to avoid conflicts
<p />
In the event of a non-optimal upgrade, downgrade by the normal RPM method of either removing the newer RPM before installing the older one; or by adding the <code>--oldpackage</code> option to the rpm upgrade command.
<p />
Location of configuration files: /etc/mysql_zrm/*/mysql-zrm.conf
<p />
Performance info: <pre>mysql-zrm-reporter --show backup-performance-info --destination /test/zrm/</pre>
<p />
Backup 'now':
<p />
<pre>mysql-zrm-scheduler --now --backup-set dailyrun --backup-level 0</pre>
<p />
Get information about the backups:
<p />
<pre>mysql-zrm --action list --backup-set gratia_pcanal</pre>
<p />
Restore:
<p />
<pre>mysql-zrm --verbose --action restore --backup-set itb_innodb --source-directory /test/zrm/itb_innodb/20080214144217/ --tmpdir=/test/tmp</pre>
<p />
where /test/tmp has enough space to hold a copy of the backup files.
<p />
<p />
Changes from the default zrm configuration file:
<pre>
# Request explicitly full backups
backup-level=0
# Select where to write the backup file
destination=/backup/mysqldb/zrm
# Select how many days (D) to keep the backup file
retention-policy=3D
# Request explicit compression
compress=1
# Select which schema to backup (eg):
databases=gratia_qcd
# Select the DB user
user="..."
password="...."
# Select where to send result emails, use an empty string for no emails at all.
mailto="gratia-root@fnal.gov"
# Tell ZRM to compress on-the-fly (v2.0 and above)
compress-mysqldump-onthefly=1



-- Main.ChrisGreen - 22 Sep 2008

-- Main.PhilippeCanal - 27 Feb 2008
</pre>
</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>InnodbBackup</span> <br />    
Topic revision: r18 - 03 Aug 2010 - 22:01:30 - <a href="/bin/view/Main/ChrisGreen" class="twikiLink">ChrisGreen</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />