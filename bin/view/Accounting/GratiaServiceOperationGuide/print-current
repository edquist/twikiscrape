<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> GratiaServiceOperationGuide &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaServiceOperationGuide?_T=16 Feb 2017" type="application/x-wiki" title="edit GratiaServiceOperationGuide" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaServiceOperationGuide"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Gratia_Service_Operation_Guide"></a> Gratia Service Operation Guide </h1>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="List_of_Services_Operated_by_Fer"></a> List of Services Operated by FermiGrid. </span></h2>
<p />
<a href="http://fermigrid.fnal.gov/gratia-production-organization.html" target="_top">List of services operated by FermiGrid</a>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Operational_Architecture_Overvie"></a> Operational Architecture Overview. </span></h2>
<p />
As seen in the <a href="http://fermigrid.fnal.gov/gratia-production-organization.html" target="_top">production machine deployment description</a>, the OSG and FNAL-local Gratia  services each consist of a pair of machines each with 6 VMs, the "collector" machine and the "reporter" machine. The collector VMs use the collector DB and the reporter VMs the reporter DB, which is slaved from the collector DB using MySQL replication. The Gratia services on the reporting VMs consist of the reporting services <strong>only</strong>: no data collection services are installed on these nodes. Similarly, under normal conditions the collector VMs do not have any reporting services. Any requests for reports directed at the collector services are redirected by tomcat to the correct reporting service.
<p />
<h3><a name="HA_operation"></a> HA operation. </h3>
<p />
The IP by which the reporting services access the reporting DB is handled by heartbeat and may be failed over to the collector DB if necessary; the converse is <strong>not</strong> true. Similarly, heartbeat can be used to fail an individual reporting service over to be managed by the corresponding collector service: the collector service is restarted by hibernate in a mode that serves the reports directly rather than redirecting them to the reporting VM. Again, the converse is <strong>not</strong> true.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Installation_upgrade_guide"></a> Installation / upgrade guide. </span></h2>
<p />
<a href="/bin/view/Accounting/InstallationGuideFNAL" class="twikiLink">Installation Guide (FNAL Specific)</a>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Log_file_description"></a> Log file description. </span></h2>
<p />
<p />
<p />
All the Collector and Reporting service log files are located in <code>$CATALINA_HOME/logs</code>. The main log files are as follows:
<p /> <ul>
<li> <code>catalina.out</code>: contains tomcat messages emitted outside the auspices of log4j (before its initialization for instance) or messages sent directly to <code>stdout</code>. This file is not rotated.
</li> <li> <code>messages.log</code>: contains all messages not otherwise directed by the log4j configuration file or Gratia's logging system (controlled by log4j config file).
</li> <li> <code>hibernate.log</code>: contains all messages emitted by hibernate (controlled by log4j config file).
</li> <li> <code>gratia.log</code>: Messages from the record processor code, including details of records saved,  errors found processing records any information about clean-up or replication.
</li> <li> <code>glite-security-trustmanager.log</code>: messages from the authorization infrastructure (controlled by the log4j config file).
</li> <li> <code>gratia-administration.log</code>: messages from the administration service.
</li> <li> <code>gratia-registration.log</code>: messages from registration activities.
</li> <li> <code>gratia-reporting.log</code>: All messages emitted by the Gratia reporting infrastructure (as opposed to BIRT messages, which appear in <code>catalina.out</code>).
</li> <li> <code>gratia-rmi-servlet.log</code>: messages from the servlets receiving information from remote probes.
</li> <li> <code>access/access.log</code>: tomcat access log (controlled by tomcat valve configuration in <code>conf/server.xml</code>).
</li></ul> 
<p />
Unless otherwise specified, logs are rotated daily and are controlled by the relevant clause in <code>service-configuration.properties</code>, the main Gratia configuration file.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Monitoring_Gratia"></a> Monitoring Gratia. </span></h2>
<p />
<a href="/bin/view/Accounting/Monitoring" class="twikiLink">Guide to monitoring a collector</a>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Incident_Reporting"></a> Incident Reporting </span></h2>
<p />
<p />
In case a problem need to be investigate in detailed by the developer the following information can be of use: <ul>
<li> Content of <code>$CATALINA_HOME/logs</code>
</li> <li> Content of <code>$CATALINA_HOME/gratia</code>: the sub-diretory $CATALINA_HOME/gratia/data contains information about the incoming data <ul>
<li> <code>$CATALINA_HOME/gratia/data/thread?</code> contains the yet to be processed incoming message
</li> <li> <code>$CATALINA_HOME/gratia/data/old-*</code> contains a copy of all the already processed messages, including duplicates and error case
</li> <li> <code>$CATALINA_HOME/gratia/data/history-*</code> contains a marked up copy of all the successfully processed records.
</li></ul> 
</li></ul> 
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Some_service_related_activities"></a> Some service-related activities (common or otherwise). </span></h2>
<p />
<div class="twikiToc"> <ul>
<li> <a href="/bin/view/Accounting/Operation?cover=print#Some_Operational_Tasks"> Some Operational Tasks.</a> <ul>
<li> <a href="/bin/view/Accounting/Operation?cover=print#Starting_and_stopping_the_servic"> Starting and stopping the service</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Site_Name_changes"> Site Name changes</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Probe_changes"> Probe changes</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Automating_those_Site_and_Probe"> Automating those Site and Probe changes.</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Change_the_name_use_for_a_VO_in"> Change the name use for a VO in the reports.</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Adding_a_VO_Name_very_rare"> Adding a VO Name (very rare)</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Automating_change_in_VO_Name"> Automating change in VO Name.</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Setting_up_replication"> Setting up replication</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Rolling_back_a_release_extremely"> Rolling back a release (extremely rare)</a>
</li> <li> <a href="/bin/view/Accounting/Operation?cover=print#Installing_and_configuring_the_l"> Installing and configuring the latest version of ZRM (extremely rare)</a>
</li></ul> 
</li></ul> 
</div>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Information_on_backups"></a> Information on backups. </span></h2>
<p />
Backups are made of several different aspects of the Gratia system:
<p /> <ul>
<li> Daily backups of XML files from <code>gratia/data/</code> via rsync (<code>~gratia/gratia-ops/backup/ddback/ddback.cron</code>). This is required on collector machines <strong>only</strong>. <ul>
<li> Installation is from RPM (<code>~gratia/gratia-ops/backup/ddback/RPMS</code>): version &gt;=1.0.2 is required.
</li> <li> <a href="http://sourceforge.net/projects/ddback/" target="_top">ddback project home page</a> is on <a href="http://sourceforge.net/" target="_top">SourceForge</a>.
</li> <li> To configure, run <code>~gratia/gratia-ops/backup/update-ddback-xml</code> on the target collector machine.=
</li></ul> 
</li> <li> Monthly backups of XML files to Enstore via encp (<code>~gratia/gratia-ops/backup/gratia-archive.sh</code>). Again, required on collector machines only.  Machine should have access to a UPS installation of <code>encp</code> and have enstore write permissions. Invocation of the <code>gratia-archive.sh</code> file should be in root's <code>crontab</code>.
</li> <li> <a href="/bin/view/Accounting/InnodbBackup" class="twikiLink">Daily backups of the DB schemata</a> via ZRM (<code>~gratia/gratia-ops/backup/gratia_backup.cron.sh</code>).
</li> <li> XML files are sent to <code>splunk</code> hourly (<code>~gratia/gratia-ops/splunk/*</code>). See Neha for installation details.
</li> <li> Gratia Sourceforge code base is backed up nightly to <code>gr6x3:/data/svn-backup</code> (<code>~gratia/gratia-ops/backup/svn-backup</code>), installed in gratia user's <code>crontab</code> on <code>gr6x3</code>.
</li></ul> 
<p />
Note that the <code>~gratia/gratia-ops</code> area is a checked-out copy of <code>:ext:cvsuser@cdcvs.fnal.gov:/cvs/cd/fermigrid/gratia-ops</code>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Schema_optimization"></a> Schema optimization. </span></h2>
<p />
Each database should be optimized regularly to maintain query and insert efficiency in the face of serious churn due to housekeeping activities. The configuration file for each DB instance is to be found as <code>~gratia/gratia-ops/gratia-optimize-db/XXXXXX_optimize_commands</code>. Create a new one as necessary using an existing one as template.
<p />
An example line:<pre>07 11 &#42; 1-12/3 6 ~gratia/gratia-ops/gratia-optimize-db -v ~gratia/gratia-ops/XXXXXX&#95;optimize&#95;commands &#62; /var/log/gratia&#95;optimize.log 2&#62;&#38;1</pre>
<p />
Note that with the above line, the script is run every Saturday of the first month of each quota. Whether the optimization actually occurs on any given invocation may be further limited by shell code in the configuration file, for example:<pre>MAILTO&#61;&#34;gratia-operation&#64;fnal.gov&#34;
(( day&#95;of&#95;week &#61; `date +&#37;w` ))
(( month &#61; `date +&#37;&#95;m` ))
(( day&#95;of&#95;month &#61; `date +&#37;&#95;d` ))
# Only optimize on the 3rd Saturday of the month.
if (( month &#37; 3 &#61;&#61; 1 )) &#38;&#38; \
   (( day&#95;of&#95;week &#61;&#61; 6 )) &#38;&#38; \
   (( day&#95;of&#95;month / 7 &#61;&#61; 2 )); then
  run&#95;db&#95;optimize gratia gratia-osg-prod.opensciencegrid.org 443
  run&#95;db&#95;optimize gratia&#95;osg&#95;daily gratia-osg-daily.opensciencegrid.org 443
  run&#95;db&#95;optimize gratia&#95;osg&#95;transfer gratia-osg-transfer.opensciencegrid.org 443
  run&#95;db&#95;optimize gratia&#95;itb gratia-osg-itb.opensciencegrid.org 443
fi
</pre>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Additional_Information"></a> Additional Information. </span></h2>
<p />
See also the general installation <a href="https://twiki.grid.iu.edu/bin/view/Accounting/WebHome#Collector_and_Reporting" target="_top">notes</a>
<p />
-- <a href="/bin/view/Main/ChrisGreen" class="twikiLink">ChrisGreen</a> - 11 Jul 2008</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>GratiaServiceOperationGuide</span> <br />    
Topic revision: r8 - 04 Aug 2010 - 15:39:48 - <a href="/bin/view/Main/ChrisGreen" class="twikiLink">ChrisGreen</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />