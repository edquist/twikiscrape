<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> GratiaReleaseV0dot28 &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaReleaseV0dot28?_T=16 Feb 2017" type="application/x-wiki" title="edit GratiaReleaseV0dot28" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaReleaseV0dot28"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--TABLEPLUGIN_table2--><style type="text/css" media="all">
.twikiTable#table2 th {background-color:#99CCCC;}
.twikiTable#table2 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table2 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table2 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table2 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table2 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--TABLEPLUGIN_table3--><style type="text/css" media="all">
.twikiTable#table3 th {background-color:#99CCCC;}
.twikiTable#table3 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table3 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table3 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table3 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table3 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--EDITTABLEPLUGIN--><style type="text/css" media="all">
@import url("https://twiki.opensciencegrid.org/twiki/pub/TWiki/EditTablePlugin/edittable.css");
</style>

<!--TABLEPLUGIN_table1--><style type="text/css" media="all">
.tableSortIcon img {padding-left:.3em; vertical-align:text-bottom;}
.twikiTable#table1 th {background-color:#99CCCC;}
.twikiTable#table1 th.twikiSortedCol {background-color:#99CCCC;}
.twikiTable#table1 tr.twikiTableRowdataBg0 td {background-color:#FFFFCC;}
.twikiTable#table1 tr.twikiTableRowdataBg1 td {background-color:#FFFFFF;}
.twikiTable#table1 tr.twikiTableRowdataBg0 td.twikiSortedCol {background-color:#FFFFCC;}
.twikiTable#table1 tr.twikiTableRowdataBg1 td.twikiSortedCol {background-color:#FFFFFF;}
</style>
<!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Gratia_Services_V0_28_2007_10_27"></a>  Gratia Services V0.28 - 2007/10/27 </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Release_Notes"> Release Notes</a>
</li> <li> <a href="?cover=print#Anticipated_downtime"> Anticipated downtime</a>
</li> <li> <a href="?cover=print#Collectors_and_Databases_Affecte"> Collectors and Databases Affected</a>
</li> <li> <a href="?cover=print#Conversion_steps"> Conversion steps</a> <ul>
<li> <a href="?cover=print#Shutdown_and_database_backup"> Shutdown and database backup.</a>
</li> <li> <a href="?cover=print#Upgrade_and_implementation"> Upgrade and implementation</a>
</li></ul> 
</li> <li> <a href="?cover=print#Activating_the_new_release"> Activating the new release</a>
</li> <li> <a href="?cover=print#Post_mortem"> Post-mortem</a>
</li></ul> 
</div>
<p />
<p />
<p />
<h1><a name="Release_Notes"></a> Release Notes </h1>
This release (v0.28) incorporates the following changes and updates ...
<dl>
<dt style="font-weight: bold; font-size: larger">Since VDT 1.8.1b release (v0.27.5)</dt>
<dd>
<ul>
  <li>Collector
  <ul>
    <li>Improvements for MetricRecords.</li>
    <li>Upgrade hibernate to v3.2.5.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Upgrade to a new version of the report viewer: BIRT v2.0 -&gt; v2.2.1
    <ul>
      <li>Link to allow reports to be bookmarked.</li>
      <li>PDF generation available.</li>
      <li>VO multi-select now available in one report ("Usage Metrics - For VO(s)").</li>
    </ul></li>
    <li>All drill through reports and should work now; and download <code>.csv</code> should be fixed everywhere.</li>
  </ul></li>
</ul>
</dd>
<dt style="font-weight: bold; font-size: larger">Between VDT 1.8.1b and the last version running on the production servers (v0.26.6)</dt>
<dd>
<ul>
  <li>Administration
  <ul>
    <li>Detailed view available for main status page.</li>
  </ul></li>
  <li>Collector
  <ul>
    <li>Support for probe handshaking.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Fix calendar pop-up.</li>
    <li>Fix "See Table" functionality for some reports.</li>
  </ul></li>
</ul>
</dd>
<dt style="font-weight: bold; font-size: larger">Between v0.26.6 and VDT 1.6.1 (v0.25)</dt>
<dd>
<ul>
  <li>Administration
  <ul>
    <li>Minor improvements to the: probe status; VO; and replication control pages.</li>
  </ul></li>
  <li>Collector
  <ul>
    <li>Fix history clean-up.</li>
    <li>Replication now more versatile.</li>
    <li>Update hibernate to v3.2.4sp1.</li>
    <li>VOName correction improved.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Introduce ranked reports.</li>
    <li>Generalized usage reports to enable selection of metric.</li>
    <li>Fix some drill-throughs.</li>
  </ul></li>
</ul>
</dd>
</dl>
<p />
Prior to starting the conversion, we need to verify that MySql is configured correctly for the 6Gb of available memory on the <em>gratia06</em>. <b>Note: This is not going to be done at this time.  See Post-Mortem notes.</b>
<p />
<p />
<!--   ANTICIPATED DOWNTIME --------------- -->
<h1><a name="Anticipated_downtime"></a> Anticipated downtime </h1>
It is expected that this release will require the Gratia services and reporting to be unavailable during the periods specified below: <ul>
<li> Start: 10/27/2007 (Saturday) 17:00 CDT.<br />    
</li> <li> Projected Availability: 10/28/2007 (Sunday) 10:00 CDT.
</li></ul> 
<p />
The changes affecting downtime  for this release are: <ol>
<li> Addition of a column in the JobUsageRecord_Meta table.
</li> <li> The necessity of recreating all the summary tables due to the addition of the new table.
</li></ol> 
<p />
As a side note, it is anticipated that downtime for future releases will be minimal as a new procedure will be used when lengthy database conversion are necessary.  It cannot be down for this release as the necessary hardware is not yet in place.
<p />
<p />
<!--   COLLECTORS AND DATABASES AFFECTED  --------------- -->
<h1><a name="Collectors_and_Databases_Affecte"></a> Collectors and Databases Affected </h1>
<p />
The following Gratia collectors and databases will be converted with this release:
<p />
<a name="edittable1"></a>
<div class="editTable">
<form name="edittable1" action="https://twiki.opensciencegrid.org/bin/viewauth/Accounting/GratiaReleaseV0dot28#edittable1" method="post">
<input type="hidden" name="ettablenr" value="1" />
<input type="hidden" name="etedit" value="on" />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table1" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=0;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Schema</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol1"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=1;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">MySql port</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol2"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=2;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Collector URL</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol3"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=3;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Collector host</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol4"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=4;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size (bytes)</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol5 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=5;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size (rows)</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> fermi_itb </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol2"> gratia-fermi.fnal.gov:8881 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol3"> gratia08.fnal.gov: </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 724K </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol5 twikiLastCol"> 1 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> fermi_osg </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol2"> gratia-fermi.fnal.gov:8880 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol3"> gratia08.fnal.gov: </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4"> 4.3G </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol5 twikiLastCol"> 2,237,912 </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol2"> gratia.opensciencegrid.org:8880 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol3"> gratia09.fnal.gov </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 81G </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol5 twikiLastCol"> 26,476,198 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_itb </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol2"> gratia.opensciencegrid.org:8881 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol3"> gratia09.fnal.gov </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4"> 15G </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol5 twikiLastCol"> 2,688,424 </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_osg_integration </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol2"> gratia.opensciencegrid.org:8885 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol3"> gratia09.fnal.gov </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 3.1G </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol5 twikiLastCol"> 815,371 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> gratia_qcd </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLast"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol2 twikiLast"> gratia-fermi.fnal.gov:8883 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol3 twikiLast"> gratia08.fnal.gov: </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4 twikiLast"> 2.2G </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol5 twikiLastCol twikiLast"> 804,418 </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<input type="hidden" name="etrows" value="7" />
<input class="twikiButton editTableEditButton" type="submit" value="Edit table" /> </form>
</div><!-- /editTable -->
<p />
<p />
The following Gratia collectors and databases will <strong><em>NOT</em></strong>  be converted with this release.  These repositories contained specialized reports that have not as yet been upgraded to the new Birt V2..2.1 software. <strong><em>However</em></strong>, they will be taken out-of-service while the other databases are being updated.
<p />
<a name="edittable2"></a>
<div class="editTable">
<form name="edittable2" action="https://twiki.opensciencegrid.org/bin/viewauth/Accounting/GratiaReleaseV0dot28#edittable2" method="post">
<input type="hidden" name="ettablenr" value="2" />
<input type="hidden" name="etedit" value="on" />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table2" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=0;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Schema</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol1"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=1;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">MySql port</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol2"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=2;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Collector URL</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol3"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=3;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Collector host</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol4"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=4;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size (bytes)</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol5 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=5;table=2;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size (rows)</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_psacct </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol2"> gratia08.fnal.gov:8882 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol3"> gratia08.fnal.gov: </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 6G </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol5 twikiLastCol"> 3,790,511 </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> gratia_osg_daily </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLast"> gratia06.fnal.gov:3320 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol2 twikiLast"> gratia.opensciencegrid.org:8884 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol3 twikiLast"> gratia09.fnal.gov </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4 twikiLast"> 60M </td>
			<td bgcolor="#FFFFFF" align="center" valign="top" class="twikiTableCol5 twikiLastCol twikiLast"> 53,929 </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<input type="hidden" name="etrows" value="3" />
<input class="twikiButton editTableEditButton" type="submit" value="Edit table" /> </form>
</div><!-- /editTable -->
<p />
<p />
<!--   CONVERSION STEPS -------------------- -->
<h1><a name="Conversion_steps"></a> Conversion steps </h1>
This release involves a database schema change on the JobUsageRecord_Meta table, it is expected to take a significant amount of time on the production <em>gratia</em> data base.  
In order to minimize the overload that is certain to occur if we were to stop the Gratia collectors from accepting data from the probes, the Gratia collectors will only be taken down for a short period while the database is being backed up.
<p />
<p />
<!-- ----------------- SHUTDOWN AND DATABASE BACKUP ------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Shutdown_and_database_backup"></a> Shutdown and database backup. </span></h2>
  <ol type="1">
    <li>On <em>gratia06</em> , <strong><em>comment</em></strong> out the <em>gratia</em> user cron jobs.<br />    
            <strong><em>Status - Done 10/27/2007 08:00</em></strong>
   </li>
<p />
     <li>On <em>gratia06</em>, <strong><em>comment</em></strong> out the <em>mysqlhotcopy_cron</em> entry.
<pre class="screen">
43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh &gt; /var/log/mysqlhotcopy.out 2&gt; &1
</pre><br />    
            <strong><em>Status - Done 10/27/2007 08:00</em></strong> <p>
<p />
<p />
    </li>
<p />
     <li> For <strong><em>ALL</em></strong> of the databases (<strong><em>including those not be upgraded</em></strong>) , <strong><em>stop</em></strong> the Gratia update services.<br />    
            - In your browser,  connect to the Gratia administrative services url for each of the databases.<br />    
            - Select the <em>System / Administration</em> menu option in the left menu<br />    
            - Then scroll down to the <em>Starting/Stopping Database Update Services</em> section and select the <em>Stop Update Services</em> link.<br />    
            <strong><em>Status - Started  17:05   Ended  17:17</em></strong> 
      </li>
<p />
     <li> On <strong><em>each</em></strong> collector/tomcat host, <strong><em>stop</em></strong> the tomcat service for <strong><em>ALL</em></strong> Gratia collectors.
<pre class="screen">
On gratia09:
  service tomcat-gratia  stop
  service tomcat-itb  stop
  service tomcat-osg_daily  stop
  service tomcat-osg_integration stop

On gratia08:
  service tomcat-fermi_itb  stop
  service tomcat-fermi_osg stop
  service tomcat-ps  stop
  service tomcat-qcd stop
</pre>
<p />
            <strong><em>Status - Started  17:55   Ended  17:57</em></strong> 
<p />
<p />
</li>
<p />
<p />
   <li>Taking a back up the database instance on <em>gratia06</em> (this will include all schema) using part of the <em>msqlhotcopy_cron</em> script.
           This is in the event that the compacting of the JobUsageRecord_Xml has insufficient space and corrupts the table. Backup is only being done to  <em>/backup/mysqldb</em> on <em>gratia06</em> .
      <pre class="screen">
<b>Instances being upgraded to v0.28:</b>
mysqlhotcopy -p lisp01 --addtodest fermi_itb /backup/mysqldb       Duration - 1 sec
mysqlhotcopy -p lisp01 --addtodest gratia_qcd /backup/mysqldb      Duration -  64 secs
mysqlhotcopy -p lisp01 --addtodest gratia_osg_integration /backup/mysqldb     Duration - 99 secs
mysqlhotcopy -p lisp01 --addtodest fermi_osg /backup/mysqldb    Duration - 132 secs
mysqlhotcopy -p lisp01 --addtodest gratia_itb /backup/mysqldb     Duration -  461 secs
mysqlhotcopy -p lisp01 --addtodest gratia /backup/mysqldb        Duration - 2900 secs (48+ minutes)

<b>Instances NOT being upgraded to v0.28:</b>
mysqlhotcopy -p lisp01 --addtodest gratia_osg_daily /backup/mysqldb    Duration -  6 secs
mysqlhotcopy -p lisp01 --addtodest gratia_psacct /backup/mysqldb     Duration - 179 secs

</pre>
<p />
            <b>Status - Started  18:01   Ended -  18:30  for all except the <em>gratia</em> instance.</b><br />    
            <b>Status of <em>gratia</em> instance - Started    18:30   Ended  19:18  Elapsed - 48+ min) </b><br>
 (Was expecting this to take 80 minutes based on looking at the <em>mysqlhotcopy</em> logs).
<br />     Note: The times reported by <em>mysqlhotcopy</em> seem to understate the actual duration.
<p />
<b>Backups complete at 19:20</b>
<p />
     </li>
<p />
<p />
<p />
<p />
<p />
    <li>Compact the gratia schema Xml table.
<pre>optimize table gratia. JobUsageRecord_Xml ;</pre>
<p />
           <strong><em>Note:</em></strong> <em>JobUsageRecord_XML</em> table size is 53Gb.  On <em>gratia07</em> , started an "_optimize table JobUsageRecord_Xml_" to determine how long it would take on <em>gratia06</em>.  <br />    
            Started -  10/27/2007 08:17  Ended - Never.  There was insufficient space on the disk. Caused the table to become corrupt.  Concern is now that if I do this on production, can I recover.  So am attempting to recover from the <em>gratia06</em> <em>/backup/mysqldb</em> area only the JobUsageRecord_Xml table. <br />     
<b>Started scp at 17:01  Ended - 17:46  Elapsed - 45 min</b><br />    
Status of table on gratia07 is good.  So this is viable.  I will only back up the databases to the local <em>/backup/myslqdb</em> area on <em>gratia06</em>.  This analysis was done a little out of the original order and a deviation from how it was planned.
<p />
<p />
<b>State of the storage when I started optimizing at 17:22</b>
<pre>
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/LG0-LV0    99G   33G   62G  35% /data/mysqldb
/dev/mapper/LG0-LV4   156G   81G   68G  55% /data/mysqldb/gratia
</pre>
<p />
<b>State of the storage when optimization completed at 17:47 (Elaspsed: 25+ minutes)</b>
<pre>
/dev/mapper/LG0-LV0    99G   33G   62G  35% /data/mysqldb
/dev/mapper/LG0-LV4   156G   47G  101G  32% /data/mysqldb/gratia
</pre>
<p />
After phone conversation with Chris, he advised deleting the duplicate records to speed up the conversion process:
<pre>
delete from DupRecord where error = 'Duplicate';
</pre>
<b>Status:  Done at 21:25 (   64061 records)</b>
</li>
<p />
<p />
    <li>Back up the database instance on <em>gratia06</em> (this will include all schema) using the <em>msqlhotcopy_cron</em> script.
           With the collector update services stopped on all database schemata, this will in affect be a complete backup.  
            This script copies the backup files that are backed up to _TiBS_ .
      <pre class="screen">&gt; /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1</pre>
          <b>Note: Chose not to do this after seeing that recovery of individual tables seemed to work and due to the lack of available space that I could find.  This should be done in the future.</b>
<p />
Instead, I backed up only the <em>gratia</em> schema to the <em>/backup/mysqldb</em> directory using:
<pre>
mysqlhotcopy -p lisp01 --addtodest gratia /backup/mysqldb        Duration - 1806 secs (30+ minutes)
</pre>
            <b>Status - Started  19:53   Ended  20:23  Elapsed: 30+ minutes</b>
<p />
     </li>
<p />
<p />
    <li>As an added measure, take a standard tree copy of the <em>/data/mysqldb</em> tree on <em>gratia06</em>  .<br>
           <b>Note: Chose not to do this after seeing that recovery of individual tables seemed to work and due to the lack of available space that I could find.  This should be done in the future.</b>
     </li>
<p />
<p />
    <li>Take a  backup of the <em>/data/tomcat-*/gratia/data</em> directory as a <em>tar file</em>.
<pre class="screen">
To be provided by John Weigand (if needed)
</pre></li>
<b>Note: not done, most likely due to battle fatigue.</b>
   </ol>
<p />
<p />
<!-- ----------------- UPGRADE AND IMPLEMENTATION ------------- -->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Upgrade_and_implementation"></a> Upgrade and implementation </span></h2>
The <strong><em>upgrades should be single-threaded</em></strong> , that is, performed for each database schema on at a time.  
The reason for this is that they are sharing the same MySql instance and the schema upgrades will be resource intense.
<p />
First, build the software release if you have not already done so<br> <ul>
<li> <b>Status -  Completed on 10/26/07 at 19:22</b><br>
</li> <li> Directory - /home/weigand/cdcvs/gratia/target<br>
</li> <li> All files (war and tar), including the VDT tar files are in <em>/home/gratia/gratia-releases/v0.28</em> .
</li></ul> 
<p />
We will perform these upgrades based on the size of the individual database schema, in ascending order:
<ol>
<p />
  <li>Install the new software on a Gratia tomcat instance:
<pre class="screen">
pswd=xxx
source=/home/weigand/cdcvs/gratia
pgm=/home/weigand/cdcvs/gratia/common/configuration/update-gratia-local 
<b>On gratia09:</b>
$pgm  -d $pswd -S $source  osg_integration
$pgm  -d $pswd -S $source  itb
$pgm  -d $pswd -S $source   gratia

<b>On gratia08:</b>
$pgm  -d $pswd -S $source  fermi_itb
$pgm  -d $pswd -S $source qcd
$pgm  -d $pswd -S $source   fermi_osg
</pre>
</li>
<p />
<li>This is optional, but probably a good idea to save off the logs under each tomcat instance and empty the <em>log</em> directory.  It will facilitate catching any errors that may occur (of course there won't be any, but a good idea anyway):
<pre class="screen">
<b>On gratia09:</b>
date=`date '+%Y%m%d'`
cd /data/tomcat-osg_integration/logs
tar zcf  /data/gratia_tomcat_logs_backups/tomcat-osg_integration.$date.tgz     * 
rm -f *

cd     /data/tomcat-itb/logs/
tar zcf /data/gratia_tomcat_logs_backups/tomcat-itb.$date.tgz   *
rm -f *

cd  /data/tomcat-gratia/logs/
tar zcf /data/gratia_tomcat_logs_backups/tomcat-gratia.$date.tgz  *
rm -f *

<b>On gratia08:</b>
date=`date '+%Y%m%d'`
cd        /data/tomcat-fermi_itb/logs/
tar zcf /data/gratia_tomcat_logs_backups/tomcat-fermi_itb.$date.tgz   *
rm -f *

cd  /data/tomcat-qcd/logs/
tar zcf /data/gratia_tomcat_logs_backups/tomcat-qcd.$date.tgz     *
rm -f *

cd     /data/tomcat-fermi_osg/logs/
tar zcf /data/gratia_tomcat_logs_backups/tomcat-fermi_osg.$date.tgz  *
rm -f *

</pre>
</li>
<p />
<li>Start the gratia tomcat services:
<pre class="screen">
&gt; service &lt;tomcat service&gt; start
</pre>
<p />
When the tomcat service initializes, it will detect that schema changes have been effected and a conversion process will begin.
</li>
<p />
<li>When complete (<code>catalina.out</code> contains the message, "INFO: Server startup in _xxx_ms") <strong><em>start</em></strong> the Gratia update services for the database schema just upgraded.<br />    
            - In your browser, connect to the Gratia administrative services url for each of the databases.<br />    
            - Select the <em>System / Administration</em> menu option in the left menu<br />    
            - Then scroll down to the <em>Starting/Stopping Database Update Services</em> section and select the <em>Start Update Services</em> link.
<p />
   <ul>
     <li> As <strong><em>each</em></strong> collector/tomcat host update service is started, monitor the tomcat logs files for any errors.</li>
     <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.</li>
    </ul>
<p />
<li>If satisifed, <strong><em>stop</em></strong> the tomcat service for that tomcat database schema so you can proceed to the next one.<pre class="screen">&gt; service &lt;tomcat service&gt; stop</pre></li>
</ol>
<p />
Summary of conversion times:
<p />
<a name="edittable3"></a>
<div class="editTable">
<form name="edittable3" action="https://twiki.opensciencegrid.org/bin/viewauth/Accounting/GratiaReleaseV0dot28#edittable3" method="post">
<input type="hidden" name="ettablenr" value="3" />
<input type="hidden" name="etedit" value="on" />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="1" id="table3" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=0;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Schema</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol1"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=1;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Collector</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol2"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=2;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol3"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=3;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Size (rows)</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol4"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=4;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Wall clock</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol5"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=5;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Elapsed</font></a> </th>
			<th bgcolor="#99CCCC" valign="top" class="twikiTableCol6 twikiLastCol"> <a rel="nofollow" href="/bin/view/Accounting/GratiaReleaseV0dot28?cover=print;sortcol=6;table=3;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Conversion time</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> fermi_itb </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia08 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol2"> 724K </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol3"> 1 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 21:25 - 21:25 </td>
			<td bgcolor="#FFFFCC" align="center" valign="top" class="twikiTableCol5"> 00:01 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol6 twikiLastCol"> INFO: Server startup in 14786 ms </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_qcd </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1"> gratia08 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol2"> 2.2G </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol3"> 804,418 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4"> 21:28 - 21:30 </td>
			<td bgcolor="#FFFFFF" align="center" valign="top" class="twikiTableCol5"> 00:02 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol6 twikiLastCol"> INFO: Server startup in 166889 ms </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_osg_integration </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia09 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol2"> 3.1G </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol3"> 815,371 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 21:34 - 21:34 </td>
			<td bgcolor="#FFFFCC" align="center" valign="top" class="twikiTableCol5"> 00:01 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol6 twikiLastCol"> INFO: Server startup in 14582 ms </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol"> fermi_osg </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1"> gratia08 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol2"> 4.3G </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol3"> 2,237,912 </td>
			<td bgcolor="#FFFFFF" align="center" valign="top" class="twikiTableCol4"> 21:38 - 21:49 </td>
			<td bgcolor="#FFFFFF" align="center" valign="top" class="twikiTableCol5"> 00:11 </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol6 twikiLastCol"> INFO: Server startup in 634547 ms </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol0 twikiFirstCol"> gratia_itb </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol1"> gratia09 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol2"> 15G </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol3"> 2,688,424 </td>
			<td bgcolor="#FFFFCC" align="right" valign="top" class="twikiTableCol4"> 22:12 - 23:26 </td>
			<td bgcolor="#FFFFCC" align="center" valign="top" class="twikiTableCol5"> 01:14 </td>
			<td bgcolor="#FFFFCC" valign="top" class="twikiTableCol6 twikiLastCol"> INFO: Server startup in 4474992 ms </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> gratia </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol1 twikiLast"> gratia09 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol2 twikiLast"> 47G </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol3 twikiLast"> 26,476,198 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol4 twikiLast"> 00:34 - 14:12 </td>
			<td bgcolor="#FFFFFF" align="right" valign="top" class="twikiTableCol5 twikiLast"> actually 17:21 long long time (end was Monday) </td>
			<td bgcolor="#FFFFFF" valign="top" class="twikiTableCol6 twikiLastCol twikiLast"> INFO: Server startup in 135479183 ms </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<input type="hidden" name="etrows" value="7" />
<input class="twikiButton editTableEditButton" type="submit" value="Edit table" /> </form>
</div><!-- /editTable -->
<p />
<p />
<p />
<b>Note: the size of the gratia schema at the time of conversion has been reduced from 81Gb to 47Gb prior to conversion due to the optimization of the JobUsageRecord_Xml table.</b>
<p />
<b>Notes on <em>gratia_itb</em>  conversion:</b>  <ol>
<li> DupRecord table appears to be causing a problem with gratia_itb conversion.  It has 6.9M rows.  The gratia only has 15K rows and fermi_osg only had 12K.  It has to be the reason it is taking so long compared to fermi_osg.  Deleted these after conversion completed.
</li></ol> 
<p />
<b>Notes on <em>gratia</em>  conversion:</b> 
<ol>
<li>
As of 10/28/07 08:40, schema is still being updated.  It is currently in this state:
<pre>
mysql> show processlist;
+--------+--------+-------------------------+------------+---------+-------+----------------------+------------------------------------------------------------+
| Id     | User   | Host                    | db         | Command | Time  | State                | Info                                                       |
+--------+--------+-------------------------+------------+---------+-------+----------------------+------------------------------------------------------------+
| 672862 | gratia | gratia09.fnal.gov:25627 | gratia     | Query   | 28916 | Repair with keycache | alter table JobUsageRecord_Meta add column probeid integer | 
| 672907 | root   | localhost               | gratia     | Query   |     0 | NULL                 | show processlist                                           | 
+--------+--------+-------------------------+------------+---------+-------+----------------------+------------------------------------------------------------+
</pre>
</li>
<p />
<li>As of 10/28/07 10:05, it appears it is still successfully doing the conversion.  It is still in the same state as it was at 08:40, but I noticed the database size as grown to 53Gb.  So something must still be happening.
</li>
<p />
</ol>
<p />
<p />
<!-- ----------------- ACTIVATING THE NEW RELEASE ------------- -->
<h1><a name="Activating_the_new_release"></a> Activating the new release </h1>
  <ol type="1">
     <li>On <em>gratia06</em> , <strong><em>uncomment</em></strong>   the <em>mysqlhotcopy_cron</em> entry<pre class="screen">43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1</pre>
<b>Status: Done 10/29/07 17:48</b>
</li>
     <li> For <strong><em>ALL</em></strong> of the databases ( <strong><em>including those not be upgraded</em></strong> ), <strong><em>verify</em></strong> the Gratia update services are active.<br />    
            - In your browser,  connect to the Gratia administrative services url for each of the databases.<br />    
            - Select the <em>System / Administration</em> menu option in the left menu<br />    
            - Then scroll down to the <em>Starting/Stopping Database Update Services</em> section and and view the status.
<p>
<b>Status: Done 10/29/07 17:45</b>
      </li>
<p />
     <li> On <strong><em>each</em></strong> collector/tomcat host, <strong><em>start</em></strong> the tomcat service for the Gratia collectors.<pre class="screen">On gratia09:
  service tomcat-gratia start  
  service tomcat-itb start
  service tomcat-osg_daily start
  service tomcat-osg_integration start

On gratia08:
  service tomcat-fermi_itb  start
  service tomcat-fermi_osg start
  service tomcat-ps start
  service tomcat-qcd start</pre>
<p />
<b>Status: Done 10/29/07 17:45</b>
</li>
<p />
   <li> As <strong><em>each</em></strong> collector/tomcat host service is started, monitor the tomcat logs files for any errors.
<b>Status: Done 10/29/07 17:45</b>
</li>
<p />
   <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.
<b>Status: Done 10/29/07 17:45</b>
</li>
<p />
    <li>On <em>gratia06</em>, <b>uncomment</b>  the <em>gratia</em> user cron jobs.
<b>Status: Done 10/29/07 17:51</b>
</li>
<p />
    <li>
         <b>Remember to change the following back:</b> <ul>
<li> replication on gratia-itb   <b>Status: Done 10/29/07 18:51</b>
</li> <li> init.d services on gratia08 - tomcats   <b>Status: Done 10/29/07 17:45</b>
</li> <li> init.d services on gratia09 - tomcats   <b>Status: Done 10/29/07 17:45</b>
</li> <li> init.d services on gratia01 - for the tomcat-itb_control   <b>Status: Done 10/29/07 18:54</b> 
</li> <li> also on gratia01 - change the <em>./gratia/service-configuration.properties</em> back from pointing to gratia06 to pointing to gratia07 again.  <b>Status: Done 10/29/07 18:51</b>    </li>
</li></ul> 
</ol>
<p />
<p />
<!-- ----------------- POST MORTEM  ------------- -->
<h1><a name="Post_mortem"></a> Post-mortem </h1>
At this time, this will appear to be random notes.  After the conversion, they may be organized.
<p />
<ol>
<li>Configuring MySql to optimally use the 6Gb of memory on <em>gratia06</em>.
   <ul><li>Both <em>gratia06</em> and <em>gratia07</em> should be configured the same.</li>
            <li>Both nodes are using a UPS version of <span class="twikiNewLink">MySql<a href="/bin/edit/Accounting/MySql?topicparent=Accounting.GratiaReleaseV0dot28" rel="nofollow" title="MySql (this topic does not yet exist; you can create it)">?</a></span> which should probably be changed.<br />    
                    The <em>my.cnf</em> on <em>gratia06</em> is actually a symbolic link to the ups area.  </li>
             <li>The init.d services on both hosts should be explicitly setting the <em>my.cnf</em> used so there is no confusion</li>
     </ul>       
</li>
<p />
<p />
<li>The administrative capability to start/stop the collector update services.<br />    
        One problem with trying to perform a smooth conversion (and also adds an element of risk) is the "feature" that activates the <em>update services</em> on the restart  of <em>tomcat</em> .   This activation occurs after <em>tomcat</em> is started and any database conversions are performed.  It would be nicer is the service remembered it's previous state.  Then after a database conversion, you would be able to validate the database prior to any updates being applied.
<p />
</li>
<p />
<p />
<li>Backups:  mysqlhotcopy is using the /usr/bin/ version and not the UPS version that the database is using.  Need to verify if they are one and the same.  If not, this may not be good.
</li>
<p />
<li>Noticed as I was monitoring gratia_itb that I am still having queries come in which can affect conversions... these should be blocked out.
<pre>
| 330688 | reader | osg-test2.unl.edu:36169                   | gratia     | Query   |    1 | Copying to tmp table | SELECT
             R.VOName   ,
          unix_timestamp(EndTime),
             sum(WallDuration)/3 | 
</pre>
</li>
<p />
<li>Forgot about Replication and I think it had a big impact on the gratia_itb schema.  Not sure if it is what is causing the java exceptions.<br> <ul>
<li> stop tomcat at 32:50
</li> <li> ran: delete from <span class="twikiNewLink">DupRecord<a href="/bin/edit/Accounting/DupRecord?topicparent=Accounting.GratiaReleaseV0dot28" rel="nofollow" title="DupRecord (this topic does not yet exist; you can create it)">?</a></span> where error = 'Duplicate';
</li></ul> 
</li>
<p />
<li>One thing I forgot to do which I had thought of was to back up the webapps and gratia areas on tomcat which would allow me to restore to the old software easily.  Still can grab them from the 2 tomcats that have not been converted, maybe.  A couple ./gratia files will need to be tweeked. Must do this in future.
</li>
<p />
<li><b>Important:</b> From Chris: must remember to <i>stop</i> update services on the administrative menu before taking tomcat down.  Need to add this to my update scripts for VDT when updating from new build.  Should be a  way of doing this in a shutdown type script. <ul>
<li> Question-like or something to look into: Does the <i>update_gratia_local</i> or the instructions say to do this?
</li></ul> 
</li>
<p />
<li>
<b>Things  to consider:</b>  <ul>
<li> Move the <i>start/stop</i> update services to the main administrative window showing state of service and links/buttons to start/stop services.  Right now it is too hidden being on the administrative screen and buried in the middle.
</li> <li> We need to test another approach to adding/removing columns from huge tables like JobUsageRecord* tables.  We should be able to test alternatives now on the gratia07 mysql instance since it is smaller.
</li></ul> 
</li>
<p />
<li>There are some Gratia daily reports that kick off around 07:00 each morning that should be stopped  when converting.  Not sure where they come from.  Need to document somewhere.
<li>
<p />
<li>
After taking all tomcat services down to start conversion, should re-cycle mysql database to clear everything.  This maybe should be done after each schema conversion.  This is something Chris mentioned last night.
</li>
<p />
<li>Maybe found a way to see the progress the conversion is making (this is as of 10/28 10:49):
<pre>
cd /data/mysqldb/gratia
ls -ltr
-rw-------  1 gratia gratia   201636864 Oct 28 00:27 JobUsageRecord_Xml.MYI
-rw-------  1 gratia gratia 21080917896 Oct 28 00:27 JobUsageRecord_Xml.MYD
-rw-rw----  1 gratia gratia  2513827840 Oct 28 00:27 JobUsageRecord_Meta.MYI
-rw-rw----  1 gratia gratia  3781450376 Oct 28 00:27 JobUsageRecord_Meta.MYD
-rw-------  1 gratia gratia  2155423744 Oct 28 00:27 JobUsageRecord.MYI
-rw-------  1 gratia gratia 12936377424 Oct 28 00:27 JobUsageRecord.MYD
-rw-rw----  1 gratia gratia     8260152 Oct 28 00:27 HostDescriptionProbeSummary.MYD
-rw-rw----  1 gratia gratia        9186 Oct 28 00:34 #sql-66c4_a445e.frm
-rw-rw----  1 gratia gratia  3781435492 Oct 28 08:12 #sql-66c4_a445e.MYD
-rw-rw----  1 gratia gratia  1775113216 Oct 28 10:48 #sql-66c4_a445e.MYI
</pre>
<p />
This appears to show it is about 3/4 (don't check my math)  through re-building the index.  However, on second thought, it could be close to done at this time and the schema change was to use the probeid instead of the probename to reduce the size of the index.  This is showing it is getting updated as time goes by, but the size is not changing.  The table itself (MYD) appears to have completed at 08:12 and the index is still being played with.
<pre>
-rw-rw----  1 gratia gratia  3781450376 Oct 28 00:27 JobUsageRecord_Meta.MYD
-rw-rw----  1 gratia gratia  3781435492 Oct 28 08:12 #sql-66c4_a445e.MYD

-rw-rw----  1 gratia gratia  2513827840 Oct 28 00:27 JobUsageRecord_Meta.MYI
-rw-rw----  1 gratia gratia  1775113216 Oct 28 10:59 #sql-66c4_a445e.MYI
</pre>
<p />
This also explains the apparent growth in the database from 47Gb to 53Gb.  This should drop back down after it completes the re-building.
</li>
<p />
<li>Should turn off init.d services on startup and turn back on when upgrades complete, at least for tomcats on 08 and 09
<pre>
chkconfig tomcat-blah off|on
</pre>
</li>
<p />
<li>
Another thought: We started up a tomcat on gratia01: /opt/tomcat-itb_control pointed to gratia07 mysql.  Can we find a way outside of using <em>apache</em> to easily redirect the <a href="mailto&#58;gratia&#64;opensciencegrid&#46;org">gratia&#64;opensciencegrid.org</a> url in the event this occurs again.  
</li>
<p />
</ol>
<p />
<p />
<p />
<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Major_updates"></a>  Major updates </span></h2>
<!--Future editors should add their signatures beneath yours!-->
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - 25 Oct 2007</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>GratiaReleaseV0dot28</span> <br />    
Topic revision: r24 - 11 Dec 2008 - 18:51:44 - <a href="/bin/view/Main/KyleGross" class="twikiLink">KyleGross</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />