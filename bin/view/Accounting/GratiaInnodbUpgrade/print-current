<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> GratiaInnodbUpgrade &lt; Accounting &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Accounting/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Accounting/GratiaInnodbUpgrade?_T=16 Feb 2017" type="application/x-wiki" title="edit GratiaInnodbUpgrade" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Accounting/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Accounting/GratiaInnodbUpgrade"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Gratia_Innodb_Upgrade_Procedure"></a>  Gratia Innodb Upgrade Procedure </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Gratia_Innodb_Upgrade_Proced_AN1"> Gratia Innodb Upgrade Procedure</a> <ul>
<li> <a href="?cover=print#Overview"> Overview</a>
</li> <li> <a href="?cover=print#Setup_the_temporary_gratiax23_to"> Setup the temporary <b>gratiax23</b> tomcat and <b>gratia07</b> database</a>
</li> <li> <a href="?cover=print#Bring_the_gratia07_into_sync_wit"> Bring the <b>gratia07</b> into sync with the <b>gratia06</b></a>
</li> <li> <a href="?cover=print#Switch_the_gratia09_tomcat_to_us"> Switch the <b>gratia09</b> tomcat to use the <b>gratia07</b> database</a>
</li> <li> <a href="?cover=print#Effect_the_conversion_using_grat"> Effect the conversion using <b>gratiax23</b> tomcat and <b>gratia06</b> database</a>
</li> <li> <a href="?cover=print#Bring_the_gratia06_into_sync_wit"> Bring the <b>gratia06</b> into sync with the <b>gratia07</b></a>
</li> <li> <a href="?cover=print#Switch_gratia09_tomcat_back_to_t"> Switch <b>gratia09</b> tomcat back to the <b>gratia06</b> database</a>
</li></ul> 
</li></ul> 
</div>
<p />
<p />
<!-- <ul>
<li> Set EDITTHISTEXT = <div class="twikiSmall"><a href="GratiaInnodbUpgrade">edit this section</a></div>
</li></ul> 
<p /> <ul>
<li> Set PROD_VER      = <b>v0.32.1b</b>
</li></ul> 
<p /> <ul>
<li> Set PROD_NODE    = <b>gratia09</b>
</li> <li> Set PROD_DB       = <b>gratia06</b>
</li> <li> Set PROD_TC       = <b><b>gratia09</b>:/data/tomcat-gratia</b>
</li> <li> Set PROD_TC_SERVICE = tomcat-gratia
</li> <li> Set PROD_URL      = <a href="http://gratia09.fnal.gov:8880" target="_top">http://gratia09.fnal.gov:8880</a>
</li></ul> 
<p /> <ul>
<li> Set TEMP_NODE    = <b>gratiax23</b>
</li> <li> Set TEMP_DB       = <b>gratia07</b>
</li> <li> Set TEMP_TC       = <b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b>
</li> <li> Set TEMP_TC_SERVICE = tomcat-55
</li> <li> Set TEMP_URL      = <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>
</li></ul> 
<p /> <ul>
<li> Set DB_NAME       = <b>gratia</b>
</li></ul> 
<p /> <ul>
<li> Set JUR               = JobUsageRecord
</li> <li> Set CONFIG          = <b>./gratia/service-configuration.properties</b>
</li></ul> 
-->
<p />
Database privileges: <ul>
<li> ./post-install.sh summary-view <ul>
<li> forces the update of the VIEWS.  There is a DEFINER= parameter in the VOProbeSummay view which contains the original database/collector used.  This can be reset by re-loading the views.
</li></ul> 
</li></ul> 
<p />
<p />
<p />
<h1><a name="Gratia_Innodb_Upgrade_Proced_AN1"></a> Gratia Innodb Upgrade Procedure </h1>
<div class="twikiSmall"><a href="GratiaInnodbUpgrade">edit this section</a></div>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Overview"></a> Overview </span></h2>
<p />
The intent is to minimize downtime (availability) of Gratia services.  This is a general outline and the details for each step will be addressed in a subsequent section.  This will also serve as a trial/template for future conversions where DB changes may require long conversion times. 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Setup_the_temporary_gratiax23_to"></a> Setup the temporary <b>gratiax23</b> tomcat and <b>gratia07</b> database </span></h2>
<ol>
  <li> Install the current production version (<b>v0.32.1b</b>) of Gratia on a test machine (<b>gratiax23</b>)
     <ol type="a">
      <li> To avoid complications and additional work, it is best if this is an instance that has <strong>no</strong> probes reporting to it.
      <li> Turn off the MySql instance to reduce resource consumption
<pre>
service mysql5 stop
</pre>
      <li> We are only using the tomcat web services and will be pointing it to the <b>gratia06</b> to effect the conversion.
      <li> To be safe, turn off the update services: on the gratia-administration screen, 
         <ul>
           <li> go to System--&gt;Administration, 
           <li> scroll down and click on the <em>Stop Update Services</em> link,
           <li> the <em>Current Status</em> should show <em>Stopped</em> 
          </ul>
       <li> <strong>Remember</strong> that every time you restart the <em>tomcat</em> service, the Gratia collector comes up in <em>Update</em> mode which <strong>will</strong> cause problems since we are converting the <strong>real</strong> database.  This is why using an instance that is assured of having no probes reporting to it is very important. 
      </ol>
<p />
   <li> We are going to be switching the <b><b>gratia09</b>:/data/tomcat-gratia</b> collector/reporter to use the <b>gratia07</b> database while the conversion takes place on <b>gratia06</b>.  So, to effect this, we need to do the following:
      <ol type="a">
      <li> Rather than take the <b>gratia06</b> database off-line to do a backup to <b>gratia07</b>, we will use the nightly backup (currently a <em>mysqlhotcopy</em>).
      <li> On <b>gratia07</b>:
         <ul>
         <li> The night before, remove all files under the <b>/data/mysqldb/<b>gratia</b></b> directory and set the ownership on the directory to <strong>gratia.mysql</strong>.
         <li> Also the night before, verify/set the users and privileges so the <b>gratiax23</b> has permissions to update the stored procedures:
<pre>
GRANT ALL ON *.* TO 'root'@'&lt;your collector ip address&gt;  identified by 'root password';
GRANT GRANT OPTION ON *.* TO 'root'@'&lt;your collector ip address&gt; 
<b>...note you can find the IP address by executing...
   host <b>gratiax23</b>.fnal.gov</b>
</pre>
            Also verify that the <b>gratia06</b> has the same root permissions for it's specific IP address.  If it doesn't, set them as above.
<p />
         <li> On the day of cutover, verify the ownership on the <b>/data/mysqldb/<b>gratia</b></b> directory and the ownership on the table files are <strong>gratia.mysql</strong>.  They will likely have been reset from the nightly backup.
<p />
         <li> If replication is in use, we need to turn it off temporarily and also be in a position to turn it back on once we have converted to using the <b>gratia07</b> database:
<pre>
<b>... this creates a file to be used when turning Replication back on .... </b>
select "update Replication set running=1 where replicationid=",replicationid,";" 
from Replication where running=1 into outfile '/tmp/jgw.sql';
<b>... be sure that the <i>outfile</i> does not already exist or it will fail</b>

<b>... then turn replication off for those ids</b>
update Replication set running=0 where running=1;
</pre>
<font color="#008000">DONE: 3/27/08 10:23 No Replication "running" on gratia database</font>
<p />
         <li> Update the <strong>SystemProplist</strong> table for the attributes below so the stored procedures, triggers and table statistics get updated correctly.
            <pre>
update SystemProplist set cdr=0 where car='gratia.database.storedProcedureVersion';
update SystemProplist set cdr=0 where car='gratia.database.summaryTriggerVersion';
update SystemProplist set cdr=0 where car='gratia.database.TableStatisticsVersion';

select * from SystemProplist;  

+--------+----------------------------------------+------+
| propid | car                                    | cdr  |
+--------+----------------------------------------+------+
|    211 | use.report.authentication              | true | 
|    212 | gratia.database.version                | 28   | 
|    214 | gratia.database.summaryTableVersion    | 26   | 
|    <b>215 | gratia.database.summaryTriggerVersion  |  0   | </b>
|    <b>216 | gratia.database.storedProcedureVersion |  0   | </b>
|    217 | gratia.database.wantSummaryTable       | 1    | 
|    218 | gratia.database.wantSummaryTrigger     | 1    | 
|    219 | gratia.database.wantStoredProcedures   | 1    | 
|    <b>220 | gratia.database.TableStatisticsVersion |  0   | </b>
+--------+----------------------------------------+------+
</pre>
<p />
<font color="#008000">DONE: 3/27/08 10:30 </font>
         </ul>
<p />
      <li> On <b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b>:
         <ul>
         <li> change the <b>./gratia/service-configuration.properties</b> file entries to use the <b>gratia07</b> database
         <pre>
service.mysql.url=jdbc:mysql://<b>gratia07</b>.fnal.gov:<b>3320</b>/<b>gratia</b>
<b>... use the values from the <b><b>gratia09</b>:/data/tomcat-gratia</b> instance....</b>
service.mysql.user=<b>xxxxx</b>
service.mysql.password=<b>xxxxx</b>
service.reporting.user=<b>xxxxx</b>
service.reporting.password=<b>xxxxx</b>
</pre>
         <li> Restart the tomcat service.  It's also not a bad idea to remove the log files so it is easier to spot any problems.
<pre>
service tomcat-55 stop
rm -f VDT_LOCATION/tomcat/v55/logs/*
service tomcat-55 start

<b>... since there should be no updates occurring, nor any replication 
         you should see only this line in the <i>catalina.out</i> file and
         no other activity</b>
INFO: Server startup in 14307 ms
</pre>
         <li>A couple of things to look for in the logs (other than obvious stacktrace errors) is any failures in updating the triggers, procedures, summary tables, or summary views:
<pre>
 grep -i fail ./logs/*  

grep "Summary trigger updated successfully" *
grep "Stored procedures updated successfully" *
grep "Summary tables updated successfully" *
grep "Summary view updated successfully" *
grep "Table statistics updated successfully" *
</pre>
           Another item to look for to verify you have connected to the right database would be to re-query the <em>SystemProplist</em> table on <b>gratia07</b>, checking
that the <em>cdr</em> value changed on those set to 0.
<pre>select * from SystemProplist;</pre>
<font color="#008000">DONE: 3/27/08 10:39 </font>
         </ul>
<p />
      <li> Verify you are connected correctly by bringing up the administration (<a href="http://gratiax23.fnal.gov:8880/gratia-administration" target="_top">http://gratiax23.fnal.gov:8880/gratia-administration</a>) page in your browser.  The counts shown and those on the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> page should be reasonably close with the only difference being the data collected since the <em>mysqlhotcopy</em> was performed.<br />    
<font color="#008000">DONE: 3/27/08 10:40 </font>
<p />
      <li>We need to create the static report files
         <ul>
         <li>Execute the following (as root):
<pre>
/usr/local/osg-collector/tomcat/v55/gratia/staticReports.py \
  /usr/local/osg-collector/tomcat/v55 \
  http://gratiax23.fnal.gov:8880/gratia-reporting
</pre>
          <li>Bring up the gratia reporting<br />     - <a href="http://gratiax23.fnal.gov:8880/gratia-reporting" target="_top">http://gratiax23.fnal.gov:8880/gratia-reporting</a>
<p />
          <li>Click on the <em>Static Reports</em> menu item and then verify each report comes up.
          </ul>
<font color="#ff0000">Don't think this makes any sense... re-evaluate</font>
      </ol>
</ol>
<p />
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Bring_the_gratia07_into_sync_wit"></a> Bring the <b>gratia07</b> into sync with the <b>gratia06</b> </span></h2>
We now have to "catch up" the <b>gratia07</b> database before switching the <b>gratia09</b> collector  to use it. 
<ol>
    <li> On <b>gratia07</b>, find the last <em>dbid</em>  for the JobUsageRecord table.
<!-- <ul>
<li> Set MAXDBID = 57907506
</li></ul> 
-->
<pre>
select max(dbid) from JobUsageRecord;
+-----------+
| max(dbid) |
+-----------+
|   57907506 | 
+-----------+
</pre>
<p />
    <li> On <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a>, add a replication entry pointing to <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a> and starting with the <em>dbid</em> from the previous step <em>+1</em>.  Be sure to test it..*Do not activate it yet.*
<p />
    <li>In the <b>gratia06</b> <b>gratia</b> database, set the <em>dbid</em> in the <em>Replication</em> table to the 57907506.
<pre>
select * from Replication where openconnection like '%<b>gratiax23</b>%';
update Replication set dbid=57907506  where openconnection like '%<b>gratiax23</b>%';
</pre>
<p />
<font color="#ff0000">Replication will not render.  Doing this in mysql client.
<pre>
 insert into Replication VALUES(NULL,0,0,0,"http://gratiax23.fnal.gov:8880",NULL,1,57907506,0,"All",NULL);

replcationid=50

update Replication set running=1 where replicationid=50;
</pre>
DONE: 3/27/08 11:03
</font>
<p />
    <li> Now back on the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, refresh the screen and verify the <em>dbid</em> value.
<p />
    <li> If all is well, click the <em>Start</em> button.  Then watch for a while in the <b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b> logs files for any errors.  You can also watch on the <a href="http://gratiax23.fnal.gov:8880/gratia-administration" target="_top">http://gratiax23.fnal.gov:8880/gratia-administration</a> <em>Status</em> screen.
<p />
    <li> On <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a>, go to the <em>System --&gt; Administration</em> page and then to <em>Starting/Stopping Database Update Services</em>  section and select the <em>Stop Update Services</em> link.    This will queue any updates and allow the two instances to sink without losing any data.
<p />
    <li> <strong>WAIT UNTIL</strong> the <em>All Time Total</em> numbers are equal for both <a href="http://gratia09.fnal.gov:8880" target="_top">http://gratia09.fnal.gov:8880</a> and <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>. Then we are caught up and can proceed.<br />    
<font color="#008000">Started - 11:07  Ended -    </font>
<p />
    <li> On the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, <strong>Stop</strong> the replication for <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>.  
<p />
    <li> On the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, <strong>Delete</strong> the replication for <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>.
<p />
   <li>On <b>gratiax23</b>, stop the tomcat service.  This positions us to switch the <b><b>gratia09</b>:/data/tomcat-gratia</b> tomcat service to using the <b>gratia07</b> database.
        <pre>service tomcat-55 stop</pre>
</ol>
<p />
<p />
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Switch_the_gratia09_tomcat_to_us"></a> Switch the <b>gratia09</b> tomcat to use the <b>gratia07</b> database </span></h2>
On <b>gratia09</b>, switch the  tomcat instance using the <b>gratia06</b> database to the backup on <b>gratia07</b>. The <b>gratia07</b> database will be used for for production until the conversion is complete on <b>gratia06</b>.
<p />
This will be the first <em>downtime</em> period for the <b>gratia</b> Gratia service.
<p />
<ol><li>Stop the tomcat-gratia
           <pre>service tomcat-gratia stop</pre>
<p />
      <li>Edit the <em><b><b>gratia09</b>:/data/tomcat-gratia</b>/gratia/service-configuration.properties</em> file changing the <em>service.mysql.url</em> attribute to reference the <em><b>gratia07</b></em> database.
            <pre>service.mysql.url=jdbc:mysql://<b>gratia07</b>.fnal.gov:3320/<b>gratia</b> </pre>
<p />
   <li>Start the tomcat-gratia
           <pre>service tomcat-gratia service</pre>
        It would probably be a good idea to <em>tail</em> the log files for a period to verify all is well.
<p />
</ol>
<p />
<p />
<p />
<p />
<p />
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Effect_the_conversion_using_grat"></a> Effect the conversion using <b>gratiax23</b> tomcat and <b>gratia06</b> database </span></h2>
<p />
<ol>
   <li> On <b>gratiax23</b>, the tomcat instance should have already been stopped.  If not, do it <strong>quickly</strong>.
<pre>
service tomcat-55 stop
</pre>
<p />
  <li> On <b>gratiax23</b>, edit the <em><b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b>/gratia/service-configuration.properties</em> file changing the <em>service.mysql.url</em> attribute to reference the <em><b>gratia06</b></em> database.
            <pre>service.mysql.url=jdbc:mysql://<b>gratia06</b>.fnal.gov:3320/<b>gratia</b> </pre>
       <strong>It is very important that this step be performed or the result will most likely be a mess.</strong>
<p />
  <li> On <b>gratiax23</b>, edit the <b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b>/gratia/hibernate.cfg.xml file changing:
<pre>
         &lt;!-- SQL dialect --&gt;
<b>from.</b> &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
<b>to..</b> &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLInnoDBDialect&lt;/property&gt;
</pre>
<p />
     <li> On <b>gratia06</b>, verify/set the users and privileges so the <b>gratiax23</b> has permissions to update the stored procedures:
<pre>
GRANT ALL ON *.* TO 'root'@'&lt;your collector ip address&gt;  identified by 'root password';
GRANT GRANT OPTION ON *.* TO 'root'@'&lt;your collector ip address&gt; 
<b>...note you can find the IP address by executing...
   host <b>gratiax23</b>.fnal.gov</b>
</pre>
<p />
  <li> On <b>gratiax23</b>, start the gratia tomcat services:
<pre>
service tomcat-55 start
</pre>
<p />
  <li> On <b>gratiax23</b>, when the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
     <ol type="a">
        <li> <em>tail</em> the  <em>catalina.out</em> log  
        <li>When the conversion process completes the log will show the following message:
<pre>INFO: Server startup in _xxx_ms</pre>
      </ol>
<p />
   <li> <strong>Wait until the previous step completes before proceeding.</strong>
<p />
</ol>
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Bring_the_gratia06_into_sync_wit"></a> Bring the <b>gratia06</b> into sync with the <b>gratia07</b> </span></h2>
Before we switch the <b>gratia09</b> tomcat service back to using the <b>gratia06</b>, we have to do a "catch up" on the data the <b>gratia07</b> has been collecting while the conversion was being performed.
<p />
<ol>
         <li> On <b>gratia06</b>, find the last <em>dbid</em>  for the JobUsageRecord table.
<!-- <ul>
<li> Set NEW_MAXDBID = 8054381
</li></ul> 
-->
<pre>
select max(dbid) from JobUsageRecord;
+-----------+
| max(dbid) |
+-----------+
|   8054381 | 
+-----------+
</pre>
<p />
    <li> On <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a>, add a replication entry pointing to <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a> and starting with the <em>dbid</em> from the previous step <em>+1</em>.  Be sure to test it..*Do not activate it yet.*
<p />
    <li>On <b>gratia07</b> in the <b>gratia</b> database, set the <em>dbid</em> in the <em>Replication</em> table to the 8054381.
<pre>
select * from Replication where openconnection = 'http://gratiax23.fnal.gov:8880';
update Replication set dbid=8054381  where openconnection = 'http://gratiax23.fnal.gov:8880';
</pre>
<p />
    <li> Now back on the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, refresh the screen and verify the <em>dbid</em> value.
<p />
    <li> If all is well, click the <em>Start</em> button.  Then watch for a while in the <b><b>gratiax23</b>:VDT_LOCATION/tomcat/v55</b> logs files for any errors.  You can also watch on the <a href="http://gratiax23.fnal.gov:8880/gratia-administration" target="_top">http://gratiax23.fnal.gov:8880/gratia-administration</a> <em>Status</em> screen.
<p />
    <li> On <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a>, go to the <em>System --&gt; Administration</em> page and then to <em>Starting/Stopping Database Update Services</em>  section and select the <em>Stop Update Services</em> link.    This will queue any updates and allow the two instances to sink without losing any data.
<p />
    <li> <strong>WAIT UNTIL</strong> the <em>All Time Total</em> numbers are equal for both <a href="http://gratia09.fnal.gov:8880" target="_top">http://gratia09.fnal.gov:8880</a> and <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>. Then we are caught up and can proceed.
<p />
     <li> On the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, <strong>Stop</strong> the replication for <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>.  
<p />
    <li> On the <a href="http://gratia09.fnal.gov:8880/gratia-administration" target="_top">http://gratia09.fnal.gov:8880/gratia-administration</a> replication screen, <strong>Delete</strong> the replication for <a href="http://gratiax23.fnal.gov:8880" target="_top">http://gratiax23.fnal.gov:8880</a>.
<p />
    <li>On <b>gratiax23</b>, stop the tomcat service.  This positions us to switch the <b><b>gratia09</b>:/data/tomcat-gratia</b> tomcat service to using the <b>gratia06</b> database.
        <pre>service tomcat-55 stop</pre>
</ol>
<p />
<p />
<p />
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Switch_gratia09_tomcat_back_to_t"></a> Switch <b>gratia09</b> tomcat back to the <b>gratia06</b> database </span></h2>
<ol>
   <li> On <b>gratia09</b>, stop the tomcat service for <b>gratia</b>.
<pre>
service tomcat-gratia stop
</pre>
<p />
  <li> On <b>gratia09</b>, edit the <em><b><b>gratia09</b>:/data/tomcat-gratia</b>/gratia/service-configuration.properties</em> file changing the <em>service.mysql.url</em> attribute to reference the <em><b>gratia06</b></em> database.
            <pre>service.mysql.url=jdbc:mysql://<b>gratia06</b>.fnal.gov:3320/<b>gratia</b> </pre>
       <strong>It is very important that this step be performed or the result will most likely be a mess.</strong>
<p />
  <li> On <b>gratia09</b>, edit the <b><b>gratia09</b>:/data/tomcat-gratia</b>/gratia/hibernate.cfg.xml file changing:
<pre>
         &lt;!-- SQL dialect --&gt;
<b>from.</b> &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
<b>to..</b> &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLInnoDBDialect&lt;/property&gt;
</pre>
<p />
<p />
  <li> On <b>gratia09</b>, start the gratia tomcat services:
<pre>
service tomcat-gratia start
</pre>
<p />
  <li> On <b>gratia09</b>, when the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
     <ol type="a">
        <li> <em>tail</em> the  <em>catalina.out</em> log  
        <li>When the conversion process completes the log will show the following message:
<pre>INFO: Server startup in _xxx_ms</pre>
      </ol>
<p />
   <li> <strong>WE ARE DONE  AND CAN BREATH AGAIN!!!!</strong>
<p />
</ol>
<p />
<p />
<p />
<hr width=95% />
<p />
<p />
<p />
<p />
<p />
<p />
<p />
<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Major_updates"></a>  Major updates </span></h2>
<!--Future editors should add their signatures beneath yours!-->
-- <a href="/bin/view/Main/JohnWeigand" class="twikiLink">JohnWeigand</a> - 26 Mar 2008</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Accounting<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Accounting/GratiaReleaseInnodb" class="twikiLink">GratiaReleaseInnodb</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>GratiaInnodbUpgrade</span> <br />    
Topic revision: r5 - 11 Dec 2008 - 18:51:43 - <a href="/bin/view/Main/KyleGross" class="twikiLink">KyleGross</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />