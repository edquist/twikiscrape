---++ Oasis outage of 5/Sep

---+++ Timeline
   * September 4, Dave Dykstra pointed out that OASIS&#39;s catalog had grown to 300MB compressed; suggested adding sub-catalogs in a manner similar to other CVMFS installs to reduce mount times / initial download size.  Addition of sub-catalogs is a user-level (not root-level) action and not under change management.
   * September 5, Scott Teige added sub-catalogs to OASIS server and initiated an update. (between midnight and 7am CST, added incrementally)
   * Initial diagnostic that a problem existed was that a snapshot on the GOC stratum1 failed. Error messages indicated the problem was with the CSIU VO.
   * Removed the subcatalog for CSIU and tried again; snapshot process was fine.  Tested end to end discovered the repository at the worker node level appeared empty.
   * Examination of the stratum 0 showed the catalog to be empty.
   * In consultation with Brian Bockelman and Dan Bradley, a method to incrementally rebuild the catalog from scratch was found.  Rebuild began between 9-10 am CST.
   * Rebuild mechanism was tested and shown to work on a subset of the repository. This allowed an estimate of total recovery time to be made.
   * An [[http://osggoc.blogspot.com/2013/09/oasis-outage.html][outage announcement]] was made at 11:30 am CST.  Recovery was in progress.
   * VOs were recovered one-by-one until 7 am the following day.
   * Total recovery time was 19 hrs; total outage was 24 hrs.
   * Dave Dykstra worked to roll back Strata 1 at FNAL.  2.0 version keeps information necessary for rolling back to prior version; pulled this from the OSG S1 (12:00PM CST) and did a rollback on FNAL (13:00 CST) and BNL S1 (14:00 CST).
   * Client refuses to rollback versions, this action was not effective.

---+++ Root cause
   * The event was caused by an as yet unidentified bug in CVMFS server software.

---+++ Restoration of service
   * Renaming a directory in the source tree and un-renaming it followed by a CVMFS publish forced a rebuild of the part of the catalog associated with the directory
   * Process was applied to all top level directories in the repository

---+++ Remediation
   * The Stratum 0 should keep the whitelist and publish files.
   * Document a procedure for rolling back the S0 and a S1
   * Develop sanity tests to determine if a publication should proceed
   * Take the S0 offline to prevent publication to S1&#39;s if a problem is detected

---+++ Requests to CVMFS developers:
   * Have client allow rollback.
   * Have procedure for &quot;faking&quot; newer version.  Request to backport for 2.0.
   * In v2.1, there are publish hooks for pre-publish and post-publish. Could these be useful to Oasis?
   * gWMS needs to re-probe validity of CVMFS throughout the lifetime of the glidein.

---+++ VO impact
   * CMS: safeguards to fallback to /cvmfs/cms.cern.ch did not work.
   * CMS T1 will have a &quot;kill switch&quot; or unset $OSG_APP for only CMS jobs.
      * Nebraska will follow-up / test this again in future.
   * vo=OSG: No jobs that required CVMFS were in the queue at the time of the outage.
   * Jobs would have been put on hold.
      * Must verify the OSG verify script would have caught this. Review / improve script?
 
---+++ SLA modifications
   * SLA as currently written may or may not have defined this event as an outage
   * SLA should require data integrity.
   * Should be updated to require S1 have the ability to rollback to a prior, known-good version
   * Should define who is authorized to initiate this rollback.

---+++ Ongoing efforts
   * Determine a safe means to reduce catalog size
   * Reconstruct the event.  Scott has given the information necessary to Rene (a CVMFS developer)
   * Monitor catalog size per VO.
   * Create an &quot;at-scale&quot; ITB instance. Additional hardware may be required.
   * Consider a &quot;firedrill&quot; on rollbacks.
   * Discuss putting nova on a separate repository.

-- Main.ScottTeige - 19 Sep 2013

