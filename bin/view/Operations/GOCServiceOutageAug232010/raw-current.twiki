-- Main.ScottTeige - 24 Aug 2010

---+ DRAFT 

---++Outage Report, Friday 20 August through Monday 23 August

---+++ Incident Details:

On June 30, replication of the OIM MySQL database to sonofsam.uits.indiana.edu (SoS)
was halted in preparation for re-purposing of that machine. Originally, SoS was
intended to be used as a development machine for OIM related tasks.
SoS was not intended to be referenced by production services.

The halt of replication caused silent failure of the send of downtime records to consumers
of this data. On July 14 it was noticed that an availability calculation produced
an incorrect result. It was, erroneously, determined that the incorrect result
was due to differences in the OSG and WLCG algorithms. On July 21 another incorrect
result was observed and again, independently, diagnosed as an algorithm difference.

On August 19, as a followup, the results were again examined and the original
analyst attempted a manual query of the SoS database. At this time it was observed
that there were no updates since June 30. The scripts were examined and it was determined
that SoS was being referenced in one of them.

On August 20 replication of the the OIM MySQL database to the RSV-SAM server machine
began. The effected script was modified to reference this database. This modification
caused the RSV-SAM uploader to fail for reasons that are under investigation.

---+++ Immediate Action:

At 4:35 EST August 23, it was reported that no RSV_SAM messages had been received
since August 20. By 10:30 EST the scripts had been reverted to their original versions
and the missing data re-sent.

---+++ Current Status:

At this time, OIM based reporting remains non-functional but it is possible to
manually send the data. This is being done once per day. The RSV-SAM version is
currently implemented and it has been verified current messages are being received.

---+++ Root Cause Analysis:

1) A change outside a Tuesday change window was implemented.

2) A production service referenced a non-production database.

---+++ Future Actions:

Details of the permanent repair and a set of tests to be performed prior to implementation
are currently being investigated and will be reported here as they are developed.

Both the OIM and RSV-SAM problems are in a perl module included by other scripts
to perform these tasks. A version of this module that works for OIM but not RSV-SAM
exists and a version that works for RSV-SAM but not OIM also exists. Since the RSV-SAM
version works even with the stale database, it cannot actually depend on that database.
The path to a permanent repair of this problem involves locating the unnecessary and
erroneous database references in the RSV-SAM version and removing them.

Investigations as to how this data is consumed downstream of the GOC will be carried out.
These investigations may lead to a change in criticality of these services.
 
Monitoring of these services at the GOC will be implemented.
  
Update, 31/Aug:
   * Connection requests to SoS are being logged to determine what external entities are accessing SoS
      * 129.93.239.156 (osg-test4.unl.edu) Nebraska at Lincoln (accepted)
      * 134.68.22.136 (oim.grid.iu.edu) Indiana University (accepted)
      * 129.79.14.137 (dahmer.uits.indiana.edu) Indiana University (accepted)
      * iptables_dropped:  1 tcp packet from 128.142.166.159 (sam202.cern.ch) port 36867
      * iptables_dropped:  1 tcp packet from 128.142.166.159 (sam202.cern.ch) port 47507
   * James Casey confirms the data sent to SAM is used only for accounting reports. It is unknown (but unlikely) it is being used by any VOs.
   * A service monitor has been installed and tested.
   * Unsent data:
      * 08-24 12:30 through 08-25 00:31
      * 08-25 06:31 through 08-26 14:30
      * 08-26 22:35 through 08-27 15:30


