<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> AccountingInteropQuestionsAndIssues &lt; Interoperability &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Interoperability/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Interoperability/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Interoperability/AccountingInteropQuestionsAndIssues?_T=16 Feb 2017" type="application/x-wiki" title="edit AccountingInteropQuestionsAndIssues" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Interoperability/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Interoperability/AccountingInteropQuestionsAndIssues"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#FFFFCC;
	}
	.patternBookView {
		border-color:#FFFFCC;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <!-- <ul>
<li> Set <span class="twikiNewLink">SummaryRecords<a href="/bin/edit/Interoperability/SummaryRecords?topicparent=Interoperability.AccountingInteropQuestionsAndIssues" rel="nofollow" title="SummaryRecords (this topic does not yet exist; you can create it)">?</a></span> = <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a>
</li> <li> Set <span class="twikiNewLink">JobRecords<a href="/bin/edit/Interoperability/JobRecords?topicparent=Interoperability.AccountingInteropQuestionsAndIssues" rel="nofollow" title="JobRecords (this topic does not yet exist; you can create it)">?</a></span> = <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Job_Records" target="_top">individual Job Records</a>
</li> <li> Set <span class="twikiNewLink">SummarySyncRecords<a href="/bin/edit/Interoperability/SummarySyncRecords?topicparent=Interoperability.AccountingInteropQuestionsAndIssues" rel="nofollow" title="SummarySyncRecords (this topic does not yet exist; you can create it)">?</a></span> =<a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Sync_Records" target="_top">Summary Sync Records</a>
</li></ul> 
-->
<p />
<p />
<h1><a name="Accounting_Systems_Interoperabil"></a> Accounting Systems Interoperability Questions And Issues </h1>
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Accounting_Systems_Interoperabil"> Accounting Systems Interoperability Questions And Issues</a> <ul>
<li> <a href="?cover=print#Introduction"> Introduction</a>
</li> <li> <a href="?cover=print#APEL_SSM_ActiveMQ_interface"> APEL SSM/ActiveMQ interface</a> <ul>
<li> <a href="?cover=print#References"> References</a>
</li> <li> <a href="?cover=print#Release_date"> Release date</a>
</li> <li> <a href="?cover=print#SSM_Installation"> SSM Installation</a>
</li> <li> <a href="?cover=print#Direct_DB_Access_vs_Messaging"> Direct DB Access vs Messaging</a>
</li> <li> <a href="?cover=print#APEL_SSM_message_format"> APEL SSM message format</a>
</li> <li> <a href="?cover=print#SSM_External_Testing"> SSM External Testing</a>
</li> <li> <a href="?cover=print#Retrieval_Publishing_of_APEL_EGI"> Retrieval/Publishing of APEL/EGI data</a> <ul>
<li> <a href="?cover=print#Topology_data_aka_org_Tier1_2_ta"> Topology data (aka org_Tier1/2 tables)</a>
</li> <li> <a href="?cover=print#OSG_site_data_aka_OSG_CN_DATA"> OSG site data (aka OSG_CN_DATA)</a>
</li></ul> 
</li></ul> 
</li> <li> <a href="?cover=print#SSM_Testing"> SSM Testing</a>
</li> <li> <a href="?cover=print#Comments"> Comments</a>
</li></ul> 
</li></ul> 
</div>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Introduction"></a> Introduction </span></h2>
This is where all current questions and issues related to interoperability of the Accounting Systems should be listed.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="APEL_SSM_ActiveMQ_interface"></a> APEL SSM/ActiveMQ interface </span></h2>
Currently, the Gratia/APEL interface sends the selected Gratia data to WLCG by performing  a direct SQL DML update of a table (OSG_CN_DATA)  in the APEL accounting database.  This will be changing sometime in the future and will be using an SSM/ActiveMQ method to perform this.  There will no longer be any direct access to the APEL database.
<p />
This section provides some references/notes/questions on this new interface.
<p />
<h3><a name="References"></a> References </h3>
<a href="https://wiki.egi.eu/wiki/APEL/Server" target="_top">APEL/Server</a>:
This page references a record publisher component which, on the surface, sounds like the capability to retrieve data from APEL.  However, there is no further information about it.<br />    
<font color="#0000ff">Will there be the  capability to retrieve data from the APEL database via this new protocol?
</font><br />    
<font color="#008000">(Tanya 10/something) They claim that it is possible but not documented. We will need to increase pressure or a least ask them for examples. 
</font><br />    
<p />
<a href="https://wiki.egi.eu/wiki/APEL/SSMOverview" target="_top">SSM Overview</a>:
This messaging system will replace the current direct access SQL DML update/access to the APEL database table for OSG (OSG_CN_DATA).
<p />
<a href="https://wiki.egi.eu/wiki/APEL/SSMInstallation" target="_top">SSM Installation</a> - Questions related to the installation of the necessary software are documented in this <a href="/bin/view/Interoperability/AccountingInteropQuestionsAndIssues#SSM_Installation" class="twikiCurrentTopicLink twikiAnchorLink">section</a>.
<p />
<a href="https://wiki.egi.eu/wiki/APEL/MessageFormat" target="_top">APEL/SSM Message format</a> - Questions related to the new messaging protocol are documented in this <a href="/bin/view/Interoperability/AccountingInteropQuestionsAndIssues#APEL_SSM_message_format" class="twikiCurrentTopicLink twikiAnchorLink">section</a>
<p />
<a href="https://wiki.egi.eu/wiki/APEL/APELSSMExternalTesting" target="_top">SSM External Testing</a> - Question related to testing are documented in this <a href="/bin/view/Interoperability/AccountingInteropQuestionsAndIssues#SSM_External_Testing" class="twikiCurrentTopicLink twikiAnchorLink">section</a>.
<p />
<a href="http://activemq.apache.org/python.html" target="_top">ActiveMQ</a> - purely for reference are this time.
<p />
<h3><a name="Release_date"></a> Release date </h3>
<font color="#0000ff">Is there a hard "drop-dead" date when the current direct access to the APEL accounting will no longer be supported?</font><br />    
<font color="#008000"> (Will Rogers 11/11/11 - The 15th December is not a deadline for when we’ll be moving to the new system.  I’m not actually sure where the date came from.  I think we’ll do well to get the new system operational by then.  After it is operational there’ll be at least a couple of months for transition before we close the access to the DB that you’ve got at the moment.
</font>
<p />
<h3><a name="SSM_Installation"></a> <a href="https://wiki.egi.eu/wiki/APEL/SSMInstallation" target="_top">SSM Installation</a> </h3>
This section contains some questions specific to this document.
<p />
<strong><em>Prerequisites</em></strong>  <br />    
* <strong><em>certificates</em></strong> <br />    
 The documentation in the <a href="https://wiki.egi.eu/wiki/APEL/SSMInstallation#Certificates" target="_top">Certificates section of SSM Installation page</a> implies a host certificate should be used.<br />    
 <font color="#0000ff">Can a service certificate be used?</font><br />    
<font color="#008000">(Tanya) Yes, you have to send them DN </font><br />    
<font color="#008000">(John Weigand 11/28/11) We will be using a service cert:
<br />     -  gratia-osg-prod-reports.opensciencegrid.org-hostcert.pem
</font><br />    
<p />
 * <strong><em>Stomp</em></strong> <br />    
This is the client software which communicates with Apache ActiveMQ (the message broker).<br />    
<font color="#0000ff">Where can we find documentation on this package?<br />    
<a href="http://packages.python.org/stompy/introduction.html" target="_top">http://packages.python.org/stompy/introduction.html</a> ? </font><br />    
<font color="#008000">(Will Rogers 11/11/11) - Stomppy – confusingly there is a stompy and a stomppy.  We’re using the latter.  Its page is here: <a href="http://code.google.com/p/stomppy/" target="_top">http://code.google.com/p/stomppy/</a>.
</font><br />    
<font color="#ff0000">(John Weigand 11/11/11) - Strange, I think the original doc said we could use stomp and I did with no problems.
Need to change test environment to use the pp one (stomppy).
</font><br />    
<p />
* <strong><em>lcg-CA</em></strong> <br />    
We use the OSG CA certificates.<br />    
<font color="#0000ff">Will this suffice?</font><br />    
<font color="#008000"> (Tanya) Should be ok </font><br />    
<font color="#008000">(John Weigand 11/28/11) This has been verified.</font><br />    
<font color="#ff0000">(John Weigand 11/28/11) Just note/reminder that when DigiCerts become the CA, we will have to test.
<br />    
Also, we have not had to have certificates on the Gratia reporting node (gr13x0) where this has to run.  This will have to be added.
<br />    
</font>
<p />
* <strong><em>Installation</em></strong> <br />    
Have not got this far so no questions at this time<br />    
<font color="#008000">(John Weigand 11/29/11) Did make it this far but not sure how to comment on this.  Mostly manual with tarballs. 
Indications are there will be an RPM available but it is unclear when and whether or not it will be useful for us.
</font>
<p />
<strong><em>Configuration</em></strong> <br />    
The last bullet in this section implies that an acknowledgment is performed indicating the success/failure of the communication between the client and consumer.  This implies some level of synchronous communication.<br />    
<font color="#0000ff">Is this just at the message level or does this extend to the APEL database update the consumer is performing?</font><br />    
<font color="#008000">(Tanya) Only message level, database operation is completely separate process </font><br />    
<font color="#008000">(Will Rogers 11/14/11) Now, on to feedback from APEL to GRATIA…
As things stand, the new APEL server will give a limited amount of feedback to clients in terms of what information has been accepted. The plan is: <ul>
<li> A page such as this one which summarises which sites have published what to the server in the past 24  hours:      - <a href="http://goc-accounting.grid-support.ac.uk/apeltest" target="_top">http://goc-accounting.grid-support.ac.uk/apeltest</a>
</li> <li> A similar page which lists messages which have been rejected by the SSM in the past 24 hours, and why 
</li></ul> 
</font>
<font color="#ff0000">(John Weigand 11/14/11)
A couple things here: <ol>
<li> Are the column headings correct or is this a semantics problem I am having? <ul>
<li> does "newest" mean the last month for which updates were sent/applied?        That is, does this say the last file I sent up was for September? My logs indicate it should have been for "October".
</li> <li> what does "oldest record" mean?
</li></ul> 
</li> <li> Number of records? <ul>
<li> is this the number of records in the last files sent? in the "newest record"? "oldest record"?
</li></ul> 
</li> <li> Is this a database query? If so, maybe we can put something out there other than number of records. 
</li></ol> 
</font><br />    
<p />
<strong><em>Certificates</em></strong> <br />    
This implies a host certificate should be used.  It would be easier to implement if a service certificate could be used as this would facilitate running from multiple hosts as needed.<br />    
<font color="#0000ff">Can a service certificate be used?</font><br />    
<font color="#008000">(Tanya) Yes</font><br />    
<font color="#0000ff">(John Weigand 11/2/11 - Requested service cert from Tanya.</font><br />    
<font color="#008000">(John Weigand 11/28/11) We are now using a service cert: <br />    
 - gratia-osg-prod-reports.opensciencegrid.org-hostcert.pem
</font>
<p />
<strong><em>Running the SSM</em></strong> / <strong><em>Stopping the SSM</em></strong> <br />    
<OL>
<LI>Based on the description, this sounds like a daemon process that is periodically checking a messages directory for files.<br />    
<font color="#0000ff">Is there a plan to allow this to be run from init.d services?</font><br />    
<font color="#008000"> Yes</font><br />    
<font color="#0000ff">(John Weigand 11/2/11) - We won't be running this as a daemon service.  We will be running in a "once and done mode". 
So, item 2 below regarding having that type argument would be nice.   </font><br />    
<p />
<LI> <strong><em>run-ssm</em></strong> script<br />    
a. Our mode of operation is to summarize the Gratia data once per day and send it up to APEL/EGI.  It is a cron scheduled job. Although the previous bullet implies it would be nice to have this as an init.d service, this is not the mode we desire.  We would like a "once and done" mode.
<br />    
<font color="#ff0000">(John Weigand 11/2/11) - Can there be a command line argument (or config file option) that allows the script to terminate when the message has been sent and an acknowledgment received?
</font><br />    
<font color="#008000">(Will Rogers 11/11/11) - It seems a reasonable request to allow a run-once configuration for the SSM.  It is just another task to do, though, so not sure how high priority it will be.
</font><br />    
<p />
<p />
b. Associated with this, a "timeout" option/arg would be useful so our interface script is not waiting forever when the transmission is unsuccessful.  This allows us to be aware of a problem (naturally checking for a non-zero return code) and take remedial action, if necessary.
<br />    
<font color="#ff0000">(John Weigand 11/2/11) - Can this also be provided?</font><br />    
<font color="#008000">(Will Rogers 11/11/11) - It seems a reasonable request to allow a run-once configuration for the SSM.  It is just another task to do, though, so not sure how high priority it will be.
</font><br />    
<p />
c. I noticed, while doing some troubleshooting on our end, that the main module looking for messages (<strong><em>ssm_master.py</em></strong>) is reading the messages/outgoing directory every 1 second.  This seems extremely frequent.  Our Gratia probes (which handle talking to Gratia) only check every 10 minutes for files.   If this is intended for cron execution and it will terminate in a "once and done" mode this is ok.  However, if a daemon process, this may consume resource unnecessarily.   The frequency could be a config option or command line argument.  This is just an observation as we won't be using it in this mode.
<br />    
<font color="#ff0000">(John Weigand 11/2/11) - Although this does not necessarily affect us because of our intended use, I think this could be a problem.</font><br />    
<font color="#008000">(Will Rogers 11/11/11) -The request for "once and done" applies to the frequency of checking the directory for new messages as well.
</font><br />    
<font color="#008000">(John Weigand 11/11/11) - Not really worried about this one since we will operate in "once and done" mode.
</font><br />    
</OL>
<p />
<font color="#008000">(John Weigand 11/28/11) - 
I have modified the code with an SSMInterface class to address these issues from our standpoint.  A method in this class will: <ul>
<li> start the run-ssm daemon in background
</li> <li> check every 10 seconds (hard coded) to see if the file is no longer in the ./messages/outgoing directory (this indicates it has been sent successfully&gt;
</li> <li> if gone, kills the run-ssm daemon
</li> <li> if not gone after 2 minutes (hard coded), terminates the run-ssm daemon and throws an exception.
</li></ul> 
<p />
This should allow us the control we need, at least as we understand it for the current environment.
</font><br />    
<p />
<p />
<p />
<h3><a name="Direct_DB_Access_vs_Messaging"></a> Direct DB Access vs Messaging </h3>
The approach taken with the current  interface was to keep it as simple as possible allowing for an easy means of correcting changing data in the OSG Gratia accounting system.  On a daily basis, the interface performs: <ul>
<li> DELETE from OSG_CN_DATA where Month = mm and Year = yy <br />         (this removes all interfaced OSG resource group data for the month)
</li> <li> INSERT into OSG_CN_DATA (summarized data) where Month = mm and Year = yy. <br />         (for all interfaced OSG resource groups) 
</li> <li> commit <br />         (this is all one atomic transaction)
</li></ul> 
<p />
This approach could be used for the the following reasons: <ul>
<li> The current Gratia/APEL interface is performed using a direct SQL DML update of the APEL accounting database. 
</li> <li> The required  granularity of the APEL/EGI data is monthly summaries by Site,  VO and DN. 
</li> <li> The OSG site's data is segregated from other EGI sites by being stored in an OSG specific table (OSG_CN_DATA).  
</li></ul> 
<p />
The new interface is a messaging based layer which no longer provides us direct access to our data.  It is our understanding that the messages will result  in a database table update (SQL DML REPLACE)  based on certain key fields.  Since we send summary data by site, vo and user DN, and not detail data, we will be sending 
<a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a>. 
<p />
The problem, from the Gratia end of things, is that this now makes it extremely difficult to correct any changes made in Gratia to correct in the APEL/EGI database.  There are (and have been from the beginning) capabilities in Gratia to make corrections in the accounting data collected for things like site and vo.   Individual job records are collected by Gratia and recorded.  Those records themselves rarely change but how the data collected is reported in terms of site and vo  can be changed.  
<p />
A recent example of this (although it does not affect the VOs we are currently reporting) is this request (there is a similar correction table for sites).
<blockquote>
NEES users being mapped to Engage rather than engage.  In the VONameCorrection table, the VOid is pointing to Engage (92) instead of engage (114).  Can you please change the VOid in the VONameCorrection table to point to engage for the VOName:
/Engage/NEES/Role=NULL/Capability=NULL 
/Engage/UCSDGrid/Role=NULL/Capability=NULL 
</blockquote>
<p />
The point of this is that when something like this is effected, the summary data we retrieve  reflects the current state.  If a site or vo were to change, we would have no means of knowing what it was yesterday and the data previously sent would still exist in APEL/EGI.   For us to insure the data in APEL/EGI is reflective of the current Gratia data, we would have to  perform some delta between the previous state and the current state and make adjustments accordingly.  This process would add unneeded complexity and be prone to error.
<p />
<strong><em>Request</em></strong> : <font color="#0000ff">Can there be a message format that would allow for removing (as in our old DELETE) based on site and yr/mos?  This would simplify processing on our end immensely.  We recognize that we would still have to keep track of changes in site but that is something more manageable. </font><br />    
<font color="#008000">(Will Rogers 11/14/11 email) 
The current system means you have a lot of control over what data we hold from GRATIA, so if there’s a correction you can do it and we will reflect that change. The new system would mean that if (for example) a VO were to change its name, you’d have to submit a request to us and we’d have to correct it.
</font><br />    
<font color="#ff0000">(John Weigand 11/14/11 - in email reply)
It is not a VO name change specifically that I am concerned about (that would have to be handled procedurally).<br />    
I am concerned about this scenario....<br />    
Since we are reporting at the DN level (and potentially group/role), it is possible that an individual users VO is misidentified in Gratia.<br />    
- Today we send up an update for user(DN) for the cms VO.<br />    
- Tomorrow, we discover the error in Gratia and correct the VO associated with that user. It should have been atlas.<br />    
- So on tomorrow's update we send up a record for the same user(DN) for atlas VO.<br />    
- Since we are only "replacing" and we are not identifying deltas in our interface, we will have the same user(DN) in APEL under the cms VO and atlas VO when in fact all the usage for that user should have only been for the atlas VO.<br />    
<p />
This type of correction does not occur that often but is handled very simply in Gratia by updating a "translation" type table. The affect on the data we send to APEL is not so easy to identify which is why the delete/insert approach we originally took was the most practical. 
</font><br />    
<font color="#008000">(Will Rogers 11/14/11 - same email) 
Now, it’s clear that you’re not very keen on this idea. To put it into perspective, what we achieve with this is cleaning up a number of special cases whereby certain organizations have their own way of submitting to APEL. These are generally similar but subtly different, and we have a fair few inelegant scripts pulling it all together into the summary database. The discovery of two DB tables that neither you nor we knew about was symptomatic of these interfaces. The new system will have no such special cases, simplifying things for us greatly. So we consider the disadvantage in the paragraph above to be worth it.
It appears that your suggestion would be to have a delete-type message so you could correct your data yourself. There are of course consequences of this ability we’d have to think carefully about. 
</font><br />    
<font color="#ff0000">(John Weigand 11/14/11 - in same email reply)
Help me understand the consequences. It would surely be better that my current alternative of zeroing out the previous days records which, to me, has many more consequences. 
</font><br />    
<p />
<p />
The only option we see available, to achieve the same result, would be to create 2nd file/message  of <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a> with the same set of "keys" with all time/job fields set to zero.  Then, for each update, we would send this 2nd file (from the previous run) up first.  Then we send the "real" updates for the current run.  
<p />
<font color="#0000ff">The question then is "Will they be processed sequentially on the APEL end?".</font><br />    
<font color="#008000">(Will Rogers 11/11/11) Messages ARE applied sequentially, with the exception of duplicates.
</font><br />    
<font color="#ff0000">(John Weigand 11/11/11)
Subsequently, found out duplicates are identified as having the same hash value as another file.  This seems somewhat reasonable.
Even though it is possible for the same user set (site/vo/dn) will be sent up on subsequent days with zero values for the cpu/wall/jobs attributes, uniqueness will be achieved with the date of the LatestEndTime attribute in the file.
</font><br />     
<font color="#008000">(Will Rogers 11/14/11 same email) 
You’ve also experimented with over-writing records so that they contain zeroes. I can’t say for sure right now the effect this would have. The position on this from us has to be that we can’t offer you something new on this, partly because the request is only coming from you, but we’ll bear it in mind as a possible feature. It’s conceivable that other such users would find something like this useful.</font><br />    
<font color="#ff0000">(John Weigand 11/14/11 in same email reply) 
I would think this would depend on how many users are sending summary data up and whether or not they are sending deltas or "replaces". Have any of those updating summary only started testing.
</font><br />    
<p />
<font color="#008000">(John Weigand 11/28/11) 
The LCG.py process has been modified to:<br />    
- For each execution, create a YYYY-MM-updates.txt file containing the summarized data for that month.  It will also create a YYYY-MM-deletes.txt file for the same set of "keys" with the cpu/wall/jobs attributes zeroed out.<br />    
 - So, each day, it will first attempt to send the YYYY-MM-deletes.txt from the previous day via SSM to APEL.<br />    
 - If not successful, it will terminate.  This insures we always "zero" out the last update made.<br />    
 - If successful, it will then create/send via SSM to APEL, the YYYY-MM-updates.txt for that day.<br />    
</font><br />    
<p />
<h3><a name="APEL_SSM_message_format"></a> <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat" target="_top">APEL SSM message format</a> </h3>
Gratia will not be sending individual job records to APEL/EGI.  As today, Gratia will be sending summary data based on site, vo and user DN.   
<p />
Questions related to the <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a>.
<OL>
    <LI> WallDuration/CPUDuration<br />    
      Currently, the "times" sent up for these fields are in a time scale of hours.  The <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Job_Records" target="_top">individual Job Records</a>  explicitly state these are to be in seconds. 
<br />      
<font color="#008000">(Will Rogers 11/11/11) These will be in Hours.  The documentation now reflects this.
</font>
<br />    
<p />
<p />
     <LI> NormalisedWallDuration/!NormalisedCpuDuration<br />    
      Currently, Gratia is sending normalized data using a SpecInt value.  The <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Job_Records" target="_top">individual Job Records</a> provide for specifying a NormalizationFactorUnit. The <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a> do not.     We can provide either but would prefer HepSpec as that is what all new processors are evaluated with.  
<br />     
<font color="#0000ff">Can we assume it is the HepSpec value that is required? Can the document reflect this?</font>
<br />     
<font color="#008000">(Will Rogers 11/11/11) - Use HepSpec06 NF factor.  The documentation now reflects this.
</font>
<p />
<p />
<p />
     <LI>Group/Role<br />    
      In the <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records" target="_top">Summary Job Records</a>, there are 2 new fields that we have not been required to populate with the current interface: Group and Role.  We are assuming these are optional and at the discretion of the VOs which, in our case, are cms/atlas/alice.  The documentation indicates that if these are not "published", they will set to "None" in the database. <br />    
<font color="#0000ff">Is there any problem if we always "publish" them with a string value of "None"?</font>
<br />     
<font color="#008000">(John Weigand - 11/2/11) -  Testing has shown this to be true.</font>
</OL>
<p />
Questions related to the <a href="https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Sync_Records" target="_top">Summary Sync Records</a>:<OL>
    <LI> <font color="#0000ff">Is this file/message also required?</font><br />    
    <font color="#008000">(Tanya) Don't know</font><br />    
   <font color="#ff0000">(John Weigand - 11/2/11) - Would be nice to know if we need to be concerned with this and, if so, what is it????</font><br />    
   <font color="#008000">(Will Rogers 11/11/11) - Sync records - these aren’t required if you’re just sending summaries to us.  I’ll update the wiki documentation to make this clearer.
</font><br />    
</OL>
<p />
<p />
<h3><a name="SSM_External_Testing"></a> SSM External Testing </h3>
Link: <a href="https://wiki.egi.eu/wiki/APEL/APELSSMExternalTesting" target="_top">SSM External Testing</a><br />    
We have subscribed to the mailing list but have gone no further as yet but do have some preliminary questions.
<OL>
  <LI>In the Usage section, the interface sounds like it is an asynchronous protocol. <br />    
        <font color="#0000ff">Are there plans for this to be synchronous in nature when it goes to production? (in terms of both the message and, more importantly, the database update)?</font><br />    
<font color="#008000">No, it will be completely asynchronous</font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - This makes the ability to retrieve data from the EGI portal critical to verifying if the interface worked.</font><br />    
<p />
<p />
<LI>It appears the test environment is limited to just the messaging and database update.<br />    
<font color="#0000ff">Will there be an environment which tests the complete data flow inclusive of the EGI portal UI?</font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - How then do we actually test?</font><br />    
<p />
</OL>
<p />
<p />
<h3><a name="Retrieval_Publishing_of_APEL_EGI"></a> Retrieval/Publishing of APEL/EGI data </h3>
Currently, after the daily update of APEL is performed, we do a retrieval of the data using a SQL select of the data for the following tables: <ul>
<li> OSG_CN_DATA
</li> <li> org_Tier1
</li> <li> org_Tier2
</li></ul> 
<p />
This retrieval uses the SQL client capability to output the table data in html, dat and xml formats for access by other OSG applications.  This data is currently used in these OSG site pages: <ul>
<li> <a href="http://red-web.unl.edu/gratia/wlcg_reporting#atlas" target="_top">OSG WLCG Reporting</a>
</li> <li> <a href="http://gratia-osg-prod-reports.opensciencegrid.org/gratia-data/interfaces/apel-lcg/" target="_top">Gratia-APEL WLCG Interface</a> (also accessible from the main <a href="http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting" target="_top">Gratia reporting page</a> menu on the left side.)
</li></ul> 
<p />
<h4><a name="Topology_data_aka_org_Tier1_2_ta"></a> Topology data (aka org_Tier1/2 tables) </h4>
It is our understanding that the org_Tier1/2 tables are being replaced by the <a href="http://wlcg-rebus.cern.ch/apps/topology/" target="_top">WLCG REBUS Topology</a>.  This site has the capability to "export" the data is a csv format.  This will probably be adequate since the amount of data is relatively small.
<p />
There are still a couple questions relative to how this topology data is used. 
It is our understanding that for the data to be reflected in the Tier1/2 views a WLCG Site (OSG resource group) must be registered with LCG accounting and an MOU agreement in effect.
The site will then be populated in the WLCG Topology and only those Sites will have their data reflected in that view under the appropriate Country/Federation Name/Federation Accounting Name in the hierarchy.  Some of these questions have come up as the WLCG Topology does not appear to be time sensitive and Sites can come and go over time.
<OL>
<LI>If a site (OSG resource group) is being removed from service, we assume that site must remain in the topology or any historical data associated with its contribution toward the Federation Accounting Name will be lost.  We recently had this case with a site MWT2_IU being replaced by site MWT2.   We advised them <strong><em>not</em></strong> to have the MWT2_IU removed.<br />    
<font color="#0000ff">Were we correct in this assumption?</font><br />    
<font color="#008000">(Tanya) No clue </font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - It would be nice to get this answered so we understand how OSG sites should handle deprecated sites in MyOSG/OIM.  In the old interface, there did exists files/tables that masked some of this.</font><br />    
<p />
<LI>In the past (or maybe still), the org_Tier1/2 tables determined if a site was displayed in the EGI portal under the appropriate view/hierarchy.  There were also 1 or 2 other tables/configuration files (not viewable by us) that took care of this "removal of a site" from service but allowed the historical data to still be visible.  An example of this was a Purdue-Lear site back in 2008 and its data was still viewable by using these other tables/files.<br />    
<font color="#0000ff">Are any other tables/configuration files still being used or is the WLCG Topology the sole driver of the data?</font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - It would be nice to get this answered so we understand how OSG sites should handle deprecated sites in MyOSG/OIM.  In the old interface, there did exists files/tables that masked some of this.</font><br />    
<p />
<LI><font color="#0000ff">When a site is registered in LCG and an MOU agreement reached, should the data for past periods be sent up or does the date of the registration mark the start of the data requirement?</font><br />    
<font color="#008000">(Tanya) No clue </font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - Need to know so we can establish the correct procedures.</font><br />    
<p />
<LI>While documenting all this and in viewing the data on the EGI portal, there appears to be no data prior to April 2009.  We have been sending data up since at least March 2008. <br />    
<font color="#0000ff">Is there an "archival" process in effect that we should be aware of?</font><br />    
<font color="#008000">(Tanya) No clue </font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - Another "good to know" point.  It should be noted that both links at the bottom of the EGI Accounting Portal that seem to intend to describe this, don't work (for me anyway)</font><br />    
</OL>
<font color="#008000">(Will Rogers 11/11/11) Topology data – we haven’t looked at this recently, so at least I am not sure of the status.  If you think this is urgent, give us another nudge and we’ll have a look.
</font><br />    
<font color="#ff0000">(John Weigand 11/11/11) Not urgent but we need to nudge them as we need to understand the procedures to follow.
</font><br />    
<p />
<h4><a name="OSG_site_data_aka_OSG_CN_DATA"></a> OSG site data (aka OSG_CN_DATA) </h4>
As mentioned in the  earlier, Gratia needs visibility to the APEL data we publish.  It has been mentioned that the EGI portal allows for the downloading of the data in a csv format using the link at the bottom of the currently displayed table.  However, there does not appear to be a programmatic means of doing this.  The link executes a javascript that apparently access what ever criteria was used to display the page. <br />    
<font color="#0000ff">Are there any plans to provide an API for data retrieval? With some criteria?  This is a really much needed requirement.</font><br />    
<font color="#008000">yes, it is possible but not documented yet </font><br />    
<font color="#ff0000">(John Weigand 11/2/11) - CRITICAL  Otherwise we have to find a way to accommodate our requirements as described in this section. </font><br />    
<font color="#008000">(Will Rogers 11/11/11) - Feedback from APEL system and / or portal – I’ll send another email about this.
</font><br />    
<font color="#ff0000">(John Weigand 11/11/11) - Without this capability, I am thinking we will have to modify the code to do a 2nd query summarized by VO so we can provide Nebraska with the data we need and, at the least, we then have a record of what we sent up to validate against the monthly MOU pdf.   Won't be exact but it is better than adding the code to summarize the query by DN.
</font><br />    
<font color="#008000">(Will Rogers 11/14/11)
There’s been some talk about being able to download data from the accounting portal in CSV format, but this is hazy for us too – I’d recommend asking the portal people themselves about the status of this and what they plan, because it’s not really under our control.
</font><br />    
<font color="#ff0000">(John Weigand 11/28/11)
Since I am not sure this will be resolved in the near future, The interface program has been modified to summarize the data by site/vo and create 2 files: YYYY-MM-summary.dat and YYYY-MM-summary.html.  This will allow the Nebraska WLCG portal access to the data provided today.<br />    
The caveat is that this is what we "think" is in APEL.  Not necessarily what is in APEL/EGI portal.  We can only verify this manually at this time.
</font><br />    
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SSM_Testing"></a> SSM Testing </span></h2>
1. See  [[ <a href="https://wiki.egi.eu/wiki/APEL/SSMInstallation][SSM" target="_top">https://wiki.egi.eu/wiki/APEL/SSMInstallation][SSM</a> Installation Instructions]]
<p />
<strong><em>Configuration section</em></strong> <ul>
<li> A general statement in the beginning when setting SSM_HOME variable might be useful saying it can be used in the ssm.cfg file but not in the ssm.log.cfg file. 
</li></ul> 
<p /> <ul>
<li> ssm.cfg - Since this in an ini format, might be useful to mention the section. Some were more obvious than others with the wording used. "the topic to send.." was not.  It is in the [producer] section.
</li></ul> 
<p />
<strong><em>Running the SSM section</em></strong>  <ul>
<li> I think the cd should be to $SSM_HOME/bin not $HOME/bin
</li></ul> 
<p /> <ul>
<li> In the configuration section, for the message store, you suggest using $SSM_HOME/messages but never mention it needs to be created. In addition in this section, you mention putting files to send in $SSM_HOME/messages/outgoing and never mention is obviously needs to be created.   I see where it gets creates on execution of run-ssm Other dirs are too but no mention of what they are for.
</li></ul> 
<p />
2. Testing documented here <a href="http://home.fnal.gov/~weigand/SSM/" target="_top">http://home.fnal.gov/~weigand/SSM/</a>
<p />
3. Will told me they have a bug such that if the interface detects a problem on their end, it stops.  This is why I could not send yesterday.  They restarted it and the latest file went up.
<p />
4. Other issues; <ul>
<li> They loop in the messages/outgoing directory every 1 sec. This is too much.  If no messages, there should be some sleep period.      This should be settable by the user.           This could easily be set in ssm-master.py here.. time.sleep(1.0) as the while loop will process all records until there are none.  
</li></ul> 
<p /> <ul>
<li> For sites like us sending summary records periodically it would be nicer if we could have a "once and done" option.       Maybe it would specify a "retry period" in the event of intermittent failures but would still terminate so we can indicate to our admins the state of the interface.    This could also be done right in ssm-master.py. It could even have a retry arg/setting.
</li></ul> 
<p /> <ul>
<li> in messages_db.py (_get_message), there is a sort of the messages.        Why?  This means that to insure an order, I have to be aware of this        and reflect the order in the file name.  I would expect the        receiving end to process my files in the order received.        If, for whatever reason, I have 2 days data in the directory, the 2nd        days has to go up last or I have to insure I always have only one file.
</li></ul> 
<p /> <ul>
<li> ssm_master.py          log.debug('Ready for service. Listening for incoming messages.')        .. should be 'outgoing' as that is the directory we are looking in.           There is an incoming one and this confuses the issue.
</li></ul> 
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Comments"></a> <strong>Comments</strong> </span></h2>
<p />
<form method="post" action="https://twiki.opensciencegrid.org/bin/save/Interoperability/AccountingInteropQuestionsAndIssues" enctype="multipart/form-data" name="tableappend0" id="tableappend0">
<p />
<div class="commentPlugin commentPluginPromptBox">
<table><tr valign="middle"><td><textarea  rows="3" cols="70" name="comment" wrap="soft" onfocus="if(this.value=='')this.value=''" onblur="if(this.value=='')this.value=''"></textarea></td><td><input  type="submit" value="Add comment" /></td></tr></table>
</div><!--/commentPlugin-->
<p />
<input type="hidden" name="comment_action" value="save"  />
<input type="hidden" name="comment_type" value="tableappend"  />
<input type="hidden" name="comment_index" value="0"  /></form></div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Interoperability<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><span class="twikiNewLink">Trash/Trash/Integration<a href="/bin/edit/Trash/Trash/Integration/WebHome?topicparent=Interoperability.AccountingInteropQuestionsAndIssues" rel="nofollow" title="Trash/Trash/Integration (this topic does not yet exist; you can create it)">?</a></span> &gt; <a href="/bin/view/ReleaseDocumentation/WebHome" class="twikiLink">ReleaseDocumentation</a> &gt; <a href="/bin/view/Trash/ReleaseDocumentationAccountingAndWLCG" class="twikiLink">ReleaseDocumentationAccountingAndWLCG</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>AccountingInteropQuestionsAndIssues</span> <br />    
Topic revision: r16 - 07 Feb 2017 - 17:32:48 - <a href="/bin/view/Main/BrianBockelman" class="twikiLink">BrianBockelman</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />