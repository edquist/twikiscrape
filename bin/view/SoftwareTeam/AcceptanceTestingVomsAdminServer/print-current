<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> AcceptanceTestingVomsAdminServer &lt; SoftwareTeam &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/SoftwareTeam/AcceptanceTestingVomsAdminServer?_T=16 Feb 2017" type="application/x-wiki" title="edit AcceptanceTestingVomsAdminServer" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/SoftwareTeam/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/SoftwareTeam/AcceptanceTestingVomsAdminServer"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#DDDDDD;
	}
	.patternBookView {
		border-color:#DDDDDD;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Acceptance_Testing_for_voms_admi"></a> Acceptance Testing for voms-admin-server </h1>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Install_and_configure_voms_admin"></a> Install and configure voms-admin-server </span></h2>
<p />
Install and configure voms-admin-server with the following script, entering <code>osg-testing</code> when prompted for the <code>REPO</code> and your own e-mail address when prompted for <code>EMAIL_FROM</code>:
<p />
<pre class='file'>
#!/bin/bash

# script vars #

REPO= #osg-testing
MYSQL_ROOT_PASSWORD=top_secret
VO_NAME=TEST_VO
VO_ALIAS=testvo
MYSQL_DB_PASSWORD=secret
DB_PORT=3306
VOMS_PORT=15001
EMAIL_FROM=edquist@cs.wisc.edu
SMTP_HOST=smtp.fnal.gov

svars=(
  REPO MYSQL_ROOT_PASSWORD VO_NAME VO_ALIAS MYSQL_DB_PASSWORD
  DB_PORT VOMS_PORT EMAIL_FROM SMTP_HOST
)

# functions #

fail () { echo "$@" >&2; exit 1; }

retry () {
  local n=$1 delay=$2
  shift 2
  while (( n-- >= 0 )); do
    sleep $delay
    "$@" && return
  done
  return 1
}

cert () {
  # cert {subject|issuer}
  openssl x509 -in /etc/grid-security/hostcert.pem -noout -$1 | sed "s/^$1= //"
}

user_input_var () {
  local __
  # read -p "$1=" -ei "${!1}" "$1"
  read -p "$1= [${!1}] " __
  [[ $__ ]] && eval $1=\$__
  [[ ! ${!1} =~ [^-_a-zA-Z0-9.@] ]] || fail "sorry, i don't like '${!1}'"
}

stars () {
  yes '*' | head -$1 | tr -d '\n'
}

SECTION () {
  local s=$*
  echo
  echo "******$(stars ${#s})******"
  echo "****  $s  ****"
  echo "******$(stars ${#s})******"
  echo
}

on_err () {
  echo
  echo "Error running \"$BASH_COMMAND\" (line ${BASH_LINENO[0]})"
  read -p "Continue? [y/N] " && [[ $REPLY = [yY]* ]] || exit 1
}

trap on_err ERR


[[ $USER = root ]] || fail "You probably mean to run this as root..."

case $1 in
  -ok ) shift; OK=Y ;;
esac
# set script vars if on a tty #

if [[ $OK != Y && -t 0 && -t 1 ]]; then
  for x in ${svars[@]}; do
    user_input_var $x
  done
  echo
  for x in ${svars[@]}; do
    echo "$x=\"${!x}\""
  done
  echo
  read -p 'OK? [y/N] ' && [[ $REPLY = [yY]* ]] || exit 1
fi

HOST_CERT_SUBJECT=$(cert subject)
HOST_CERT_ISSUER=$(cert issuer)

EL_RELEASE=$(</etc/redhat-release)
case $EL_RELEASE in
  *"release 5"* ) EL=5 TOMCAT=tomcat$EL FETCH_CRL=fetch-crl3 ;;
  *"release 6"* ) EL=6 TOMCAT=tomcat$EL FETCH_CRL=fetch-crl  ;;
  * ) fail "Bad redhat-release string: $EL_RELEASE"
esac


SECTION Install the CA Certificates

yum clean --enablerepo=\* expire-cache
yum install -y osg-ca-certs

SECTION Install VOMS

yum install -y ${REPO:+--enablerepo="$REPO"} osg-voms

SECTION Configure MySQL Database 

/etc/init.d/mysqld start
mysqladmin -u root password "$MYSQL_ROOT_PASSWORD"

SECTION Setup the Service Certificates

cd /etc/grid-security
cp -b hostcert.pem voms/vomscert.pem
cp -b hostkey.pem voms/vomskey.pem
chown -R voms:voms voms

cd /etc/grid-security
if [[ -e /etc/grid-security/http ]]; then
  mv /etc/grid-security/http{,~}
fi
mkdir -p /etc/grid-security/http
cp hostcert.pem http/httpcert.pem
cp hostkey.pem http/httpkey.pem
chown -R tomcat:tomcat http

SECTION Configure Tomcat options

echo 'CATALINA_OPTS="${CATALINA_OPTS} -XX:MaxPermSize=256m"' \
     >> /etc/$TOMCAT/$TOMCAT.conf

if [[ $EL = 6 ]]; then
  echo \
  'JAVA_ENDORSED_DIRS="${JAVA_ENDORSED_DIRS}:/usr/share/voms-admin/endorsed"' \
     >> /etc/$TOMCAT/$TOMCAT.conf
fi

cat >> /etc/security/limits.conf <<__EOT__
tomcat          soft    nofile  63536
tomcat          hard    nofile  63536

tomcat          soft    nproc   16384
tomcat          hard    nproc   16384
__EOT__


SECTION Configure Trust Manager

/var/lib/trustmanager-tomcat/configure.sh

SECTION Add and configure a VO

voms-admin-configure install \
    --dbtype mysql \
    --vo $VO_NAME \
    --createdb \
    --deploy-database \
    --dbauser root \
    --dbapwd $MYSQL_ROOT_PASSWORD \
    --dbusername  admin-$VO_NAME \
    --dbpassword $MYSQL_DB_PASSWORD \
    --dbport  $DB_PORT \
    --port $VOMS_PORT \
    --mail-from $EMAIL_FROM \
    --smtp-host $SMTP_HOST \
    --sqlloc /usr/lib64/voms/libvomsmysql.so \
    --cert /etc/grid-security/voms/vomscert.pem \
    --key  /etc/grid-security/voms/vomskey.pem \
    --read-access-for-authenticated-clients 

/sbin/service voms start $VO_NAME
/sbin/service voms-admin start $VO_NAME

retry 10 1 \
/usr/sbin/voms-db-deploy.py add-admin --vo $VO_NAME  \
    --dn "$HOST_CERT_SUBJECT" \
    --ca "$HOST_CERT_ISSUER"

/usr/sbin/$FETCH_CRL -p10 -T10 || :  # fetch-crl errors are common
/sbin/service $TOMCAT start

retry 6 5 \
voms-admin --nousercert --vo $VO_NAME add-ACL-entry \
    /$VO_NAME ANYONE VOMS_CA "CONTAINER_READ,MEMBERSHIP_READ" true

echo "voms.csrf.log_only = true" \
    >> /etc/voms-admin/$VO_NAME/voms.service.properties


SECTION Advertise your VOMS server

printf '"%s" "%s" "%s" "%s" "%s"\n' \
       $VO_ALIAS $HOSTNAME $VOMS_PORT "$HOST_CERT_SUBJECT" $VO_NAME \
       >> /etc/vomses

mkdir -p /etc/grid-security/vomsdir/$VO_NAME

{ echo "$HOST_CERT_SUBJECT"
  echo "$HOST_CERT_ISSUER"
} > /etc/grid-security/vomsdir/$VO_NAME/$HOSTNAME


SECTION Starting and Enabling Services

# commenting these out since for tests we don't need fetch-crl to keep running
#/usr/sbin/$FETCH_CRL || :  # fetch-crl errors are common
#/sbin/service $FETCH_CRL-boot start || :
#/sbin/service $FETCH_CRL-cron start || :

/sbin/service mysqld start
service voms start
service $TOMCAT start

/sbin/chkconfig $FETCH_CRL-boot on
/sbin/chkconfig $FETCH_CRL-cron on

/sbin/chkconfig mysqld on
/sbin/chkconfig voms on
/sbin/chkconfig $TOMCAT on


SECTION All Done
</pre>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Set_up_TEST_VO_and_add_yourself"></a> Set up TEST_VO and add yourself as an admin </span></h2>
<p />
To add a test VO (named TEST_VO) and add yourself as an admin, use the following script, replacing the <code>USER_EMAIL</code>, <code>USER_CERT_SUBJECT</code>, and <code>USER_COMMON_NAME</code> variables with your own:
<p />
<pre class="file">
#!/bin/bash

VO_NAME="TEST_VO"
TOMCAT_PORT="8443"
USER_EMAIL="YOUR_EMAIL"
USER_CERT_SUBJECT="YOUR CERT DN"
USER_CERT_ISSUER="/DC=com/DC=DigiCert-Grid/O=DigiCert Grid/CN=DigiCert Grid CA-1"
USER_COMMON_NAME="YOUR CERT CN"

voms-admin --vo $VO_NAME --host $HOSTNAME --nousercert create-user \
    "$USER_CERT_SUBJECT" "$USER_CERT_ISSUER" "$USER_COMMON_NAME" "$USER_EMAIL"

voms-admin --vo $VO_NAME --host $HOSTNAME --nousercert assign-role \
    /$VO_NAME VO-Admin "$USER_CERT_SUBJECT" "$USER_CERT_ISSUER"

echo web ui: https://$HOSTNAME:$TOMCAT_PORT/voms/$VO_NAME
</pre>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Testing_the_web_UI"></a> Testing the web UI </span></h2>
<p /> <ol>
<li> Add/suspend/restore/delete a user (using your e-mail address for contact)
</li> <li> Verify e-mail receipt of suspension message
</li></ol> 
<p />
-- <a href="/bin/view/Main/BrianLin" class="twikiLink">BrianLin</a> - 05 Jun 2015</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: SoftwareTeam<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/SoftwareTeam/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a> &gt; <a href="/bin/view/SoftwareTeam/InternalDocs" class="twikiLink">InternalDocs</a> &gt; <a href="/bin/view/SoftwareTeam/AcceptanceTestingHome" class="twikiLink">AcceptanceTestingHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>AcceptanceTestingVomsAdminServer</span> <br />    
Topic revision: r1 - 05 Jun 2015 - 15:34:50 - <a href="/bin/view/Main/BrianLin" class="twikiLink">BrianLin</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />