---+ Globus mass update procedure

Globus consists of many packages, which we tend to update at the same time.
This requires extra work, primarily to prevent dependency issues.


---++ Prep work

---+++ Docs

Create a spreadsheet or table of the builds. Table should have NVR, perhaps
URL, status (not started, imported, built, tested), and comments (mostly to
record if it was a simple pass-through or not).

Get packages to update, using =osg-outdated-epel-pkgs= from =opensciencegrid/tools=.

To get in N-V-R format:

&lt;pre class=&quot;screen&quot;&gt;./osg-outdated-epel-pkgs | egrep &#39;^(globus|myproxy|gsi)&#39; | awk &#39;BEGIN {OFS=&quot;&quot;} {print $1, &quot;-&quot;, $3}&#39;&lt;/pre&gt;

or to split up N and V-R in a comma-separated way (which you can feed into a Google Sheet to turn it into two columns):

&lt;pre class=&quot;screen&quot;&gt;./osg-outdated-epel-pkgs | egrep &#39;^(globus|myproxy|gsi)&#39; | awk &#39;BEGIN {OFS=&quot;&quot;} {print $1, &quot;,&quot;, $3}&#39;&lt;/pre&gt;


---+++ SVN

Create a separate SVN branch and populate it with all the packages you will update. (Get the list from the doc created above).

&lt;pre class=&quot;screen&quot;&gt;
svn mkdir file:///p/vdt/workspace/svn/native/redhat/branches/globus
### From a checkout, in native/redhat
for x in trunk/globus* trunk/myproxy; do
  svn copy $x branches/globus/${x#trunk/}
done
&lt;/pre&gt;


---+++ Koji (Mat/Carl)

This requires a Koji administrator. Current Koji admins are Main.MatyasSelmeci
and Main.CarlEdquist.

Create new Koji tags: a destination tag, and a build tag, one for each dver, e.g.:

   * el6-globus
   * el6-globus-build
   * el7-globus
   * el7-globus-build

Set up tag inheritence: base the destination tags off of the corresponding
development repo tag, and base the build tags off of the corresponding
=dist-el?-build= tag. This is because we don&#39;t want old osg packages
interfering with the new versions we&#39;re building.

&lt;pre class=&quot;screen&quot;&gt;
osg-koji add-tag --parent=osg-3.3-el6-development --arches=&#39;i386 x86_64&#39; el6-globus
osg-koji add-tag --parent=osg-3.3-el7-development --arches=x86_64 el7-globus
osg-koji add-tag --parent=dist-el6-build --arches=&#39;i386 x86_64&#39; el6-globus-build
osg-koji add-tag --parent=dist-el7-build --arches=x86_64 el7-globus-build
&lt;/pre&gt;

Tag =buildsys-macros= for the OSG release into the build tags:

&lt;pre class=&quot;screen&quot;&gt;
for el in el6 el7; do
    buildsys_macros_nvr=$(osg-koji -q list-tagged osg-3.3-$el-development buildsys-macros --latest | awk &#39;{print $1}&#39;)
    osg-koji tag-pkg $el-globus-build $buildsys_macros_nvr
done
&lt;/pre&gt;

Create new Koji targets, one for each dver, e.g.:

   * el6-globus (el6-globus-build &amp;rarr; el6-globus)
   * el7-globus (el7-globus-build &amp;rarr; el7-globus)
   * kojira-fake-el6-globus (el6-globus &amp;rarr; kojira-fake)
   * kojira-fake-el7-globus (el7-globus &amp;rarr; kojira-fake)

&lt;pre class=&quot;screen&quot;&gt;
for el in el6 el7; do
    osg-koji add-target $el-globus $el-globus-build $el-globus
    osg-koji add-target kojira-fake-$el-globus $el-globus kojira-fake
done
&lt;/pre&gt;

If basing the packages off of the Globus repos, add the Globus repos as
external repos, and add them to the build tags (but not the dest tags).

Edit =/etc/koji-hub/plugins/sign.conf= and set up the GPG signing for the RPMs.
Run =/etc/koji-hub/plugins/fix-permissions= after editing the file.



---++ Per-package work

   1. cd into branches/globus
   1. Download packages from http://dl.fedoraproject.org/epel/6/SRPMS/

A useful alias:

&lt;pre class=&quot;screen&quot;&gt;alias osg-build-globus=&quot;osg-build koji --ktt el6-globus --ktt el7-globus&quot;&lt;/pre&gt;


---+++ Strict pass-through (no osg/ directory)

   1. &lt;pre class=&quot;screen&quot;&gt;
osg-import-srpm &quot;$url&quot;
osg-build-globus --scratch $pkg
&lt;/pre&gt;
   1. Commit - use a message like:&lt;pre&gt;
Update to 3.12-1 from EPEL (SOFTWARE-2197)
&lt;/pre&gt;
   1. Do a non-scratch build.


---+++ Non-strict pass-through

   1. &lt;pre class=&quot;screen&quot;&gt;osg-import-srpm --diff3 &quot;$url&quot;&lt;/pre&gt;
   1. Fix merge conflicts in the spec file. If not already there, put a .1
      after the Release number to mark the changes as ours.
   1. &lt;pre class=&quot;screen&quot;&gt;osg-build quilt $pkg&lt;/pre&gt;
   1. Fix patches if necessary.
   1. &lt;pre class=&quot;screen&quot;&gt;osg-build-globus --scratch $pkg&lt;/pre&gt;
   1. Commit - use a message like:&lt;pre&gt;
Update to 8.29-1 from EPEL and merge OSG changes (SOFTWARE-2197)
&lt;/pre&gt;
   1. Do a non-scratch build.



---++ Testing

Create a yum =.repo= file similar to =osg-minefield= that installs from the
=el?-globus= repos.

EL7 example:

&lt;pre class=&quot;file&quot;&gt;
[globus]
name=globus
baseurl=http://koji.chtc.wisc.edu/mnt/koji/repos/el7-globus/latest/$basearch/
failovermethod=priority
priority=98
enabled=0
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-OSG
consider_as_osg=yes
&lt;/pre&gt;



---++ Merge

---+++ Koji (Mat/Carl)

This requires a Koji administrator. Current Koji admins are Main.MatyasSelmeci
and Main.CarlEdquist.

   1. Untag broken versions that we don&#39;t want to ship.
   1. Use =move-pkg=:&lt;pre class=&quot;screen&quot;&gt;
for el in el6 el7; do
    osg-koji -q list-tagged ${el}-globus | awk &#39;{print $1}&#39; &amp;gt; ${el}-tagged.txt
done
### Check the txts if they look sane
for el in el6 el7; do
    xargs -a ${el}-tagged.txt  osg-koji move-pkg ${el}-globus osg-3.3-${el}-development
done
&lt;/pre&gt;


---+++ SVN

   1. Merge from =trunk= to =branches/globus= first, to pick up any globus
      changes that may have happened in trunk.
   1. Merge from =branches/globus= to =trunk=.
   1. Move =branches/globus= to &lt;code&gt;tags/globus-&lt;em&gt;DATE&lt;/em&gt;&lt;/code&gt;.
