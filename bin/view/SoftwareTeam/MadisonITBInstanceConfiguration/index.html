<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> MadisonITBInstanceConfiguration &lt; SoftwareTeam &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/SoftwareTeam/MadisonITBInstanceConfiguration?_T=16 Feb 2017" type="application/x-wiki" title="edit MadisonITBInstanceConfiguration" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/SoftwareTeam/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/SoftwareTeam/MadisonITBInstanceConfiguration"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#DDDDDD;
	}
	.patternBookView {
		border-color:#DDDDDD;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Configuration_for_the_Madison_IT"></a> Configuration for the Madison ITB Instance </h1>
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Overview"></a> Overview </span></h2>
<p />
<p />
Configuration for the Madison ITB Instance is handled using <a href="http://docs.puppetlabs.com" target="_top">Puppet</a>.
We are using a Puppet Master that is run by the UW Center for High-Throughput Computing.
The master is shared by multiple sites, but we will have separate environments for the ITB site.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Environment_Setup"></a> Environment Setup </span></h2>
<p />
<p />
The Puppet Master we use is hosted on <em>wid-service-1.chtc.wisc.edu</em>.
All Puppet environments on <em>wid-service-1.chtc.wisc.edu</em> are located in the directory <code>/etc/puppet/environments/</code>.
<p />
<strong>Note</strong>: <em>wid-service-1</em> is a shared resource, and there are Puppet environments for other machines and clusters managed by the CHTC.
Please be careful when making changes!
<p />
The <code>vdt</code> environment holds the Puppet configuration for the ITB site;
it is located in <code>/etc/puppet/environments/vdt/</code>.
<p />
In addition to the <code>vdt</code> environment, team members will have their own environments for testing.
Your environment will be named after your UW CS login name;
if you do not have an environment, you should mail Tim C or Mat.
You can manage your own environment however you want,
but it is recommended to store the configs in the <a href="https://vdt.cs.wisc.edu/svn/puppet" target="_top">/puppet/ directory tree in SVN</a>.
<p />
A Puppet environment is a directory with a specific layout.
All Puppet configs in an environment are organized into modules and placed in the <code>modules/</code> subdirectory.
The <a href="http://docs.puppetlabs.com/puppet/2.7/reference/modules_fundamentals.html" target="_top">Puppet docs on modules</a> describe this.
<p />
The special module <code>nodes</code> contains the configs for each specific host in the site.
Each node-specific config file is named after the hostname of the host it refers to.
For example, the config for <em>itb-worker1.chtc.wisc.edu</em> is in the <code>itb-worker1.pp</code> file.
It contains a single "node" resource, which must be named after the FQDN of the host.
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SVN_Setup"></a> SVN Setup </span></h2>
<p />
<p />
The canonical location for files in the <code>vdt</code> environment is in the <a href="https://vdt.cs.wisc.edu/svn" target="_top">VDT SVN repo</a>,
in the directory <code>/puppet/production/</code>.
All changes to the <code>vdt</code> environment must be committed there.
The <code>vdt</code> environment on <em>wid-service-1</em> updates from SVN every 10 minutes.
<p />
<strong>Note</strong> that this is a publicly accessible SVN repository.
Do not store any sensitive data such as passwords or private keys in it.
<p />
There are directories in the <code>/puppet/</code> tree for the ITB site admins' personal environments.
You should commit your changes to your environment into your area in SVN and from there merge the changes into production.
There is no automatic process to update admins' personal environments.
Use whatever method fits your workflow the best.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Puppet_Agent_Setup"></a> Puppet Agent Setup </span></h2>
<p />
The puppet agent is installed on each of the nodes in the ITB site.
It is not running persistently, but instead runs once a night from root's cron.
The agent will pull from the <code>vdt</code> environment.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Example_Workflow"></a> Example Workflow </span></h2>
<p />
Suppose I (matyas) want to make a change to <em>itb-worker1</em>.
This is the procedure I would follow: <ol>
<li> Merge any changes that are in <code>/puppet/production/</code> to <code>/puppet/matyas/</code> to make sure my branch reflects the current state of the configs.
</li> <li> SSH to <em>wid-service-1</em>, cd into the checkout at <code>/etc/puppet/environments/matyas/</code> and update from my branch.
</li> <li> Make changes (right there in the checkout).
</li> <li> SSH to <em>itb-worker1</em> and run <code>puppetd -vt --environment=matyas</code> to run Puppet once, pulling from my environment.
</li> <li> Repeat the previous two steps as necessary to get my changes working.
</li> <li> Commit my changes to <code>/puppet/matyas/</code>.
</li> <li> SVN merge my changes to <code>/puppet/production/</code>.
</li> <li> Wait up to 10 minutes.
</li> <li> SSH to <em>itb-worker1</em> and run <code>puppetd -vt --environment=vdt</code>.
</li> <li> Verify my changes work in production.
</li></ol> 
<p />
<p />
<p />
<hr />
<p />
<h1><a name="Puppet_Conventions"></a> Puppet Conventions </h1>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Puppet_Coding_Style"></a> Puppet Coding Style </span></h2>
<p />
We follow the <a href="http://docs.puppetlabs.com/guides/style_guide.html" target="_top">official Puppet style guide</a>, except as noted below. The most important principle, as mentioned in Section 4: Readability matters.
<p />
<h3><a name="Exceptions_to_the_Puppet_Style_G"></a> Exceptions to the Puppet Style Guide </h3> <ul>
<li> Section 6: [Module files] Should not exceed an <span style="color: #F60;">80</span> character line width &rArr; <span style="color: #F60;">120</span> character line width (as we do with Python)
</li></ul> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Additional_Local_Conventions"></a> Additional Local Conventions </span></h2> <ul>
<li> Write one module per role (e.g., itb_ce)
</li> <li> Write one module per software component (e.g., the Globus gatekeeper)
</li> <li> Write one node file (in the <code>modules/nodes/manifests</code> directory) per node <ul>
<li> Each one should contain very little code
</li> <li> Include the <code>itb_common</code> class and the Puppet class for the node’s role (e.g., <code>itb_ce</code>)
</li></ul> 
</li> <li> Modules must not include sensitive data (e.g., unencrypted private keys) — they are stored on a public system
</li></ul> 
<p />
A role Puppet class should have a parameter called <code>$osgver</code> to specify the major version of the software stack that it will use. The class should include the <code>osg_release</code> Puppet class, passing on the <code>$osgver</code> parameter. For example, the <code>itb_ce</code> class should include the following code:
<p />
<pre class="file">
class itb_ce ($osgver) {
  class { 'osg_release':
    osgver => $osgver,
  }
  ...
}
</pre>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Tips"></a> Tips </span></h2>
<p /> <ul>
<li> <p>You might need to have variables depending on parameters of the system (for example EL5 versus EL6). It might be useful to set these variables in a separate file called <code>params.pp</code> and include it in the main class for the role.</p>
</li> <li> <p>You should make all changes in your environment first, and merge them to production once they are ready.</p>
</li> <li> <p>It is very important for maintainability to maintain a tree structure for Puppet configs.</p>     <p>This makes seeing class dependencies easier. Puppet often lends itself to a mesh structure &mdash; must try hard to resist that.</p>
</li> <li> <p>A config should be divided up into multiple definitions when you start seeing repetition.</p>     <p>Treat a definition like you would a function in a traditional programming language.</p>
</li> <li> <p>Defined types are useful for working around places where traditional programming language semantics are missing from Puppet (e.g., iteration).</p>
</li> <li> <p>Avoid using resource collectors (the <code>&lt;| |&gt;</code> syntax) &mdash; they have problems, such as silent failures, that make debugging difficult.</p>
</li> <li> <p>Keep a consistent ordering of parameters in resources &mdash; have <code>ensure</code> be the first item in files, for example &mdash; [TimC: We should define this for common types.]</p>
</li> <li> <p>Puppet hashes and lists are often useful, but keep in mind that they are immutable &mdash; once set, they cannot be changed.</p>
</li> <li> <p>PuppetForge may have useful modules.</p>     <p>You probably should not use them verbatim, but instead use them as examples. (An exception should be made for the <code>stdlib</code> module, which is official. (<strong>Mat TODO</strong>: See if you can get stdlib to work &mdash; Moate claimed problems, but they may be solvable)).</p>
</li> <li> <p>Containment is often useful, but you need to take care to avoid creating spaghetti dependencies.</p>     <p>Again, ensure that your dependencies form a tree structure.</p>
</li></ul> </div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: SoftwareTeam<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/SoftwareTeam/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a> &gt; <a href="/bin/view/SoftwareTeam/InternalDocs" class="twikiLink">InternalDocs</a> &gt; <a href="/bin/view/SoftwareTeam/MadisonITB" class="twikiLink">MadisonITB</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>MadisonITBInstanceConfiguration</span> <br />    
Topic revision: r7 - 15 Nov 2016 - 15:19:04 - <a href="/bin/view/Main/TimCartwright" class="twikiLink">TimCartwright</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />