<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> TestRunsAsVMs &lt; SoftwareTeam &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/SoftwareTeam/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/SoftwareTeam/TestRunsAsVMs?_T=16 Feb 2017" type="application/x-wiki" title="edit TestRunsAsVMs" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/SoftwareTeam/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/SoftwareTeam/TestRunsAsVMs"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#DDDDDD;
	}
	.patternBookView {
		border-color:#DDDDDD;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--TWISTYPLUGIN_TWISTY--><style type="text/css" media="all">
@import url("https://twiki.opensciencegrid.org/twiki/pub/TWiki/TwistyContrib/twist.css");
</style>
<script type='text/javascript' src='https://twiki.opensciencegrid.org/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js'></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikiPref.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TwistyContrib/twist.compressed.js"></script>
<script type="text/javascript">
// <![CDATA[
var styleText = '<style type="text/css" media="all">.twikiMakeVisible{display:inline;}.twikiMakeVisibleInline{display:inline;}.twikiMakeVisibleBlock{display:block;}.twikiMakeHidden{display:none;}</style>';
document.write(styleText);
// ]]>
</script>

<!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Running_Tests_as_VM_Jobs"></a> Running Tests as VM Jobs </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Running_Tests_as_VM_Jobs"> Running Tests as VM Jobs</a> <ul>
<li> <a href="?cover=print#Setting_up_credentials"> Setting up credentials</a>
</li> <li> <a href="?cover=print#Running_osg_test_in_VM_Universe"> Running osg-test in VM Universe</a>
</li> <li> <a href="?cover=print#Troubleshooting"> Troubleshooting</a> <ul>
<li> <a href="?cover=print#Missing_Unicode_Fonts"> Missing Unicode Fonts</a>
</li></ul> 
</li> <li> <a href="?cover=print#Notes_about_running_osg_test_as"> Notes about running osg-test as VM jobs</a> <ul>
<li> <a href="?cover=print#Using_VM_Universe_in_HTCondor"> Using VM Universe in HTCondor</a>
</li> <li> <a href="?cover=print#Using_VM_Universe_in_CHTC"> Using VM Universe in CHTC</a>
</li> <li> <a href="?cover=print#Selecting_a_VM_Type"> Selecting a VM Type</a>
</li> <li> <a href="?cover=print#Creating_VM_Images"> Creating VM Images</a>
</li> <li> <a href="?cover=print#Handling_Input_and_Output"> Handling Input and Output</a>
</li> <li> <a href="?cover=print#Interactively_connecting_to_a_VM"> Interactively connecting to a VM</a>
</li></ul> 
</li></ul> 
</li></ul> 
</div>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Setting_up_credentials"></a> Setting up credentials </span></h2>
<p />
<font color="#ff0000"> <strong>Note:</strong> This one time setup must be performed before submitting any test jobs.</font>
<p /> <ol>
<li> <p>Contact Brian L. or Tim C. to have an account created on <code>osghost.chtc.wisc.edu</code></p>
</li> <li> SSH to <code>osghost</code> (you will need to do this from the UW-Madison network) and create a password-less SSH key:       <pre class="screen">[user@client ~]$ ssh-keygen -C 'VMU test result upload key for <font color="#ff0000">&lt;user&gt;</font>@osghost' -f ~/.ssh/test_result_upload.key
</pre>
</li> <li> Contact BrianL or MatS with your public key. They will add your public key to the <code>authorized_keys</code> file of the <code>cndrutil</code> user on <code>ingwe</code>.
</li> <li> Add <code>ingwe's</code> pubkey to your <code>known_hosts</code> file by initiating an SSH connection. You do not need to login:    <pre class="screen">[user@client ~]$ ssh ingwe.cs.wisc.edu
The authenticity of host 'ingwe.cs.wisc.edu (128.105.121.64)' can't be established.
RSA key fingerprint is 8c:44:ac:fd:c5:9e:1c:7a:c1:e1:42:40:c3:e5:4b:fc.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'ingwe.cs.wisc.edu,128.105.121.64' (RSA) to the list of known hosts.
blin@ingwe.cs.wisc.edu's password:
</pre>
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Running_osg_test_in_VM_Universe"></a> Running osg-test in VM Universe </span></h2>
<p />
The procedure explained in this section replaces <a href="https://twiki.opensciencegrid.org/bin/view/SoftwareTeam/SoftwareDevelopmentProcess" target="_top">this</a> if and only if there are functional tests for each package being tested. 
<p /> <ol>
<li> From <code>osghost.chtc.wisc.edu</code>, make and populate a test run directory:       <pre class="screen">[user@client ~]$ osg-run-tests '&lt;insert description of run here&gt;'</pre>
</li> <li> Change to the test run directory (see output of osg-run-tests)
</li> <li> If you need to change <code>osg-test</code>, use one of the methods below: <ul>
<li> Make changes to a github fork of osg-test and prepend the source lines in the yaml parameters files (see below) with the following: <code>&lt;Github account&gt;:&lt;branch of osg-test&gt;;</code>
</li> <li> Edit <code>test-changes.patch</code> with test module and library changes and/or edit <code>osg-test.patch</code> with osg-test script changes. These patches can be generated with <code>git diff</code>.
</li></ul> 
</li> <li> If there are test failures that shouldn't be marked as failures in the reporting, edit <code>test-exceptions.yaml</code>; you can add test failures to ignore with the following format:       <pre class="file"># - [test_function, test_module, start date, end date]. 
<font color="#ff0000">- [test_04_trace, test_55_condorce, 2014-12-01, 2015-01-14]</font></pre>
</li> <li> If you want to change test run parameters, edit <code>parameters.d/osg32.yaml</code>, <code>parameters.d/osg33-el6.yaml</code>, or <code>parameters.d/osg33-el7.yaml</code>;  or you can add/remove yaml files with the same format. Each file in <code>paramaters.d</code> generates an osg-test run for every possible combination of the <code>platforms</code>, <code>sources</code>, and <code>package_sets</code> parameters in that file. <ol>
<li type="i"> To change the distribution, modify the <code>platforms</code> section. Accepted values are listed below:      <pre class="file">platforms:
  - centos_6_x86_64
  - rhel_6_x86_64
  - sl_6_x86_64
  - centos_7_x86_64
  - rhel_7_x86_64
  - sl_7_x86_64
</pre>
</li> <li type="i"> To change the repos that packages are installed from, edit the sources section, which has the following format:       <pre class="file">[&lt;Github account&gt;:&lt;branch of osg-test&gt;;] &lt;Initial OSG Version&gt;; &lt;Intial yum repo&gt; [&gt;] [&lt;Update OSG Version&gt;/][&lt;Update yum repo&gt;]
<font color="#ff0000"># Run osg-test with packages from 3.1-release</font>
3.1; osg
<font color="#ff0000"># Run osg-test with packages from 3.1-testing that are then upgraded to 3.2-testing</font>
3.1; osg-testing &gt; 3.2/osg-testing
<font color="#ff0000"># Run osg-test with packages from 3.2-release and 3.2-testing that are then upgraded to 3.3-testing and 3-3-upcoming-testing</font>
3.2; osg, osg-testing &gt; 3.3/osg-testing, osg-upcoming-testing
<font color="#ff0000"># Run osg-test from the 'opensciencegrid' github account using the 'master' branch (https://github.com/opensciencegrid/osg-test.git) with packages from 3.2-testing</font>
opensciencegrid:master; 3.2; osg-testing</pre>       i. The <code>package_sets</code> section controls the packages that are installed, the label used for reporting, whether or not SELinux is enabled (default: disabled), and whether or not to pre-install the OSG Java packages (default: enabled):       <pre class="file">package_sets:
  #### Required ####
  # label - used for reporting, should be consistent across param files
  # packages - list of packages to install in the test run
  #### Optional ####
  # selinux - enable SELinux for the package set, otherwise Permissive mode (default: False)
  # osg_java - Pre-install OSG java packages (default: True)
  ##################
  - label: All
    selinux: False
    osg_java: True
    packages:
      - osg-tested-internal
  - label: HTCondor
    selinux: False
    osg_java: True
    packages:
      - condor.x86_64
      - osg-ce-condor
      - rsv</pre>
</li> <li type="i"> The test infrastructure can read multiple yaml files in <code>parameters.d</code>, which allows you to run different, mutually exclusive tests. For example, if you wanted to test 3.3 development on EL7 in addition to the standard tests, you could add the following to a file in <code>paramaters.d</code>:       <pre class="file">platform:
  - centos_7_x86_64
  - sl_7_x86_64

sources:
  - 3.3; osg-development

package_sets:
  - label: All
    selinux: False
    osg_java: True
    packages:
      - osg-tested-internal
  # Explicitly add GRAM packages since they were dropped from osg-ce (SOFTWARE-2278, SOFTWARE-2291)
  - label: All + GRAM (3.2)
    selinux: False
    osg_java: True
    packages:
      - osg-tested-internal-gram
  - label: HTCondor
    selinux: False
    osg_java: True
    packages:
      - condor.x86_64
      - osg-ce-condor
      - rsv
  - label: GridFTP
    selinux: True
    osg_java: True
    packages:
      - osg-gridftp
      - edg-mkgridmap
      - rsv
  - label: BeStMan
    selinux: False
    osg_java: True
    packages:
      - osg-se-bestman
      - rsv
  - label: VOMS
    selinux: False
    osg_java: True
    packages:
      - osg-voms
      - rsv
  - label: GUMS
    selinux: False
    osg_java: True
    packages:
      - osg-gums
      - rsv
</pre>
</li></ol> 
</li> <li> Submit the test run (you must submit the DAG from the run directory):   <pre class="screen">[user@client ~]$ ./master-run.dag</pre>
</li> <li> Monitor the test run (as desired):       <pre class="screen">[user@client ~]$ condor_q -dag</pre>
</li> <li> When the test run finishes, an email will go out to members of the software team (hardcoded in <code>email-analysis</code>). In the e-mail will be links to the web interface which will often not work immediately because the test results only get transferred over every 15 minutes.
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Troubleshooting"></a> Troubleshooting </span></h2>
<p />
<h3><a name="Missing_Unicode_Fonts"></a> Missing Unicode Fonts </h3>
<p />
The HTML reports for the testing results utilize unicode characters (namely the padlock to represent that SELinux was enabled). If these characters are appearing as the character code in a block, that means that the font you're using does not support these characters. To render these characters properly, perform the following steps:
<p /> <ol>
<li> Download a suitable Unicode Emoji font.  We have had success with the "Noto Emoji" font available from <a href="https://www.google.com/get/noto/" target="_top">https://www.google.com/get/noto/</a>
</li> <li> Create a <code>~/.fonts/</code> dir if one does not already exist
</li> <li> Copy the <code>.ttf</code> file from the downloaded font <code>.zip</code> file into <code>~/.fonts/</code>
</li> <li> Run <code>fc-cache -f</code>
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Notes_about_running_osg_test_as"></a> Notes about running osg-test as VM jobs </span></h2>
<p />
This page is my (cat) collected notes and ideas about running osg-test runs as VM jobs, either locally (e.g., CHTC) or in OSG.
<p />
<h3><a name="Using_VM_Universe_in_HTCondor"></a> Using VM Universe in HTCondor </h3>
<p />
For HTCondor 8.0, the documentation for VM universe is in <a href="http://research.cs.wisc.edu/htcondor/manual/v8.0/2_11Virtual_Machine.html" target="_top">section 2.11</a> of <a href="http://research.cs.wisc.edu/htcondor/manual/v8.0/" target="_top">the manual</a>.
<p />
Some quick notes:
<p /> <ul>
<li> <code>universe = vm</code>
</li> <li> <code>executable</code> is just a label
</li> <li> Omit <code>input</code>, <code>output</code>, and <code>error</code>, as they are not used and will cause submit failures
</li> <li> Must select a <code>vm_type</code> of <code>vmware</code>, <code>xen</code>, or <code>kvm</code>
</li></ul> 
<p />
<p />
<h3><a name="Using_VM_Universe_in_CHTC"></a> Using VM Universe in CHTC </h3>
<p />
The only VM universe support in CHTC was using a now-archaic version of <a href="http://www.vmware.com" target="_top">VMware</a>; this was set up in support of the Thomas Jahns lab. Essentially, in July 2013, there is no current support. However, the CHTC infrastructure team is interested in adding real support for at least kvm.
<p />
On 3 July 2013, Nate Yehle proposed working with us to add kvm support in stages. Roughly:
<p /> <ol>
<li> Nate will set up kvm on <code>osghost.chtc.wisc.edu</code> to create a playground
</li> <li> Nate will show TimC how to run an arbitrary image on <code>osghost</code>
</li> <li> TimC will iterate on a basic SL6 VM image (probably using BoxGrinder, see below) until it starts, runs a simple process, and exits cleanly
</li> <li> Nate and TimC will work together to identify and solve any issues with the test VM image, especially concerning networking
</li> <li> Nate will set up one CHTC node with kvm support
</li> <li> TimC will try to run the test VM image on the CHTC node using HTCondor
</li> <li> Iterate and grow as needed and possible
</li></ol> 
<p />
<p />
<h3><a name="Selecting_a_VM_Type"></a> Selecting a VM Type </h3>
<p />
On 2 July 2013, Jaime and ToddM suggested focusing on kvm as the VM type. People on the team have the most experience with kvm. Avoid VMware (no reasons recorded).
<p />
To run our test code, use the <code>rc.local</code> system (file? directory?). It should run last in the startup sequence, after all other services are running. Ask ToddM for help, if needed. Once the tests are done, shut down the VM from the same script.
<p />
<p />
<h3><a name="Creating_VM_Images"></a> Creating VM Images </h3>
<p />
At the heart of each test run will be a base OS image, containing a relatively bare-bones OS installation along with a few key files to set up networking, users, certificates, etc.
<p />
The base images, one for each platform on which we wish to test, will need to be recreated periodically, say once a week, and reused many times. Thus, the process of creating a base OS image must be scriptable. There are tools to create Linux installations on VM images:
<p /> <ul>
<li> John Hover has used <a href="http://boxgrinder.org" target="_top">BoxGrinder</a> to do his virtualization work. It has not received an update since mid-2012, but has been sufficient for his needs.
</li> <li> <a href="https://github.com/clalancette/oz/wiki" target="_top">Oz</a> is newer and support some but not all of BoxGrinder’s features. Tony Tiradani at Fermi uses it.
</li> <li> <a href="http://imgfac.org" target="_top">Image Factory</a> builds on Oz by adding features to prepare and install VM images for cloud deployment. It is available via RPM on EL 6, Fedora 16, and Fedora 17 platforms from their own repository, as described in <a href="http://imgfac.org/documentation/install.html" target="_top">the installation documentation</a>.
</li></ul> 
<p />
John H. (11 July 2013) noted that BoxGrinder may run only on the latest Fedora releases, such as 17 and 18; I did not check whether this is true. Also, John noted that he had some problems with BoxGrinder: He could not install both x86-64 and i386 RPMs at the same time, due to limitations in the tool; and there were some issues with EC2, but they would not affect us. John’s BoxGrinder patches are available in his source code repository.
<p />
One other thing to think about: BoxGrinder appliance files are fairly simple to understand and reference files contained in the same directory. However, imagefactory uses one giant XML file, with all installed files inlined. Yuck!
<p />
Tony Tiradani at Fermi also has experience with creating VM images. He uses Oz, and <a href="https://github.com/holzman/gwms-cloud-vms/tree/development" target="_top">has a Subversion repository</a> with an example of his TDL file.
<p />
<a href="http://docs.openstack.org/trunk/openstack-image/content/ch_creating_images_automatically.html" target="_top">Another document</a>, on the OpenStack site, gives an example of using Oz with EPEL.
<p />
If there are performance issues with transferring this image, likely to be 4GB or so, the CHTC infrastructure folks could set up some kind of caching, possibly via the Ken Hahn Filesystem.
<p />
<h4><a name="Commands"></a> Commands </h4>
<p />
<h5><a name="Oz"></a> Oz </h5>
<p />
<pre class="screen">oz-install -d 4 -p -u -x oz-generated-libvirt.xml sl64.tdl</pre>
<p /> <ul>
<li> The <code>-d 4</code> option yields maximum debugging output
</li> <li> The <code>-p</code> option removes the existing guest image file
</li> <li> The <code>-u</code> option runs the image customization steps (after installation is done)
</li> <li> The argument is the name of the TDL XML file
</li></ul> 
<p />
<h5><a name="Virsh"></a> Virsh </h5>
<p />
To load the definition of the guest into virsh:
<p />
<pre class="screen">virsh define cat-libvirt.xml</pre>
<p /> <ul>
<li> The second argument is the name of the libvirt domain definition file, as documented <a href="http://libvirt.org/formatdomain.html" target="_top">on the libvirt website</a>. It is an XML file that defines what the VM guest configuration, including things like the guest name, memory size, VM image(s), networking configuration, etc.
</li></ul> 
<p />
To start the guest:
<p />
<pre class="screen">virsh start cat.chtc.wisc.edu</pre>
<p /> <ul>
<li> The second argument is the guest name, as defined in the domain definition file.
</li></ul> 
<p />
To stop the guest, as though disconnecting the power:
<p />
<pre class="screen">virsh destroy cat.chtc.wisc.edu</pre>
<p /> <ul>
<li> The second argument is the guest name, as defined in the domain definition file.
</li></ul> 
<p />
To remove the definition of the guest from virsh:
<p />
<pre class="screen">virsh undefine cat.chtc.wisc.edu</pre>
<p /> <ul>
<li> The second argument is the guest name, as defined in the domain definition file.
</li></ul> 
<p />
<h4><a name="Configuring_for_a_Static_IP_Addr"></a> Configuring for a Static IP Address </h4>
<p />
To make an image that will run as cat.chtc.wisc.edu, I need to tell both kvm (externally, on the host) and the image the same fixed MAC address. From within the original cat.chtc.wisc.edu machine, I found that <code>ifconfg</code> reports <code>eth0</code> as the primary interface. So this file:
<p />
<pre>/etc/sysconfig/network-scripts/ifcfg-eth0</pre>
<p />
needs to contain:
<p />
<pre>DEVICE=eth0
ONBOOT=yes
HWADDR=00:16:3E:45:66:99
TYPE=Ethernet
BOOTPROTO=dhcp</pre>
<p />
<h4><a name="Hostname_and_Host_Certificates"></a> Hostname and Host Certificates </h4>
<p />
The test runs will need a valid host certificate. How to accomplish this?
<p />
Jaime and ToddM suggested getting a single, static hostname from the CSL. Then, the networking system in the base OS images would be set up such that this name would resolve, but only on the VM itself, not going out to the network. Then, we could request a host certificate from DigiCert for this fixed hostname, and that host certificate would be shipped with the base OS VM image. Jaime and ToddM know how to set up the fake hostname lookups in the VM configuration.
<p />
<p />
<h3><a name="Handling_Input_and_Output"></a> Handling Input and Output </h3>
<p />
To handle input and output, Jaime and ToddM recommended having separate, small image files for them. Thus, two extra images, beyond the OS base install itself, may be needed:
<p /> <ul>
<li> An input image, containing only a single text file with test run conditions.
</li> <li> An output image, initially empty and for saving the output log file(s). This image would be the only file transferred back from the run.
</li></ul> 
<p />
The <code>qemu-img</code> tool make images and may be sufficient for the input and output images.
<p />
Alternatively, John (11 July 2013) noted that there are tools designed for supplying a limited amount of input to an otherwise static VM image. He called this the “HEPIX contextualization approach”, although the HEPIX system is just one implementation. One possibility is the <code>cloud-init</code> package from Ubuntu, available on all Linux systems that we care about. I found <a href="https://launchpad.net/cloud-init" target="_top">a project page</a> and <a href="http://cloudinit.readthedocs.org/en/latest/" target="_top">some documentation</a>.
<p />
<h4><a name="libguestfs"></a> libguestfs </h4>
<p />
To get <code>guestfish</code> and other tools, I had to install an extra package:
<p />
<pre class="screen">yum install libguestfs-tools-c</pre>
<p />
This brought along another package:
<p />
<pre class="screen">Installed:
  libguestfs-tools-c.x86_64 1:1.16.34-2.el6

Dependency Installed:
  libconfig.x86_64 0:1.3.2-1.1.el6</pre>
<p />
To get <code>virt-make-fs</code> (recommended by Dave B.), there was another install:
<p />
<pre class="screen">yum install libguestfs-tools</pre>
<p />
More packages:
<p />
<pre class="screen">Installed:
  libguestfs-tools.x86_64 1:1.16.34-2.el6

Dependency Installed:
  perl-Sys-Guestfs.x86_64 1:1.16.34-2.el6
  perl-Sys-Virt.x86_64 0:0.9.10-4.el6
  perl-XML-Parser.x86_64 0:2.36-7.el6
  perl-XML-Writer.noarch 0:0.606-6.el6
  perl-XML-XPath.noarch 0:1.13-10.el6
  perl-libintl.x86_64 0:1.20-1.el6</pre>
<p />
<h5><a name="Creating_the_Input_Output_Image"></a> Creating the Input/Output Image </h5>
<p /> <ol>
<li> Create an input directory:<pre class="screen">mkdir input</pre>
</li> <li> Create an input options file in <code>input/options.txt</code>:<pre class="file">--add-user --dump-output --verbose --install=ndt</pre>
</li> <li> Make the input/output image file (raw format): <pre class="screen">virt-make-fs --size=1M input /var/lib/libvirt/images/vm-io-disk.raw</pre>
</li></ol> 
<p />
<h5><a name="Getting_Files_from_the_Image_Man"></a> Getting Files from the Image Manually </h5>
<p /> <ol>
<li> Create a mount point:<pre class="screen">mkdir /mnt/output</pre>
</li> <li> Mount the input/output image locally:<pre class="screen">mount -o loop /var/lib/libvirt/images/vm-io-disk.raw /mnt/stuff</pre>
</li> <li> Copy files to local disk:<pre class="screen">cp -p /mnt/output/*.log output/</pre>
</li> <li> Unmount the input/output image:<pre class="screen">umount /mnt/stuff</pre>
</li></ol> 
<p />
<h5><a name="Getting_Files_from_the_Image_Aut"></a> Getting Files from the Image Automatically </h5>
<p />
<pre class="screen">guestfish --ro --add vm-io-disk.raw --mount /dev/vda:/ download /osg-test-20130802.log osg-test-20130802.log</pre>
<p />
<h3><a name="Interactively_connecting_to_a_VM"></a> Interactively connecting to a VM </h3>
<p />
Unfortunately, VM Universe jobs don't have the ssh_to_job capacity that's available to other Condor jobs so if we need to investigate test failures in VMU, we'll have to spin up our own VM's. We can do this by taking the images that Neil automatically generates and create new ones from them that don't automatically run osg-test (Right now, Neil has to manually copy over the updated images. Eventually, we should have an automated way to get the most updated VMU images). Here are the steps you need to follow to set up your own VM:
<p /> <ol>
<li> Grab the make-interactive-image from git :<pre class="screen">git clone git@github.com:opensciencegrid/vm-test-runs.git</pre>
</li> <li> Run <code>make-interactive-image</code> using the flavor and version of Linux you need, VMU images are in <code>/kvm</code> (NOTE: the output image needs to be in a directory that's readable by the <code>qemu</code> user): <pre class="screen">vm-test-runs/make-interactive-image /kvm/<font color="#ff0000">&lt;input image&gt;</font> <font color="#ff0000">&lt;output image&gt;</font></pre>
</li> <li> Make a copy of <code>/kvm/libvirt-template.xml</code> and edit the @DOMAIN@ and @IMAGEFILE@ to a name that will be used by virsh and the path to the output file you created in the previous step. <div class="twistyPlugin twikiMakeVisibleInline">  <span id="twistyIdSoftwareTeamTestRunsAsVMs1show" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Click to show libvirt-template.xml...</span></a> </span> <span id="twistyIdSoftwareTeamTestRunsAsVMs1hide" class="twistyRememberSetting twistyStartHide twistyTrigger twikiUnvisited twistyHidden twistyInited0"><a href="#"><img src="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" border="0" alt="" /><span class="twikiLinkLabel twikiUnvisited">Hide Full Output</span></a> </span>  </div><!--/twistyPlugin twikiMakeVisibleInline--> <div class="twistyPlugin"><div id="twistyIdSoftwareTeamTestRunsAsVMs1toggle" class="twistyRememberSetting twistyStartHide twistyContent twikiMakeHidden twistyInited0"> <pre>
&#60;domain type&#61;&#34;kvm&#34;&#62;

  &#60;name&#62;&#64;DOMAIN&#64;&#60;/name&#62;

  &#60;memory unit&#61;&#34;KiB&#34;&#62;4145152&#60;/memory&#62;
  &#60;vcpu&#62;1&#60;/vcpu&#62;
  &#60;os&#62;
    &#60;type&#62;hvm&#60;/type&#62;
    &#60;boot dev&#61;&#34;hd&#34;/&#62;
  &#60;/os&#62;
  &#60;features&#62;&#60;acpi/&#62;&#60;/features&#62;

  &#60;devices&#62;

    &#60;emulator&#62;/usr/libexec/qemu-kvm&#60;/emulator&#62;

    &#60;disk type&#61;&#34;file&#34; device&#61;&#34;disk&#34;&#62;
      &#60;source file&#61;&#34;&#64;IMAGEFILE&#64;&#34;/&#62;
      &#60;target dev&#61;&#34;hda&#34; bus&#61;&#34;virtio&#34;/&#62;
    &#60;/disk&#62;

    &#60;interface type&#61;&#34;bridge&#34;&#62;
      &#60;mac address&#61;&#34;00:16:3e:45:66:99&#34;/&#62;
      &#60;source bridge&#61;&#34;br0&#34;/&#62;
      &#60;target dev&#61;&#34;vnet1&#34;/&#62;
      &#60;model type&#61;&#34;virtio&#34;/&#62;
    &#60;/interface&#62;

    &#60;graphics type&#61;&#34;vnc&#34; autoport&#61;&#34;yes&#34; listen&#61;&#34;128.105.244.224&#34;/&#62;

  &#60;/devices&#62;

&#60;/domain&#62;
</pre> </div></div> <!--/twistyPlugin-->
</li> <li> Edit the init script that kicks off tests to not shutdown the machine: <ol>
<li> Run <code>virt-copy-out -a <em>IMAGEFILE</em> /etc/osg-test.init /tmp</code> where <em>IMAGEFILE</em> is your disk image from step 2
</li> <li> Edit <code>/tmp/osg-test.init</code> and put <code>exit 0</code> right after the mount command
</li> <li> Run <code>virt-copy-in -a <em>IMAGEFILE</em> /tmp/osg-test.init /etc</code>
</li></ol> 
</li> <li> Define and start the VM with your copy of the xml file: <pre class="screen">virsh create <font color="#ff0000">&lt;xml file&gt;</font></pre>
</li> <li> Connect to the VM (consult <span class="twikiNewLink">BrianL<a href="/bin/edit/SoftwareTeam/BrianL?topicparent=SoftwareTeam.TestRunsAsVMs" rel="nofollow" title="BrianL (this topic does not yet exist; you can create it)">?</a></span>, Mat or Carl for the password). You can use either the domain name or the ID returned by <code>virsh list</code>:<pre class="screen">virsh console <font color="#ff0000">&lt;DOMAIN&gt;</font></pre>
</li> <li> Cleanup the VM. You can use either the domain name or the ID returned by <code>virsh list</code>:<pre class="screen">virsh destroy <font color="#ff0000">&lt;DOMAIN&gt;</font></pre>
</li></ol> </div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: SoftwareTeam<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/SoftwareTeam/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a> &gt; <a href="/bin/view/SoftwareTeam/TestingHome" class="twikiLink">TestingHome</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>TestRunsAsVMs</span> <br />    
Topic revision: r48 - 18 Jan 2017 - 17:19:39 - <a href="/bin/view/Main/CarlEdquist" class="twikiLink">CarlEdquist</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />