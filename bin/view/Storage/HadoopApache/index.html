<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> HadoopApache &lt; Storage &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Storage/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Storage/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Storage/HadoopApache?_T=16 Feb 2017" type="application/x-wiki" title="edit HadoopApache" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Storage/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Storage/HadoopApache"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#0000FF;
	}
	.patternBookView {
		border-color:#0000FF;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Hadoop_Apache"></a>  <strong><noop>Hadoop Apache</strong> </h1>
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Installation"> Installation</a> <ul>
<li> <a href="?cover=print#Prerequisites"> Prerequisites</a>
</li> <li> <a href="?cover=print#Install_packages"> Install packages</a>
</li> <li> <a href="?cover=print#Basic_Configuration"> Basic Configuration</a>
</li> <li> <a href="?cover=print#SSL_support"> SSL support</a>
</li></ul> 
</li></ul> 
</div>
<p />
<h1><a name="Installation"></a> Installation </h1>
<p />
Hadoop's HDFS filesystem provides a mostly POSIX compliant interface using FUSE.  When HDFS is mounted using FUSE, the files can be accessed using standard filesystem tools like ls, cp, and such.  Apache can make use of this fuse mount to export the HDFS files through the more common http protocol.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Prerequisites"></a> Prerequisites </span></h2>
<p /> <ol>
<li> This guide assumes you have already installed <a href="/bin/view/Storage/HadoopInstallation" class="twikiLink">Hadoop and configured the FUSE mount</a> on the web server machine.
</li> <li> FUSE mounted.  You do not need to run any of the hadoop services on the web server, but you do need to have the fuse mount available.
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Install_packages"></a> Install packages </span></h2>
<p />
Install the web server and GUMS client (latter two are only needed for SSL authentication):
<p />
<code>yum install httpd mod_ssl gums-client</code>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Basic_Configuration"></a> Basic Configuration </span></h2>
<p />
Create a new file called <code>/etc/httpd/conf.d/hadoop.conf</code> with the following contents:
<p />
<pre>
Alias /hadoop /mnt/hadoop/

&#60;Directory /mnt/hadoop/&#62;
        Options Indexes
        IndexIgnore favicon.ico
        IndexOptions FancyIndexing
        AllowOverride None
        Order allow,deny
        Allow from all
&#60;/Directory&#62;
</pre>
<p />
You can customize the Allow/Deny rules as appropriate for your site's policies.  A stricter access control system based on user x509 certificates is described below.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="SSL_support"></a> SSL support </span></h2>
<p />
Described here is just one way to enable authenticated access to the HDFS files.  This is probably the most complicated way to configure user authentication, but it allows you to control access based on a user's VO membership.
<p />
First you will need to install and configure the gums-client package on the web server.  You can install the gums client with <code>yum install gums-client</code>.  Configuration is described in the <a href="/bin/view/Storage/HadoopGratia#Configuration" class="twikiAnchorLink">Hadoop Gratia configuration section</a>.  Basically, if you are using SSL, edit <code>/etc/gums/client.properties</code> to reflect the actual location of your GUMS server.
Add the SSL options at the end of the <code><Directory></code> section in <code>/etc/httpd/conf.d/hadoop.conf</code> above:
<p />
<pre>
Alias /hadoop/ /mnt/hadoop/
Alias /hadoop /mnt/hadoop/

&#60;Directory /mnt/hadoop/&#62;
        Options Indexes
        IndexIgnore favicon.ico
        IndexOptions FancyIndexing
        AllowOverride None
        Order allow,deny
        Allow from all

        # Options below here are needed for SSL authentication
        SSLOptions +StdEnvVars +StrictRequire +FakeBasicAuth
        AuthType Basic
        AuthName &#34;Restricted Files&#34;
        AuthBasicProvider file
        # Don&#39;t forget that all users must have the fake password &#39;password&#39;
        AuthUserFile /etc/httpd/http.passwd
        Require valid-user

        SSLRequire (    &#37;{SSL&#95;CIPHER} !~ m/^(EXP&#124;NULL)/ \
            and &#37;{SSL&#95;CLIENT&#95;VERIFY} eq &#34;SUCCESS&#34; \
            and &#37;{SSL&#95;CLIENT&#95;V&#95;REMAIN} &#62;&#61; 0 )
&#60;/Directory&#62;
</pre>
<p />
Update <code>/etc/httpd/conf.d/ssl.conf</code> to enable SSL client authentication.  An entire <code>ssl.conf</code> file is quoted below, but the important pieces are <code>SSLVerifyClient</code> and <code>SSLVerifyDepth</code>.  The <code>RewriteRule</code> is a convenient way to protect against users who accidentally type <code>http</code> into their browser window instead of <code>https</code>.
<p />
The file below assumes that your certificate and key are installed in
<p />
<pre>
/etc/grid-security/http/httpcert.pem
/etc/grid-security/http/httpkey.pem
</pre>
<p />
and that the user <code>apache</code> can read both of them.
<p />
<pre>
LoadModule ssl&#95;module modules/mod&#95;ssl.so
Listen 443

RewriteEngine On
RewriteCond &#37;{HTTPS} off
RewriteRule (.&#42;) https://&#37;{HTTP&#95;HOST}&#37;{REQUEST&#95;URI}

AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl

SSLPassPhraseDialog  builtin
SSLSessionCache         shmcb:/var/cache/mod&#95;ssl/scache(512000)
SSLSessionCacheTimeout  300
SSLMutex default
SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin
SSLCryptoDevice builtin

&#60;VirtualHost &#95;default&#95;:443&#62;
ErrorLog logs/ssl&#95;error&#95;log
#ErrorLog syslog:local1
TransferLog logs/ssl&#95;access&#95;log
LogLevel warn

SSLEngine on
SSLProtocol all -SSLv2
SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
SSLCertificateFile /etc/grid-security/httpcert.pem
SSLCertificateKeyFile /etc/grid-security/httpkey.pem
SSLCACertificatePath /etc/grid-security/certificates/
SSLCARevocationPath /etc/grid-security/certificates/
SSLVerifyClient require
SSLVerifyDepth 10

SetEnvIf User-Agent &#34;.&#42;MSIE.&#42;&#34; \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0

CustomLog logs/ssl&#95;request&#95;log \
          &#34;&#37;t &#37;h &#37;{SSL&#95;PROTOCOL}x &#37;{SSL&#95;CIPHER}x &#37;{SSL&#95;CLIENT&#95;S&#95;DN}x &#37;{SSL&#95;CLIENT&#95;S&#95;DN&#95;Email}x \&#34;&#37;r\&#34; &#37;b&#34;
&#60;/VirtualHost&#62;

</pre>
<p />
Create a script called <code>/usr/bin/populateUsers.sh</code> with the following contents.  You will have to customize the script with your host DN, and update the grep statement to filter only the users that you want to authorize.  In this example, only users from the uscms pool accounts are allowed access.
<p />
<pre>
#!/bin/sh

source /etc/profile.d/java.sh

tempPasswdFile&#61;`mktemp`
passwdFile&#61;/etc/httpd/hadoop.passwd
cmsmapfile&#61;/etc/grid-security/grid-mapfile

mysubject&#61;`openssl x509 -noout -in /etc/grid-security/hostcert.pem -subject &#124; cut -d &#39; &#39; -f 2-`
gums --host generateGridMapfile &#34;$mysubject&#34; &#62; ${mapfile}
userlist&#61;`cat ${mapfile} &#124; sed -e &#39;/^#/d&#39; -e &#39;s/^&#34;//&#39; -e &#39;s/&#34; .&#42;//&#39;`

# Loop over lines in the output, not space-separated fields
export IFS&#61;$&#39;\n&#39;

for user in ${userlist} ; do
    htpasswd -b ${tempPasswdFile} &#34;${user}&#34; password
done

cp ${tempPasswdFile} ${passwdFile}
rm ${tempPasswdFile}
chmod 640 ${passwdFile}
chown apache. ${passwdFile}
</pre>
<p />
The script should be run from a cron job at least once per day to make sure the list of VO members is kept up to date.  This can be done by doing the following in a shell as root:
<p />
<pre>
echo &#34;5 &#42;/12 &#42; &#42; &#42; root /usr/bin/populateUsers.sh&#34; &#62; /etc/cron.d/populateUsers
</pre></div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Storage<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Storage/WebHome" class="twikiCurrentWebHomeLink twikiLink">WebHome</a> &gt; <a href="/bin/view/Storage/Hadoop" class="twikiLink">Hadoop</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>HadoopApache</span> <br />    
Topic revision: r5 - 30 Sep 2010 - 13:49:42 - <a href="/bin/view/Main/BrianBockelman" class="twikiLink">BrianBockelman</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />