<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> AdminSetupMPI &lt; Documentation &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Documentation/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Documentation/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Documentation/AdminSetupMPI?_T=16 Feb 2017" type="application/x-wiki" title="edit AdminSetupMPI" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Documentation/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Documentation/AdminSetupMPI"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#FFFF99;
	}
	.patternBookView {
		border-color:#FFFF99;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <link rel="stylesheet" type="text/css" href="https://twiki.opensciencegrid.org/twiki/pub/Documentation/Tools/exercises.css">
<p />
<!-- This is the default OSG documentation template. Please modify it in -->
<!-- the sections indicated to create your topic.                        --> 
<p />
<!-- By default the title is the <span class="twikiNewLink">WikiWord<a href="/bin/edit/Documentation/WikiWord?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="WikiWord (this topic does not yet exist; you can create it)">?</a></span> used to create this topic. If  -->
<!-- you want to modify it to something more meaningful, just replace    -->
<!-- <a href="/bin/view/Documentation/AdminSetupMPI" class="twikiCurrentTopicLink twikiLink">AdminSetupMPI</a> below with i.e "My Topic".                                  -->
<p />
<h1><a name="Admin_Setup_MPI"></a>  Admin Setup MPI </h1>
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Adding_site_specific_MPI_attribu"> Adding site specific MPI attributes</a>
</li> <li> <a href="?cover=print#Add_JobManager_specific_bits"> Add JobManager-specific bits</a>
</li> <li> <a href="?cover=print#PBS_and_Modules_Purdue"> PBS and Modules (Purdue)</a> <ul>
<li> <a href="?cover=print#Enable_the_handle_attribute"> Enable the "handle" attribute</a>
</li> <li> <a href="?cover=print#Make_appropriate_changes_to_the"> Make appropriate changes to the Globus JobManager</a>
</li></ul> 
</li></ul> 
</div>
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Adding_site_specific_MPI_attribu"></a> Adding site specific MPI attributes </span></h2>
Follow the instructions on the <a href="/bin/view/ReleaseDocumentation/GenericInformationProviders" class="twikiLink">Generic Information Providers</a> page to add Glue attributes. The following is an example of how to add an MPICH version along with the module information.
<p />
In etc/add-attributes.conf:
<pre class=screen>
# MPICH Intel
dn: GlueSoftwareLocalID=MPICH_1.2.7p1_intel, GlueSubClusterUniqueID=lepton.rcac.
purdue.edu, GlueClusterUniqueID=lepton.rcac.purdue.edu,mds-vo-name=local,o=grid
objectClass: GlueClusterTop
objectClass: GlueSoftware
objectClass: GlueKey
objectClass: GlueSchemaVersion
GlueHostApplicationSoftwareRunTimeEnvironment: MPICH_1.2.7p1_intel
GlueSoftwareLocalID: MPICH_1.2.7p1_intel
GlueSoftwareName: MPICH
GlueSoftwareVersion: 1.2.7.p1_intel
GlueSoftwareInstalledRoot: /apps/steele/mpich-1.2.7p1/64/p4-intel-10.1.015
GlueSoftwareModuleName: mpich-intel
GlueSoftwareEnvironmentSetup: module load mpich-intel
GlueChunkKey: GlueSubClusterUniqueID=lepton.rcac.purdue.edu
GlueSchemaVersionMajor: 1
GlueSchemaVersionMinor: 3
</pre>
<p />
in etc/alter-attributes.conf:
<pre class=screen>
GlueHostApplicationSoftwareRunTimeEnvironment: MPICH_1.2.7p1_gcc
</pre>
<p />
There are a few points to make here. First, the <span class="twikiNewLink">SoftwareInstalledRoot<a href="/bin/edit/Documentation/SoftwareInstalledRoot?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="SoftwareInstalledRoot (this topic does not yet exist; you can create it)">?</a></span> tells the user the location of the binaries and libraries for each MPI version. The <span class="twikiNewLink">SoftwareEnvironmentSetup<a href="/bin/edit/Documentation/SoftwareEnvironmentSetup?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="SoftwareEnvironmentSetup (this topic does not yet exist; you can create it)">?</a></span> attribute tells the user what module or softenv command to use in order to utilize the MPI version in their job. Finally, the <span class="twikiNewLink">SoftwareName<a href="/bin/edit/Documentation/SoftwareName?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="SoftwareName (this topic does not yet exist; you can create it)">?</a></span> and <span class="twikiNewLink">SoftwareVersion<a href="/bin/edit/Documentation/SoftwareVersion?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="SoftwareVersion (this topic does not yet exist; you can create it)">?</a></span> attributes make the MPI version easier to find using an ldapsearch.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Add_JobManager_specific_bits"></a> Add <span class="twikiNewLink">JobManager<a href="/bin/edit/Documentation/JobManager?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="JobManager (this topic does not yet exist; you can create it)">?</a></span>-specific bits </span></h2>
The hardest part of getting MPI jobs running is setting up the <span class="twikiNewLink">JobManager<a href="/bin/edit/Documentation/JobManager?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="JobManager (this topic does not yet exist; you can create it)">?</a></span> to deal with different MPI versions. In a general sense, there are only two things that need to be done: <ul>
<li> Enable the "handle" attribute in the appropriate .rvf file
</li> <li> Add an MPI section to your <span class="twikiNewLink">JobManager<a href="/bin/edit/Documentation/JobManager?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="JobManager (this topic does not yet exist; you can create it)">?</a></span> <scheduler>.pm file
</li></ul> 
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="PBS_and_Modules_Purdue"></a> PBS and Modules (Purdue) </span></h2>
Purdue uses a combination of the PBS scheduler and the <a href="http://modules.sourceforge.net/" target="_top">modules</a> environment management software. Most schedulers and environment managers should follow a similar pattern.
<p />
<h3><a name="Enable_the_handle_attribute"></a> Enable the "handle" attribute </h3>
The first thing to do is to change the appropriate .rvf file in Globus. For PBS, this is in $GLOBUS_LOCATION/share/globus_gram_job_manager/pbs.rvf
<p />
Add the following lines to enable the "handle" RSL attribute:
<pre class=screen>
Attribute: handle
Description: "Defines the module that should be loaded"
ValidWhen: GLOBUS_GRAM_JOB_SUBMIT
</pre>
<p />
<h3><a name="Make_appropriate_changes_to_the"></a> Make appropriate changes to the Globus <span class="twikiNewLink">JobManager<a href="/bin/edit/Documentation/JobManager?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="JobManager (this topic does not yet exist; you can create it)">?</a></span> </h3>
Next, the appropriate <span class="twikiNewLink">JobManager<a href="/bin/edit/Documentation/JobManager?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="JobManager (this topic does not yet exist; you can create it)">?</a></span> file needs to be modified to do something with our new handle attribute. For PBS, this file is located in $GLOBUS_LOCATION/lib/perl/Globus/GRAM/JobManager/pbs.pm
<p />
First, we'll define a few variables to allow sites to customize the handle for whatever environment manager they use. The main variables to change are those starting with "$handle_" :
<pre class=screen>
BEGIN
    {
        $mpisoftenv     = 0;                                    # 0=false, 1=true
        $handle_init    = 'source /etc/profile.d/modules.sh';   # Command to load environment manager
        $handle_load    = 'module load';                        # Command to load module/softenv
        $handle_default = 'mpich-1.2.7p1-intel64/9.1.045';
        $mpiexec        = 'mpiexec';
        $mpirun         = 'mpirun';
        $qsub           = '/usr/pbs/bin/qsub';
        $qstat          = '/usr/pbs/bin/qstat';
        $qselect        = '/usr/pbs/bin/metascheduler2.pl';
        $qdel           = '/usr/pbs/bin/qdel';
        $cluster        = 1;
        $cpu_per_node   = 2;
        $remote_shell   = '/usr/bin/ssh';
        $softenv_dir    = '/opt/softenv';
        $soft_msc       = "$softenv_dir/bin/soft-msc";
        $softenv_load   = "$softenv_dir/etc/softenv-load.sh";
    }
</pre>
<p />
<p />
The next change to make is to get the handle name from the job description. To do this, add the following line in the sub submit{} stanza:
<pre class=screen>
    my $handle = $description->handle();
</pre>
<p />
The next change is the stanza to take care of the PBS job script:
<pre class=screen>
        if ($description->jobtype() eq "mpi")
        {
            my $this_count = ($description->totalprocesses() > 0) ?
                $description->totalprocesses() : $description->count();
            my $machinefilearg = ($cluster) ? ' -machinefile $PBS_NODEFILE' : '';

            if ($mpisoftenv)
            {
                print JOB 'which mpiexec >/dev/null 2>&1' . "\n";
                print JOB 'if [ $? == 0 ]; then' . "\n";
                print JOB "  mpiexec $machinefilearg -n " . $this_count;
                print JOB " $cmd_script_name < " .  $description->stdin() . "\n";
                print JOB 'else' . "\n";
                print JOB '  which mpirun >/dev/null 2>&1' . "\n";
                print JOB '  if [ $? == 0 ]; then' . "\n";
                print JOB "    mpirun -np " . $this_count . $machinefilearg;
                print JOB " $cmd_script_name < " .  $description->stdin() . "\n";
                print JOB '  else' . "\n";
            }
            else
            {
                print JOB "$handle_init\n";
                # Check to see if user specified a module to load...
                if ($handle ne '')
                {
                    print JOB "$handle_load $handle\n";
                }
                # ... otherwise load a default module
                else
                {
                    print JOB "$handle_load $handle_default\n";
                }
        
                if ($handle =~ m/mpich2/)
                {
                    print JOB "$mpirun -np " . $this_count;
                }
                else        
                {
                    print JOB "$mpirun -np " . $this_count . $machinefilearg;
                }
                
                print JOB " " .  $description->executable() . " $args < " . $description->stdin() . "\n";
            }
        }

</pre>
<p />
<p />
<p />
<p />
<p />
<p />
<p />
<p />
<p />
<hr />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Backlinks"></a>  Backlinks </span></h2>
<p />
<hr/>
Twiki topics in <a href="/bin/view/Documentation/WebHome" class="twikiCurrentWebHomeLink twikiLink">Documentation</a> web containing an "INCLUDE" of this page: <br />     
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table1" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> Section </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLast"> Topic </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol twikiLast"> Last Updated by </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<div class="patternSearchResultCount">Number of topics: <span class="twikiSearchResultCount">0</span></div><!--/patternSearchResultCount--><p />
<p />
<p />
Twiki topics in all others webs containing an "INCLUDE" of this page: <br />     
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table2" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> Section </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLast"> Topic </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol2 twikiLastCol twikiLast"> Last Updated by </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
<p />
<p />
<a href="/twiki/bin/oops/Documentation/AdminSetupMPI?template=backlinksweb" target="_top">All references to this document in the <strong>Documentation</strong> web only</a>  <br />      <a href="/twiki/bin/oops/Documentation/AdminSetupMPI?template=backlinksallwebs" target="_top">All references to this document in <strong>all</strong> webs</a>
<p />
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Child_Topics"></a>  Child Topics </span></h2>
<p />
<strong><em>Immediate children of this topic include the following:</em></strong>
<ul></ul>
<p />
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Major_Updates"></a>  Major Updates </span></h2>
<p />
<p />
-- <a href="/bin/view/Main/AndrewHoward" class="twikiLink">AndrewHoward</a> - 04 Dec 2008
<p />
-- <a href="/bin/view/Main/AndrewHoward" class="twikiLink">AndrewHoward</a> - 25 Feb 2009 - Changed hard coded values to use variables</div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Documentation<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>AdminSetupMPI</span> <br />    
Topic revision: r2 - 25 Feb 2009 - 16:28:33 - <span class="twikiNewLink">AndrewHoward<a href="/bin/edit/Documentation/AndrewHoward?topicparent=Documentation.AdminSetupMPI" rel="nofollow" title="AndrewHoward (this topic does not yet exist; you can create it)">?</a></span>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />