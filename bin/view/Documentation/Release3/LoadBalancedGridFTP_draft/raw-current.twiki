&lt;style type=&quot;text/css&quot;&gt;
code em, pre em { color: red; font-weight: normal; font-style: normal; }
&lt;/style&gt;

&lt;div style=&quot;border: 1px solid black; margin: 1em 0; padding: 1em; background-color: #FFDDDD; font-weight: 600;&quot;&gt;
---+!! Draft Documentation
Consider this document to be a late draft: The technical content has been reviewed, and is *mostly* complete and accurate. Here are the known issues with the document now:
   * It needs a troubleshooting section
   * The suggested use of CA certificates must be reviewed
   * The section on optional backup balancers needs further review and clarifications
   * The section on disabling ARP needs further review and clarifications
We expect to complete the document during the week of 17&amp;ndash;20 January 2017.
&lt;/div&gt;

---+ Load Balancing !GridFTP

%TOC{depth=&quot;3&quot;}%

---++ About This Guide

!GridFTP is designed for high throughput data transfers and in many cases can handle all of the transfers for a site. However, in some cases it may be useful to run multiple !GridFTP servers to distribute the load. For such sites, we recommend using a [[https://en.wikipedia.org/wiki/Load_balancing_(computing)][load balancer]] to distribute requests and present the appearance of a single high-throughput !GridFTP server.

One general-purpose technology for implementing a load balancer on Linux is [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server]] (LVS). To use it with !GridFTP, a single load balancer listens on a virtual IP address, monitors the health of the set of real !GridFTP servers, and forwards requests to available ones. Optionally, there can be one or more inactive, backup load balancers that can activate and take over the virtual IP address in case the primary load balancer fails, resulting in a system that is more resilient to failure. LVS is implemented by the [[http://www.linuxvirtualserver.org/software/ipvs.html][IP Virtual Server]] kernel module, which can be managed by userspace services on the load balancers such as [[http://www.keepalived.org][keepalived]].

This guide explains how to install, configure, run, test, and troubleshoot the =keepalived= service on a load balancing host for a set of [[Documentation.Release3/InstallOSGGridFTP][GridFTP]] servers.

---++ Linux Virtual Server Overview

%RED%&lt;b&gt;TODO:&lt;/b&gt;%ENDCOLOR% Content would be good

#BeforeStarting
---++ Before Starting

Before starting the installation process, consider the following points:

%RED%&lt;b&gt;TODO:&lt;/b&gt;%ENDCOLOR%

   * DNS setup LVS, hostname -&gt; virtual IP
   * Shared service certificate among real servers
   * Real server and load balancer general HW requirements
   * Networking requirements

As with all OSG software installations, there are some one-time (per host) steps to prepare in advance:

   * Ensure the host has [[SupportedOperatingSystems][a supported operating system]]
   * Obtain root access to the host

---++ Preparing !GridFTP Real Servers

If you already have !GridFTP installed on your real servers, skip the installation section and continue to the [[#ConfigureReal][the LVS-specific configuration]].

---+++ Installing !GridFTP

Whether you are starting from scratch or adding more !GridFTP servers to your LVS, follow the documentation for [[Documentation.Release3.InstallOSGGridFTP][installing a standalone !GridFTP server]] for each of your real servers (skip section 2.2, requesting a certificate).

%NOTE% Validation of services, this can be ignored.

#ConfigureReal
---+++ Configuring your real servers

Each real server requires a service certificate, changes to its IP configuration, and potentially its arptables: 

   * [[#ConfigureCert][Install shared service certificate]]
   * [[#AddingVIP][Adding your virtual IP address]]
   * [[#DisableArp][Disabling ARP]] &amp;minus; if your real servers are on the same network segment as the virtual IP

#ConfigureCert
---++++ Install shared service certificate

When communicating with a !GridFTP server, clients verify that the host certificate matches the hostname of the server. In the case of an LVS, clients will contact the server via the hostname associated with the virtual IP address, so the server will have to present the shared service certificate ([[#BeforeStarting][instructions for acquiring the shared service certificate]]). Place the certificate key-pair on each real server and configure !GridFTP to use it:

&lt;ol&gt;
  &lt;li&gt;
     &lt;p&gt;Create a directory to contain the shared service certificate:&lt;/p&gt;
     &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% mkdir /etc/grid-security/gridftp&lt;/pre&gt;
   &lt;/li&gt;
   &lt;li&gt;
     &lt;p&gt;Place the shared service certifificate-key pair in the newly created directory:&lt;/p&gt;
     &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% mv &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;PATH TO SERVICE CERT&lt;/span&gt; /etc/grid-security/gridftp/gridftp-hostcert.pem
%UCL_PROMPT_ROOT% mv &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;PATH TO SERVICE KEY&lt;/span&gt; /etc/grid-security/gridftp/gridftp-hostkey.pem&lt;/pre&gt;
     
   &lt;/li&gt;
   &lt;li&gt;
     &lt;p&gt;Configure =/etc/sysconfig/globus-gridftp-server= to use the shared service certificate-key pair&lt;/p&gt;
     &lt;pre class=&quot;file&quot;&gt;export X509_USER_CERT=/etc/grid-security/gridftp/gridftp-hostcert.pem
export X509_USER_KEY=/etc/grid-security/gridftp/gridftp-hostkey.pem&lt;/pre&gt;
   &lt;/li&gt;
   &lt;li&gt;
     &lt;p&gt;Restart the =globus-gridftp-server= service:&lt;/p&gt;
%TABLE{sort=&quot;off&quot;}%
| *On EL&amp;nbsp;6, run the command&amp;hellip;* | *On EL&amp;nbsp;7, run the command&amp;hellip;* |
| =service globus-gridftp-server restart= | =systemctl restart globus-gridftp-server= |     
   &lt;/li&gt;
&lt;/ol&gt;   

#AddingVIP
---++++ Adding your virtual IP address

Use the same virtual IP address as your load balancers as the secondary IP on your real servers. Add it using the =ip= tool:

&lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% ip addr add &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt;/&lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;SUBNET MASK&lt;/span&gt; dev &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;INTERFACE (e.g. eth0)&lt;/span&gt;&lt;/pre&gt;

%RED%&lt;b&gt;TODO:&lt;/b&gt;%ENDCOLOR% How to persist across reboots?

#DisableArp
---++++ Disabling ARP

If your real servers are only listening on the same network as your virtual IP address, skip to [[#UsingKeepalived][the section on using keepalived]]. If your real servers and load balancer(s) are on the same network segment, you will have to disable ARP on the real servers to avoid [[http://kb.linuxvirtualserver.org/wiki/ARP_Issues_in_LVS/DR_and_LVS/TUN_Clusters][ARP race conditions]]:

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Select the appropriate RPM:&lt;/p&gt;
%TABLE{sort=&quot;off&quot;}%
| *If your operating system version is…* | *Then use the following package(s)…* |
| Enterprise Linux 6 | =arptables_jf= |
| Enterprise Linux 7 | =arptables= |    
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Install the arptables software:&lt;/p&gt;
    &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% yum install arptables_jf&lt;/pre&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Disable ARP:&lt;/p&gt;
    &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% arptables -F
%UCL_PROMPT_ROOT% arptables -A IN -d &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt; -j DROP
%UCL_PROMPT_ROOT% arptables -A OUT -s &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt; -j mangle --mangle-ip-s &lt;span style=&quot;background-color: #D1CAF2;&quot;&gt;REAL IP ADDRESS&lt;/span&gt;&lt;/pre&gt;  &lt;/li&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Save ARP tables to survive reboots:&lt;/p&gt;
    &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% arptables-save &gt; /etc/sysconfig/arptables&lt;/pre&gt;    
  &lt;/li&gt;
&lt;/ol&gt;

---++ Preparing Keepalived Load Balancers

---+++ Installing Keepalived

Whether you run a single load balancer, or have one active load balancer and some inactive backups, each load balancer host must have the =keepalived= software installed, configured, and running.

%NOTE% Do not install =keepalived= on the !GridFTP servers themselves.

The =keepalived= package is available from the operating system repositories. Install it on each load balancer host using the following commands:

&lt;ol&gt;
%INCLUDE{&quot;Documentation/Release3/OSGReleaseSeries&quot; section=&quot;Update&quot;}%
  &lt;li&gt;
    &lt;p&gt;Install the =keepalived= package:&lt;/p&gt;
    &lt;pre class=&quot;rootscreen&quot;&gt;%UCL_PROMPT_ROOT% yum install keepalived&lt;/pre&gt;
  &lt;/li&gt;
&lt;/ol&gt;

---+++ Required configuration

On the primary load balancer, edit =/etc/keepalived/keepalived.conf=:

&lt;pre class=&quot;file&quot;&gt;global_defs {
   router_id &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;LABEL FOR YOUR LVS&lt;/span&gt;
}

vrrp_instance VI_gridftp {
    state MASTER
    interface &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;INTERFACE (e.g. eth0)&lt;/span&gt;
    virtual_router_id &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;ARBITRARY ID, 0–255&lt;/span&gt;
    priority 100
    virtual_ipaddress {
        &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt;/&lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;SUBNET MASK&lt;/span&gt; dev &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;INTERFACE (e.g., eth0)&lt;/span&gt;
    }
}

virtual_server &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt; 2811 {
    delay_loop 10
    lb_algo wlc
    lb_kind DR
    protocol tcp

    real_server &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;GRIDFTP SERVER #1 IP ADDRESS&lt;/span&gt; 2811 {
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;GRIDFTP SERVER #2 IP ADDRESS&lt;/span&gt; 2811 {
        TCP_CHECK {
            connect_timeout 3
        }
    }
    &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;[&amp;hellip;]&lt;/span&gt;
}&lt;/pre&gt;

%NOTE% Use the same =VIRTUAL IP ADDRESS= throughout your LVS configuration.

%NOTE% In the =virtual_server= section, write one =real_server= subsection per !GridFTP server behind the load balancer.

#OptionalConfig
---+++ Optional configuration

The following configuration steps are optional and will likely not be required for setting up a small cluster of !GridFTP hosts. If you do not need any of the following special configurations, skip to [[#UsingKeepalived][the section on using keepalived]].

   * [[#BackupLoadBalancers][Adding backup load balancers]]
   * [[#EmailNotifications][Enabling e-mail notifications]]

#BackupLoadBalancers
---++++ Adding backup load balancers

If you need to add backup load balancers, copy =/etc/keepalived/keepalived.conf= from your primary load balancer and change the =state= and =priority= attributes under your =vrrp_instance VI_gridftp= section:

%NOTE% Priority specifies the order of preferred load balancer fallback where larger values corresponds to a higher preference.

&lt;pre class=&quot;file&quot;&gt;vrrp_instance VI_gridftp {
    state BACKUP
    interface &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;INTERFACE (e.g. eth0)&lt;/span&gt;
    virtual_router_id &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;SAME ID AS MASTER LOAD BALANCER&lt;/span&gt;
    priority &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;PRIORITY INTEGER&lt;/span&gt;
    virtual_ipaddress {
        &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;VIRTUAL IP ADDRESS&lt;/span&gt;/&lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;SUBNET MASK&lt;/span&gt; dev &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;INTERFACE (e.g., eth0)&lt;/span&gt;
    }
}
&lt;/pre&gt;

#EmailNotifications
---++++ Enabling e-mail notifications

To receive e-mails when the state of your LVS cluster changes, update the =global_defs= section of =/etc/keepalived/keepalived.conf= for each of your load balancer nodes:

&lt;pre class=&quot;file&quot;&gt;
notification_email {
&lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;NOTIFY EMAIL ADDRESS #1&lt;/span&gt;
&lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;NOTIFY EMAIL ADDRESS #2&lt;/span&gt;
&lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;...&lt;/span&gt;
}
notification_email_from &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;FROM EMAIL ADDRESS&lt;/span&gt;
smtp_server &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;SMTP SERVER IP ADDRESS&lt;/span&gt;
smtp_connect_timeout 60
router_id &lt;span style=&quot;background-color: #FFCCFF;&quot;&gt;STRING IDENTIFYING MACHINE&lt;/span&gt;
&lt;/pre&gt;

#UsingKeepalived
---+++ Using Keepalived

%TABLE{sort=&quot;off&quot;}%

On the load balancer nodes, =keepalived= is the only additional service required for running an LVS. As a reminder, here are common service commands (all run as =root=):

%TABLE{sort=&quot;off&quot;}%
| *To &amp;hellip;* | *On EL&amp;nbsp;6, run the command&amp;hellip;* | *On EL&amp;nbsp;7, run the command&amp;hellip;* |
| Start a service | =service keepalived start= | =systemctl start keepalived= |
| Stop a service | =service keepalived stop= | =systemctl start keepalived= |
| Enable a service to start during boot | =chkconfig keepalived on= | =systemctl enable keepalived= |
| Disable a service from starting during boot | =chkconfig keepalived off= | =systemctl disable keepalived= |

---++ Verifying your Linux Virtual Server

%RED%&lt;b&gt;TODO:&lt;/b&gt;%ENDCOLOR% Content waiting on replies from Garhan/John

---++ Getting Help

To get assistance with =keepalived= in front of OSG Software services, please use the [[Documentation.HelpProcedure][this page]].

#ReferenceSection
---++ Reference

   * [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server homepage]]
   * [[http://www.keepalived.org/index.html][Keepalived homepage]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Load_Balancer_Administration/index.html][RHEL 7 Load Balancer Administration Guide]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Load_Balancer_Administration/index.html][RHEL 6 Load Balancer Administration Guide]]
   * [[https://github.com/gattebury/gridftp-with-lvs][T2 Nebraska LVS installation notes]]

