<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> InstallGratia_DRAFT &lt; Documentation/Release3 &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Documentation/Release3/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Documentation/Release3/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Documentation/Release3/InstallGratia_DRAFT?_T=16 Feb 2017" type="application/x-wiki" title="edit InstallGratia_DRAFT" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Documentation/Release3/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Documentation/Release3/InstallGratia_DRAFT"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#FFFFFF;
	}
	.patternBookView {
		border-color:#FFFFFF;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">



</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Installing_and_Maintaining_Grati"></a> Installing and Maintaining Gratia Accounting </h1>
<p />
<div class="twikiToc"> <ul>
<li> <a href="?cover=print#Installing_and_Maintaining_Grati"> Installing and Maintaining Gratia Accounting</a> <ul>
<li> <a href="?cover=print#About_This_Guide"> About This Guide</a>
</li> <li> <a href="?cover=print#Installing_Gratia"> Installing Gratia</a>
</li> <li> <a href="?cover=print#Configuring_Gratia"> Configuring Gratia</a> <ul>
<li> <a href="?cover=print#Optional_Configuration"> Optional Configuration</a>
</li></ul> 
</li> <li> <a href="?cover=print#Reference"> Reference</a>
</li></ul> 
</li></ul> 
</div>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="About_This_Guide"></a> About This Guide </span></h2>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Installing_Gratia"></a> Installing Gratia </span></h2>
<p />
Installation, setup and troubleshooting of the Gratia probes <ul>
<li> The <a href="/bin/view/Documentation/Release3/InstallComputeElement" class="twikiLink">Compute Element install document</a> will tell you also how to install its Gratia probes (for HTCondor, PBS, LSF, RSV, ...), mostly using <code>osg-configure</code> that simplifies the configuration.
</li> <li> Similarly install documents of Storage Elements describe also probes installation and configuration.
</li> <li> <a href="/bin/view/Accounting/ProbeConfigGlideinWMS" class="twikiLink">Gratia probe for HTCondor</a>. Pay attention to <a href="/bin/view/Accounting/ProbeConfigGlideinWMS#Users_without_Certificates" class="twikiAnchorLink">this section</a> if you are in a Campus Grid or any setup where x509 authentication (Grid certificates for users) is NOT used.
</li> <li> <a href="/bin/view/Documentation/Release3/InstallGlideinWMSFrontend#GratiaAccounting" class="twikiAnchorLink">Installing the HTCondor probe on a VO Frontend</a>
</li> <li> <a href="/bin/view/Documentation/Release3/GlideinWMSCampusGrid#GratiaAccounting" class="twikiAnchorLink">HCCondor probe in a Campus Grid</a>
</li> <li> <a href="/bin/view/Documentation/Release3/InstallAwsVmGratiaProbe" class="twikiLink">InstallAwsVmGratiaProbe</a>
</li></ul> 
<!-- <ul>
<li> <a href="/bin/view/Documentation/Release3/InstallGratiaLrmsProbe" class="twikiLink">Install and Configure Gratia LRMS Probes</a> (HTCondor, PBS, LSF, SGE, GE, ...)
</li></ul> 
-->   
<p /> <ul>
<li> <a href="/bin/view/Documentation/Release3/TroubleshootingGratia" class="twikiLink">Troubleshooting Gratia</a>
</li></ul> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Configuring_Gratia"></a> Configuring Gratia </span></h2>
<p />
In normal cases, <code>osg-configure</code> does the editing of the probe configuration files, at least on the CE. The configuration is found in <code>/etc/osg/config.d/30-gratia.ini</code> and <a href="/bin/view/Documentation/Release3/IniConfigurationOptions#Gratia" class="twikiAnchorLink">documented elsewhere</a>. 
<p />
If there are problems or special configuration, you might need to edit the Gratia configuration files yourself. Each probe has a separate configuration file found in <code>/etc/gratia/<font color="#ff0000">PROBE-NAME</font>/ProbeConfig</code>. 
<p />
The ProbeConfig files have many details. A few options that you might need to edit are shown before. This is <strong>not</strong> a complete file, but only shows a subset of the options.
<p />
<pre class="file">
&lt;ProbeConfiguration 

    CollectorHost="gratia-osg-itb.opensciencegrid.org:80"
    SSLHost="gratia-osg-itb.opensciencegrid.org:80"
    SSLRegistrationHost="gratia-osg-itb.opensciencegrid.org:80"

    ProbeName="condor:fermicloud084.fnal.gov"
    SiteName="WISC_OSG_EDU"
    EnableProbe="1"
/>
</pre>
<p />
The options you see here are:
<p />
<table cellspacing="0" cellpadding="0" border="0" class="twikinetWrapperTable" rules="none">
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableT twikinetWrapperTableTL"></td>
<td class="twikinetWrapperTableT twikinetWrapperTableTR"></td>
</tr>
<tr class="twikinetWrapperTableRow">
<td colspan="2" class="twikinetWrapperTableMain">
<table cellspacing="0" id="table1" cellpadding="0" class="twikiTable" rules="cols" border="1">
		<tr class="twikiTableOdd twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol0 twikiFirstCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/InstallGratia_DRAFT?cover=print;sortcol=0;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Option</font></a> </th>
			<th bgcolor="#d8dde4" valign="top" class="twikiTableCol1 twikiLastCol"> <a rel="nofollow" href="/bin/view/Documentation/Release3/InstallGratia_DRAFT?cover=print;sortcol=1;table=1;up=0#sorted_table" title="Sort by this column"><font color="#252b37">Comments</font></a> </th>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> CollectorHost </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> The Gratia server this probe reports to </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> SSLHost </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol"> The Gratia server this probe reports to </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> SSLRegistrationHost </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> The Gratia server this probe reports to </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol"> ProbeName </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol"> The unique name for this probe. Note that it includes the probe type and the host name </td>
		</tr>
		<tr class="twikiTableEven twikiTableRowdataBgSorted0 twikiTableRowdataBg0">
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol0 twikiFirstCol"> SiteName </td>
			<td bgcolor="#ffffff" valign="top" class="twikiTableCol1 twikiLastCol"> The name of your site, as registered in OIM. If your site must be registered in OIM </td>
		</tr>
		<tr class="twikiTableOdd twikiTableRowdataBgSorted1 twikiTableRowdataBg1">
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol0 twikiFirstCol twikiLast"> EnableProbe </td>
			<td bgcolor="#f2f3f6" valign="top" class="twikiTableCol1 twikiLastCol twikiLast"> The probe will only run if this is "1" </td>
		</tr></table>
</td>
</tr>
<tr class="twikinetWrapperTableRow">
<td class="twikinetWrapperTableB twikinetWrapperTableBL"></td>
<td class="twikinetWrapperTableB twikinetWrapperTableBR"></td>
</tr>
</table>
<p />
Again, there are many more options in this file. Most of the time you won't need to touch them.
<p />
<h3><a name="Optional_Configuration"></a> Optional Configuration </h3>
<p />
If you have an OSG Compute Element all the pieces should be present and you should report correctly to Gratia. But sometimes you may require special configurations: some of the jobs have no VO association and risk not to be reported to the OSG accounting (Gratia)
<p />
<p /> <dl>
<dt> <img src="/twiki/pub/TWiki/TWikiDocGraphics/help.gif" alt="HELP" title="HELP" width="16" height="16" border="0" />     <strong><font color="#ff0000"> NOTE </font></strong> </dt><dd>  Before modifying your local configuration check if those are jobs you should count or if someone else should count them. Avoid double counting and choose the most appropriate place to report the jobs. E.g. If you are receiving jobs from a Compute Element that is forwarding them to you (e.g. via HTCondor flocking), the CE first accepting them should report those jobs. The same applies if you have a gateway accepting jobs and resubmitting them via BOSCO.
</dd></dl> 
<p />
<h4><a name="All_your_jobs_belong_to_a_VO"></a> All your jobs belong to a VO </h4>
If you have no CE or have a mix of Grid submitted and local jobs running on your cluster and you want to report them all as running for a specific VO, then set VOOverride in the probe configuration. Further, if you want to keep track also of the original local group, add also MapGroupToRole.  In the below example, replace the <font color="#ff0000">osg</font> with a registered VO that you would like to report as.  If you don't have a VO that you are affiliated with, you may use "osg".
<p />
<pre class="file">
...
    <font color="#ff0000">MapGroupToRole="1"</font>
    <font color="#ff0000">VOOverride="OSG"</font>
...
</pre>
<p />
<h4><a name="You_are_running_a_Campus_Grid_an"></a> You are running a Campus Grid and have no Compute Element </h4>
If you have a HTCondor cluster connected to a <a href="https://twiki.grid.iu.edu/bin/view/Accounting/ProbeConfigGlideinWMS#Users_without_Certificates" target="_top">campus grid</a> you can use 3 different ways to associate your jobs to a VO. The last 2 reported below, especially the 3rd, allow you to map only some of the jobs, e.g. if you do not want to report some jobs to OSG accounting: <ul>
<li> If all your users belong to one VO you can use the example above.
</li> <li> Otherwise you can use the local Group Names as VO names (you'd have to have control of the unix groups) <pre class="file">
    ...
    SuppressGridLocalRecords="0"
    <font color="#ff0000">MapUnknownToGroup="1"</font>
    ...
</pre>
</li> <li> As 3rd alternative you can use <code>user-vo-map</code> as explained below
</li></ul> 
<p />
<h4><a name="You_have_some_local_users_that_y"></a> You have some local users that you want to report to OSG accounting </h4>
If some users are already associated to a VO, e.g. via one of the mechanisms described in the previous chapter, and some users are not part of any VO and you don't want to report them at all: a flexible mechanism is the use of the <a href="https://twiki.grid.iu.edu/bin/view/Documentation/Release3/Edg-mkgridmap#3_0_Configuration" target="_top">user-vo-map file</a>. If you are already an OSG site you may also use GUMS.
<p />
<code>/var/lib/osg/user-vo-map</code> is a file generated automatically on a CE via <a href="https://twiki.grid.iu.edu/bin/view/Documentation/Release3/Edg-mkgridmap" target="_top">edg-mkgridmap</a> or GUMS. In it there is a list of valid VO names and all users are mapped to a VO. See <a href="http://vdt.cs.wisc.edu/extras/edg-mkgridmap.conf.html" target="_top">user-vo-map file</a> for more information. 
<p />
<h5><a name="In_GUMS"></a> In GUMS </h5>
You can define <a href="https://www.racf.bnl.gov/Facility/GUMS/1.2/use_configuration.html" target="_top">groupToAccountMappings</a> and <a href="https://www.racf.bnl.gov/Facility/GUMS/1.2/use_users.html" target="_top">add Manual Users Group Members</a>.
<p />
<h5><a name="Using_Edg_mkgridmap"></a> Using Edg-mkgridmap </h5>
If you want to add some local user and map it to an existing VO, then edit <code>/etc/osg/local-user-vo-map</code> mapping the users, e.g.:
<pre class="file">
# file /etc/osg/local-user-vo-map
newuser1 voname
newuser2 voname
newuser3 voname2
</pre>
<p />
If you want to add some local user and map it to a new VO, then edit <code>/etc/osg/local-user-vo-map</code> mapping the users as before, and also add the VO lines to <code>/etc/edg-mkgridmap.conf</code>, e.g. if <code>voname2</code> used above is new:
<pre class="file">
# file /etc/edg-mkgridmap.conf
# USER-VO-MAP voname2 REPORTABLE_VONAME2 -- 13 -- This is my local VO (admin@mydomain.edu)
</pre>
After USER-VO-MAP there are the VOName and ReportableVOName for the accounting record and then some arbitrary comments.
<p />
<p /> <dl>
<dt> <img src="/twiki/pub/TWiki/TWikiDocGraphics/help.gif" alt="HELP" title="HELP" width="16" height="16" border="0" />     <strong><font color="#ff0000"> NOTE </font></strong> </dt><dd>  All the files above are part of the OSG Compute Element installation but you can still edit by hand a <code>/var/lib/osg/user-vo-map</code> with the mappings you are interested in and the Gratia probes will use it even if you have no OSG CE installed.
</dd></dl> 
<p />
<a name="ReferenceSection"></a>
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Reference"></a> Reference </span></h2>
<p /> <ul>
<li> <a href="/bin/view/Documentation/Release3/GratiaIntroduction_DRAFT" class="twikiLink">Gratia Probe Introduction</a>
</li> <li> <a href="/bin/view/Documentation/Release3/TroubleshootingGratia_DRAFT" class="twikiLink">Troubleshooting Gratia Probes</a>
</li> <li> <a href="/bin/view/Documentation/Release3/GratiaReference_DRAFT" class="twikiLink">Gratia Probe Reference</a>
</li></ul> </div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Documentation/Release3<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>InstallGratia_DRAFT</span> <br />    
Topic revision: r6 - 28 Nov 2016 - 22:40:39 - <a href="/bin/view/Main/BrianLin" class="twikiLink">BrianLin</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />