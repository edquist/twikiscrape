<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> UserSchool15Wed14matlab &lt; Education &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Education/UserSchool15Wed14matlab?_T=16 Feb 2017" type="application/x-wiki" title="edit UserSchool15Wed14matlab" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Education/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Education/UserSchool15Wed14matlab"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">

@import url('/pub/Documentation/Tools/exercises.css ');

</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <style type="text/css">
pre em { font-style: normal; background-color: yellow; }
pre strong { font-style: normal; font-weight: bold; color: #008; }
</style>
<p />
<h1><a name="Wednesday_Exercise_1_4_Matlab"></a> Wednesday Exercise 1.4: Matlab </h1>
<p />
The goal of this exercise is to compile Matlab code and run it.  This exercise will draw on the idea of writing a wrapper script to install and run code, first introduced in <a href="/bin/view/Education/UserSchool15Wed13wrapper" class="twikiLink">Exercise 1.3</a> and should take 25-30 minutes. 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Background"></a> Background </span></h2>
<p />
Matlab is licensed; however, unlike most licensed software, it has the ability to be compiled and the compiled code can be run without a license.  We will be compiling Matlab <code>.m</code> files into a binary file and running that binary using a set of files called the Matlab runtime. 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Matlab_Code"></a> Matlab Code </span></h2>
<p /> <ol>
<li> Log in to the CHTC submit server (<code>osg-ss-submit.chtc.wisc.edu</code>).  
</li> <li> Create a directory for this exercise and <code>cd</code> into it . 
</li> <li> Copy the following code into a file called <code>matrix.m</code> <pre class="file">
A = randi(100,4,4)
b = randi(100,4,1);
x = A\b
save results.txt x -ascii
</pre>
</li></ol> 
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Compiling_Matlab"></a> Compiling Matlab </span></h2>
<p />
The first step in making Matlab portable is compiling our Matlab script.  To compile this code, we need to access the machines with the Matlab compiler installed.  For this exercise, we will use the compilers installed on special CHTC build machines.  In the CHTC pool, you can't use <code>ssh</code> to directly connect to these machines. Instead, you must submit an interactive job (like in <a href="/bin/view/Education/UserSchool15Wed13wrapper" class="twikiLink">Exercise 1.3</a>) that specifically requests these build machines.  
<p /> <ol>
<li>  Create a file called <code>compile.submit</code> with the lines below: <pre class="file">
universe = vanilla

output = compile.out
error = compile.err
log = compile.log

+IsBuildJob = true
requirements = (OpSysAndVer =?= "SL6") && ( IsBuildSlot == true )

should_transfer_files = YES
when_to_transfer_output = ON_EXIT

transfer_input_files = matrix.m

queue
</pre>
</li> <li> You can initiate the interactive job by using <code>condor_submit</code> 's <code>-i</code> option.  Enter the following command: <pre class="screen">
$> <strong>condor_submit -i compile.submit</strong>
</pre>
</li> <li> Once your interactive job has connected to the build server, you'll be able to access all of the Matlab tools installed there.  Look around in the <code>/usr/local/MATLAB</code> directory.  Can you find the Matlab compiler <code>mcc</code> for a specific version of Matlab?  
</li> <li> Since you are a guest user on our system, you will need to set your <code>HOME</code> directory by running this command: <pre class="screen">
$> <strong>HOME=$PWD</strong> 
</pre>
</li> <li> Compile your Matlab code with version 2014b.  <pre class="screen">
$> <strong>/usr/local/MATLAB/R2014b/bin/mcc -m -R -singleCompThread -R -nodisplay -R -nojvm matrix.m</strong> 
</pre>The extra arguments to the <code>mcc</code> command are very important here.  Matlab, by default, will run on as many CPUs as it can find.  This can be a big problem when running on someone else's computers, because your Matlab code might interfere with what the owner wants.  The <code>-singleCompThread</code> option compiles the code to run on a single CPU, avoiding this problem.  In addition, the <code>-nodisplay</code> and <code>-nojvm</code> options turn off the display (which won't exist where the code runs). 
</li> <li> To exit the interactive session, type <code>exit</code>
</li> <li> Now that you're back on the submit server, look at the files that were created by the Matlab compiler.  Which one is the compiled binary?  
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Matlab_Runtime"></a> Matlab Runtime </span></h2>
<p />
The newly compiled binary will require the 2014b Matlab runtime to run.  You can download the runtime from the Mathworks website and built it yourself, but 
to save time, for this exercise you can download the pre-built runtimes hosted by CHTC.  
<p /> <ol>
<li> Download the 2014b Matlab runtime hosted by CHTC: <pre class="screen">
$> <strong>wget http://proxy.chtc.wisc.edu/SQUID/r2014b.tar.gz </strong>
</pre>
</li></ol> 
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Wrapper_Script"></a> Wrapper Script </span></h2>
<p />
Like the GROMACS example from earlier this morning, we will need a wrapper script to install the Matlab runtime and then run our compiled Matlab code.  
Our wrapper script will need to accomplish the following steps:  <ul>
<li> Unpack the transferred runtime 
</li> <li> Set the environment variables
</li> <li> Run our compiled matlab code
</li></ul> 
<p />
Fortunately, the Matlab compiler has pre-written most of this wrapper script for us!  
<p /> <ol>
<li> Take a look at <code>run_matrix.sh</code>.  Which of the above steps do we need to add?  Once you have an idea, move to the next step.
</li> <li> We'll need to add commands to unpack the runtime (which will have been transferred with the job).  Add this line to the beginning of the <code>run_matrix.sh</code> file, after <code>#!/bin/bash</code> but before <code>exe_name=$0</code> : <pre class="file">
tar xzf r2014b.tar.gz
</pre>
</li> <li> Look at <code>readme.txt</code> to determine what arguments our wrapper script requires.  Once you have an idea, move to the next step.
</li> <li> The name of the Matlab runtime directory is a required argument to the wrapper script <code>run_matrix.sh</code>.  We'll have to do a little extra work to find out the name of that directory.   <ol>
<li> Untar the runtime tarball we downloaded to the submit server.  
</li> <li> What directory has been created?  This is the name of the runtime directory, and the argument you should pass to <code>run_matrix.sh</code>.  
</li></ol> 
</li></ol> 
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Submitting_the_Job"></a> Submitting the Job </span></h2>
<p /> <ol>
<li> Copy an existing submit file into your current directory.  The submit file we used for the <code>gromacs</code> example would be a good candidate, as that example also used a wrapper script.  
</li> <li> Modify your submit file for this job.  
</li> <li> Check your changes against the list below.   <ul>
<li> The <code>executable</code> for this job is going to be our wrapper script <code>run_matrix.sh</code>.
</li> <li> You need to transfer the compiled binary <code>matrix</code>, as well as the runtime <code>.tar.gz</code> file, using <code>transfer_input_files</code>.
</li> <li> The argument for the executable (<code>run_matrix.sh</code>) is "v84", as that is the name of the un-tarred runtime directory.  
</li></ul> 
</li> <li> Submit the job using <code>condor_submit</code>.  
</li> <li> After it completes, the job should have produced a file called <code>results.txt</code>
</li></ol> </div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Education<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Education/OSGUserSchool2015" class="twikiLink">OSGUserSchool2015</a> &gt; <a href="/bin/view/Education/UserSchool15Materials" class="twikiLink">UserSchool15Materials</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>UserSchool15Wed14matlab</span> <br />    
Topic revision: r9 - 29 Jul 2015 - 15:56:41 - <a href="/bin/view/Main/ChristinaKoch" class="twikiLink">ChristinaKoch</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />