<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
<link rel="stylesheet" href="https://twiki.opensciencegrid.org/twiki/pub/TWiki/HeadlinesPlugin/style.css" type="text/css" media="all" />
<title> UserSchool16Thurs23BlastStash &lt; Education &lt; TWiki    </title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link rel="icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="shortcut icon" href="/twiki/pub/Education/WebPreferences/favicon.ico    " type="image/x-icon" />
<link rel="alternate" href="https://twiki.opensciencegrid.org/bin/edit/Education/UserSchool16Thurs23BlastStash?_T=16 Feb 2017" type="application/x-wiki" title="edit UserSchool16Thurs23BlastStash" />
<meta name="SCRIPTURLPATH" content="/bin" />
<meta name="SCRIPTSUFFIX" content="" />
<meta name="TEXT_JUMP" content="Jump" />
<meta name="TEXT_SEARCH" content="Search" />
<meta name="TEXT_NUM_TOPICS" content="Number of topics:" />
<meta name="TEXT_MODIFY_SEARCH" content="Modify search" />
<meta name="robots" content="noindex" /><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/bin/view/Education/WebRss" />    
<base href="https://twiki.opensciencegrid.org/bin/view/Education/UserSchool16Thurs23BlastStash"></base>
<!--BEHAVIOURCONTRIB--><script type="text/javascript" src="/twiki/pub/TWiki/BehaviourContrib/behaviour.compressed.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikilib.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiWindow.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiEvent.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiHTML.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiCSS.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiForm.js"></script>
<script type="text/javascript" src="/twiki/pub/TWiki/PatternSkin/pattern.js"></script><style type="text/css" media="all">
@import url('/twiki/pub/TWiki/TWikiTemplates/base.css');
</style><script type="text/javascript" src="/twiki/pub/TWiki/TWikiJavascripts/twikiStyles.js"></script><style type="text/css" media="all">


</style>
<style type="text/css" media="all">
@import url("/twiki/pub/TWiki/TWikiNetSkin/layout.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/style.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/colors.css");
@import url("/twiki/pub/TWiki/TWikiNetSkin/rounded_corners.css");
</style>
<style type="text/css" media="all">
	/* Styles that are set using variables */
	#patternLeftBar .patternWebIndicator,
	.patternBookView .twikiTopRow {
		background-color:#D0D0D0;
	}
	.patternBookView {
		border-color:#D0D0D0;
	}
	.patternPreviewPage #patternMain {
		/* uncomment to set the preview image */
		/*background-image:url("/twiki/pub/TWiki/PreviewBackground/preview2bg.gif    ");*/
	}
	
</style><style type="text/css" media="all">

@import url('/pub/Documentation/Tools/exercises.css ');

</style>
<style type="text/css" media="all">
	@import url("/twiki/pub/TWiki/TWikiNetSkin/print.css");
</style><!--GOOGLEANALYTICSPLUGIN--><!-- Google Analytics script -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69012-21']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body class="patternViewPage patternPrintPage">
<a name="PageTop"></a>
<div id="patternScreen">
<div id="patternPageShadow">
<div id="patternPage">
<div id="patternOuter">
<div id="patternFloatWrap">
<div id="patternMain">
<div id="patternMainContents">
<div class="patternContent"><div class="patternTopic"> <h1><a name="Using_StashCache"></a> Using <span class="twikiNewLink">StashCache<a href="/bin/edit/Education/StashCache?topicparent=Education.UserSchool16Thurs23BlastStash" rel="nofollow" title="StashCache (this topic does not yet exist; you can create it)">?</a></span> </h1>
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="About_this_exercise"></a> About this exercise </span></h2>
This tutorial will use a <a href="http://blast.ncbi.nlm.nih.gov/Blast.cgi?CMD=Web&amp;PAGE_TYPE=BlastHome" target="_top">BLAST</a> workflow to demonstrate the functionality of StashCache for transferring input files to active job sites.
<p />
The input files for a BLAST job include:
<p /> <ul>
<li> one or more query files
</li> <li> genetic database file
</li> <li> database index files
</li></ul> 
<p />
In this exercise, the database is contained in a single 1.3 GB file, and the query is divided into 2 files of approximately 7.5 MB each (small enough to use the HTCondor file transfer mechanism). Each query must be compared to the database file using BLAST, so 2 jobs are needed in this workflow.  If BLAST jobs have an excessively long run time, the query files can be further subdivided into smaller segments.
<p />
Usually, the database files used with BLAST are quite large.  Due to its size (1.3 GB) and the fact that it is used for multiple jobs, the database file and corresponding index files will be transferred to the compute sites using StashCache, which takes advantage of proxy caching to improve transfer speed and efficiency.  Learn more about StashCache and basic usage instructions <a href="https://support.opensciencegrid.org/solution/articles/12000002775-introduction-to-stashcache" target="_top">here</a>.
<p />
There are two methods to using StashCache.  We are in the middle of a transition from one to another.  They are:
<p /> <ol>
<li> <strong>stashcp</strong>: A command line program to copy files from Stash with <code><b>cp</b></code> like syntax.
</li> <li> <strong>StashCache-over-CVMFS</strong>: A much more intuitive and fault tolerant method for accessing stash files.  But not yet available on all resources.
</li></ol> 
<p />
In the below tutorials, we will use <strong>stashcp</strong>, but also demonstrate how the <strong>StashCache-over-CVMFS</strong> works.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="Getting_Started"></a> Getting Started </span></h2>
<p />
1) First log into the OSG Connect submit host (login.osgconnect.net), download the tutorial files using the <strong>tutorial</strong> command, and cd into the newly created directory:
<p />
<pre class="screen">
$ tutorial stashcache-blast
$ cd tutorial-stashcache-blast
</pre>
<p />
<p />
2) The tutorial-stashcache-blast directory contains a number of files, described below:
<p /> <ul>
<li> HTCondor submit script: <strong>blast.submit</strong>
</li> <li> Job wrapper script: <strong>blast_wrapper.sh</strong>
</li> <li> Query files: <strong>query_0.fa  query_1.fa</strong>
</li></ul> 
<p />
In addition to these files, the following input files are needed for the jobs: <ul>
<li> database file: <strong>nt.fa</strong>
</li> <li> database index files: <strong>nt.fa.nhr  nt.fa.nin  nt.fa.nsq</strong>
</li></ul> 
<p />
These files are currently being stored in <code><b>/cvmfs/stash.osgstorage.org/user/eharstad/public/blast_database/</b></code>.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="The_Submit_File"></a> The Submit File </span></h2>
<p />
First, let's take a look at the HTCondor job submission script:
<p />
<pre class="file">
universe = vanilla

executable = blast_wrapper.sh
arguments  = blastn -db /cvmfs/stash.osgstorage.org/user/eharstad/public/blast_database/nt.fa -query $(queryfile)
should_transfer_files = YES
when_to_transfer_output = ON_EXIT
transfer_input_files = $(queryfile)

+WantsCvmfsStash = true
requirements = (GLIDEIN_ResourceName == "MWT2" || GLIDEIN_ResourceName == "Nebraska" || GLIDEIN_ResourceName ==  "Sandhills")
	
output = job.out.$(Cluster).$(Process)
error = job.err.$(Cluster).$(Process)
log = job.log.$(Cluster).$(Process)

# For each file matching query*.fa, submit a job
queue queryfile matching query*.fa
</pre>
<p />
The executable for this job is a wrapper script, `blast_wrapper.sh`, that takes as arguments the blast command that we want to run on the compute host.  We specify which query file we want transferred (using HTCondor) to each job site with the <strong>transfer_input_files</strong> command.
<p />
Note the one additional line that is required in the submit script of any job that uses StashCache:
<p />
<pre class="file">
+WantsCvmfsStash = true
</pre>
<p />
Finally, since there are multiple query files, we submit them with the command `queue queryfile matching query*.fa` command.  Because we have used the $(queryfile) macro in the name of the query input files, only one query file will be transferred to each job.
<p />
<h2 class="twikinetRoundedAttachments"><span class="twikinetHeader"><a name="The_Wrapper_Script"></a> The Wrapper Script </span></h2>
<p />
Now, let's take a look at the job wrapper script which is the job's executable:
<p />
<pre class="file">
#!/bin/bash
# Load the blast module
module load blast

"$@"
</pre>
<p />
The wrapper script loads the blast modules so that it can access the Blast software on the compute host.
<p />
You are now ready to submit the jobs:
<p />
<pre class="screen">
$ condor_submit blast.submit
</pre>
<p />
 Each job should run for approximately 3-5 minutes.  You can monitor the jobs with the condor_q command:
<p />
<pre class="screen">
$ condor_q <userid>
</pre></div><!-- /patternTopic-->
<p />
<p />
</div><!-- /patternContent-->
<hr />
This topic: Education<span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span><a href="/bin/view/Education/OSGUserSchool2016" class="twikiLink">OSGUserSchool2016</a> &gt; <a href="/bin/view/Education/UserSchool16Materials" class="twikiLink">UserSchool16Materials</a><span class='twikiSeparator'>&nbsp;&gt;&nbsp;</span>UserSchool16Thurs23BlastStash</span> <br />    
Topic revision: r1 - 06 Jul 2016 - 20:39:05 - <a href="/bin/view/Main/DerekWeitzel" class="twikiLink">DerekWeitzel</a>
</div><!-- /patternMainContents-->
</div><!-- /patternMain-->
</div><!-- /patternFloatWrap-->
<div class="clear">&nbsp;</div>
</div><!-- /patternOuter--><div id="patternBottomBar"><div id="patternBottomBarContents"><div id="twikinetBadge"><a href="http://www.twiki.net/"><img src="https://twiki.opensciencegrid.org/twiki/pub/TWiki/TWikiNetSkin/twiki-badge-88x31.gif" alt="TWIKI.NET" width="88" height="31" border="0" /></a></div><!--/twikinetBadge--><div id="patternWebBottomBar"><p>
<font size="-1">
TWiki |
<a href="https://ticket.grid.iu.edu/goc/twiki">Report Bugs</a> |
<a href="https://twiki.grid.iu.edu/bin/view/Operations/IUPrivacyPolicy">Privacy Policy</a>
</p>
<p>
<font size="-2">
<span class="twikiRight"> <a href="http://twiki.org/"><img src="/twiki/pub/TWiki/TWikiLogos/T-logo-80x15.gif" alt="This site is powered by the TWiki collaboration platform" width="80" height="15" title="This site is powered by the TWiki collaboration platform" border="0" /></a></span>Copyright by the contributing authors. All material on this collaboration platform is the property of the contributing authors..
</font>
</p></div><!--/patternWebBottomBar--></div><!-- /patternBottomBarContents--></div><!-- /patternBottomBar-->
</div><!-- /patternPage-->
</div><!-- /patternPageShadow-->
</div><!-- /patternScreen-->
</body></html>
<p />