---+ Tue Afternoon Exercise - Using OSG Security Tools

---++ Introduction
In this session you will learn how to use the OSG security tools.

---++ Your certificate

On &lt;pre&gt;
osg-ss-glidein.chtc.wisc.edu
&lt;/pre&gt;
you should have you certificate in:&lt;pre&gt;
~/.globus/
&lt;/pre&gt;

The certificate can be in one of the two formats:
   * =usercert.p12= - This is the format Web browsers usually rely on. It contains both the public and the private part of your certificate.
   * =usercert.pem= + =userkey.pem= - This is the preferred format for the Grid environment.&lt;br&gt;The first file contains only the public part, while the second one contains only the private key.

*Note:* Make sure any file containing the private key is only readable by you.

You can convert between them by using:
   * p12 to pem &lt;pre class=&quot;screen&quot;&gt;
cd ~/.globus
touch usercert.pem userkey.pem
chmod go-rwx userkey.pem
chmod go-wx usercert.pem
# Will ask for the passwd
openssl pkcs12 -clcerts -nokeys -in usercert.p12 -out usercert.pem
# Will ask for the passwd, and will ask for a 2nd passwd for the key file... use the same
openssl pkcs12 -nocerts -in usercert.p12 -out userkey.pem
&lt;/pre&gt;
   * pem to p12 &lt;pre class=&quot;screen&quot;&gt;
cd ~/.globus
touch usercert.p12
chmod go-rwx usercert.p12
openssl pkcs12 -export -in usercert.pem -inkey userkey.pem -out usercert.p12
&lt;/pre&gt;

---++ Looking into the certificate

You can peek at the content of the certificate, using [[http://www.openssl.org/docs/apps/x509.html][openssl]]. 
It is installed on most Linux systems by default.

Try it out.&lt;pre class=&quot;screen&quot;&gt;
openssl x509 -text -in ~/.globus/usercert.pem -noout
&lt;/pre&gt;
What do you see?

PS: We used the =-text= flag to get the complete output, but there are many useful ones as well.
I particularly like =-subject=; it prints out just your name, as encoded in the certificate.

Note: I have also used the =-noout= flag; this tells openssl to stick to the human readable output.

%TWISTY{
showlink=&quot;Advanced&quot;
hidelink=&quot;Hide advanced&quot;
start=&quot;hide&quot;
mode=&quot;div&quot;
showimgleft=&quot;%ICONURLPATH{toggleopen-small}%&quot;
hideimgleft=&quot;%ICONURLPATH{toggleclose-small}%&quot;
}%
One of the things you can see, is that the cert was issued by DOEGrids CA.

The CA public certificates are pre-installed in =/etc/grid-security/certificates/=.&lt;br&gt;
Each CA has a set of files, with *.0 being the certificate.

The files are encoded using a SSL-internal scheme. You can find the right name under the your certificate &quot;CRL Distribution&quot; section.

Run openssl against the DOEGrids certificate.

%TWISTY{
showlink=&quot;For the lazy&quot;
hidelink=&quot;Hide lazy section&quot;
start=&quot;hide&quot;
mode=&quot;div&quot;
showimgleft=&quot;%ICONURLPATH{toggleopen-small}%&quot;
hideimgleft=&quot;%ICONURLPATH{toggleclose-small}%&quot;
}%
&lt;pre class=&quot;screen&quot;&gt;
openssl x509 -text -in /etc/grid-security/certificates/1c3f2ca8.0  -noout
&lt;/pre&gt;
%ENDTWISTY% 
&lt;br&gt;

What do you see?
%ENDTWISTY% 
&lt;br&gt;

---++ Creating a proxy

As mentioned in the lecture, you will often need a proxy.

To create a proxy, use =grid-proxy-init=&lt;pre class=&quot;screen&quot;&gt;
cd ~/.globus
# either one will work
grid-proxy-init -cert ~/.globus/usercert.p12 -key ~/.globus/usercert.p12 -out ~/.globus/userproxy.pem -valid 12:0
grid-proxy-init -cert ~/.globus/usercert.pem -key ~/.globus/userkey.pem -out ~/.globus/userproxy.pem -valid 12:0
&lt;/pre&gt;

Now look into it with openssl.
%TWISTY{
showlink=&quot;For the lazy&quot;
hidelink=&quot;Hide lazy section&quot;
start=&quot;hide&quot;
mode=&quot;div&quot;
showimgleft=&quot;%ICONURLPATH{toggleopen-small}%&quot;
hideimgleft=&quot;%ICONURLPATH{toggleclose-small}%&quot;
}%
&lt;pre class=&quot;screen&quot;&gt;
openssl x509 -text -in ~/.globus/userproxy.pem  -noout
&lt;/pre&gt;
%ENDTWISTY% 
&lt;br&gt;
What do you see?

Another tool you can use to look at a proxy is =grid-proxy-info=&lt;pre class=&quot;screen&quot;&gt;
grid-proxy-info -file ~/.globus/userproxy.pem
&lt;/pre&gt;
Try it out.

%TWISTY{
showlink=&quot;Advanced&quot;
hidelink=&quot;Hide advanced&quot;
start=&quot;hide&quot;
mode=&quot;div&quot;
showimgleft=&quot;%ICONURLPATH{toggleopen-small}%&quot;
hideimgleft=&quot;%ICONURLPATH{toggleclose-small}%&quot;
}%

One obvious thing to change is the proxy lifetime. Try the changing the =-valid= option.

You can also change the location of the proxy. We have been using the explicit =-out= option in =grid-proxy-init= and the =-file= opetion in =grid-proxy-info=.
You can set the =X509_USER_PROXY= variable instead.&lt;br&gt;
Try deleting your proxy (*not the certificate*) and recreating it with a different name.
%ENDTWISTY% 
&lt;br&gt;

---++ Creating a VOMS-extended proxy

As explained during the lecture, OSG requires VOMS attributes to authorize you at Grid sites.

Creating a VOMS-extended proxy is very similar to creating a regular proxy; you just must use a different tool.

The tool to use is =voms-proxy-init=. You will also need to tell the tool what VO are you from (i.e. =osgedu=)&lt;pre class=&quot;screen&quot;&gt;
cd ~/.globus
# either one will work
voms-proxy-init -cert ~/.globus/usercert.p12 -key ~/.globus/usercert.p12 -voms osgedu -out ~/.globus/userproxy.pem -valid 12:0 -hours 12
voms-proxy-init -cert ~/.globus/usercert.pem -key ~/.globus/userkey.pem -voms osgedu -out ~/.globus/userproxy.pem -valid 12:0 -hours 12
&lt;/pre&gt;

Try it out and look at the result with openssl.

What do you see?

Now try it with the VOMS-specific tool; =voms-proxy-info=&lt;pre class=&quot;screen&quot;&gt;
voms-proxy-info -file ~/.globus/userproxy.pem -file
&lt;/pre&gt;

%TWISTY{
showlink=&quot;Advanced&quot;
hidelink=&quot;Hide advanced&quot;
start=&quot;hide&quot;
mode=&quot;div&quot;
showimgleft=&quot;%ICONURLPATH{toggleopen-small}%&quot;
hideimgleft=&quot;%ICONURLPATH{toggleclose-small}%&quot;
}%
You may have noticed I have added also the =-hours= option; this sets the validity of the VOMS attributes. The attributes lifetime and the proxy lifetime are indeed completely independent.

Try also the =-chain= option.&lt;br&gt;
What do you see?
%ENDTWISTY% 
&lt;br&gt;

---++ Submitting a Grid job

While you will likely never need to submit Grid jobs yourselves, it is still a good idea to know how to do it.

The 5 OSG sites you have access to are:
   * the local pool (Wisconsin) - =osg-ss-ce.chtc.wisc.edu:2119/jobmanager-condor=
   * UNL - =red.unl.edu:2119/jobmanager-condor=
   * UCSD - =osg-gw-2.t2.ucsd.edu:2119/jobmanager-condor=
   * Chicago - =uct2-gk.mwt2.org:2119/jobmanager-condor=
   * Oklahoma - =osgitb1.nhn.ou.edu:2119/jobmanager-condor=

Let&#39;s run as simple job:&lt;pre class=&quot;screen&quot;&gt;
export X509_USER_PROXY=~/.globus/userproxy.pem
globus-job-run osg-gw-2.t2.ucsd.edu:2119/jobmanager-condor /usr/bin/id
&lt;/pre&gt;

Try another site, too.

*Note:* =globus-job-run= is a very primitive tool, and you should use it for testing only. It will not scale past a few jobs.

-- Main.IgorSfiligoi - 25 Jun 2012
